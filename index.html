<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>KÖRPÜ — Chat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .splash{position:fixed;inset:0;z-index:999;background:#0a0a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .8s,visibility .8s;overflow:hidden}.splash.hidden{opacity:0;visibility:hidden;pointer-events:none}.splash::before{content:'';position:absolute;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(0,229,160,.15) 0%,transparent 70%);animation:sp-glow 3s ease-in-out infinite;filter:blur(40px)}.splash::after{content:'';position:absolute;width:200px;height:200px;border:1px solid rgba(0,229,160,.1);border-radius:50%;animation:sp-ring 3s ease-in-out infinite}@keyframes sp-glow{0%,100%{transform:scale(1);opacity:.6}50%{transform:scale(1.3);opacity:1}}@keyframes sp-ring{0%{transform:scale(.8);opacity:0}50%{transform:scale(1.2);opacity:.5}100%{transform:scale(1.6);opacity:0}}.splash img{width:120px;height:120px;object-fit:contain;animation:sp-logo 2s ease-in-out infinite;filter:drop-shadow(0 0 40px rgba(0,229,160,.4));position:relative;z-index:1}@keyframes sp-logo{0%,100%{transform:scale(1) translateY(0)}50%{transform:scale(1.04) translateY(-4px)}}.splash-text{margin-top:20px;font-family:'Space Mono',monospace;font-size:.6rem;letter-spacing:4px;text-transform:uppercase;color:rgba(0,229,160,.4);position:relative;z-index:1}.splash-bar{width:120px;height:2px;background:rgba(255,255,255,.06);border-radius:2px;margin-top:12px;overflow:hidden;position:relative;z-index:1}.splash-bar-fill{width:0;height:100%;background:linear-gradient(90deg,var(--a),#a78bfa);border-radius:2px;animation:sp-bar 1.6s ease forwards}@keyframes sp-bar{to{width:100%}}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0f;--glass:rgba(255,255,255,.06);--gb:rgba(255,255,255,.08);--a:#00e5a0;--ag:rgba(0,229,160,.3);--ad:rgba(0,229,160,.1);--danger:#ff4d6a;--t:#e8e8ec;--td:rgba(255,255,255,.4);--tm:rgba(255,255,255,.65);--sb:linear-gradient(135deg,rgba(0,229,160,.2),rgba(0,229,160,.08));--sbb:rgba(0,229,160,.15);--rb:rgba(255,255,255,.06);--rbb:rgba(255,255,255,.06);--cb:rgba(255,255,255,.06);--safe-top:env(safe-area-inset-top,0px)}
    html.light{--bg:#f0f2f5;--glass:rgba(0,0,0,.04);--gb:rgba(0,0,0,.08);--a:#00b386;--ag:rgba(0,179,134,.2);--ad:rgba(0,179,134,.08);--t:#1a1a2e;--td:rgba(0,0,0,.4);--tm:rgba(0,0,0,.55);--sb:linear-gradient(135deg,rgba(0,179,134,.15),rgba(0,179,134,.06));--sbb:rgba(0,179,134,.2);--rb:rgba(0,0,0,.04);--rbb:rgba(0,0,0,.06);--cb:rgba(255,255,255,.7)}
    html{font-size:16px}body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;overflow:hidden;transition:background .3s,color .3s}
    body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 50%,rgba(0,229,160,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(100,60,255,.06) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(244,114,182,.04) 0%,transparent 50%);animation:bga 25s ease-in-out infinite alternate;z-index:0}body::after{content:'';position:fixed;top:10%;right:-10%;width:40vw;height:40vw;border-radius:50%;background:radial-gradient(circle,rgba(0,229,160,.04),transparent 70%);animation:orb2 18s ease-in-out infinite alternate;z-index:0;filter:blur(60px)}@keyframes bga{0%{transform:translate(0,0) rotate(0deg)}100%{transform:translate(-5%,3%) rotate(2deg)}}@keyframes orb2{0%{transform:translate(0,0) scale(1)}100%{transform:translate(-30%,20%) scale(1.2)}}
    body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:60px 60px;z-index:0}
    .app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;max-width:520px;margin:0 auto;padding:10px 10px 0 10px;padding-top:calc(10px + var(--safe-top))}@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.auth{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;animation:fu .5s ease}.auth-logo{width:80px;height:80px;object-fit:contain;margin-bottom:8px;filter:drop-shadow(0 0 20px var(--ag))}.auth-title{font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700;color:var(--a);letter-spacing:3px;margin-bottom:2px}.auth-sub{font-size:.75rem;color:var(--td);margin-bottom:16px}.auth-card{width:100%;max-width:360px;background:rgba(15,15,25,.7);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:22px;backdrop-filter:blur(30px);box-shadow:0 8px 40px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.05)}.tabs{display:flex;margin-bottom:16px;background:var(--glass);border-radius:10px;padding:3px}.tab{flex:1;padding:9px;text-align:center;font-size:.78rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all .25s;color:var(--tm)}.tab.on{background:var(--a);color:#0a0a0f;box-shadow:0 2px 10px var(--ag)}.field{margin-bottom:10px}.field label{display:block;font-size:.58rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--td);margin-bottom:4px;font-family:'Space Mono',monospace}.field input{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.84rem;outline:none;transition:all .3s}html.light .field input{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}.field input:focus{border-color:rgba(0,229,160,.4);box-shadow:0 0 0 3px rgba(0,229,160,.08)}.field input::placeholder{color:var(--td)}.abtn{width:100%;padding:12px;border:none;border-radius:12px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s;margin-top:4px}.abtn:active{transform:scale(.97)}.abtn-p{background:var(--a);color:#0a0a0f;box-shadow:0 4px 20px var(--ag)}.abtn-g{background:rgba(255,255,255,.04);color:var(--tm);border:1px solid rgba(255,255,255,.06)}.divider{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--td);font-size:.68rem}.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--gb)}.auth-err{color:var(--danger);font-size:.74rem;text-align:center;margin-top:6px;min-height:16px}.anon-box{background:rgba(255,255,255,.03);border:1px solid var(--gb);border-radius:12px;padding:14px;text-align:center}.anon-title{font-size:.9rem;font-weight:700;color:var(--tm);margin-bottom:10px}.saved-info{font-size:.66rem;color:var(--td);text-align:center;margin-top:8px}.saved-info a{color:var(--a);cursor:pointer;text-decoration:underline}.avatar-pick{display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin:8px 0}.av-opt{width:36px;height:36px;font-size:1.25rem;display:flex;align-items:center;justify-content:center;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .25s;background:rgba(255,255,255,.03)}.av-opt:hover{background:rgba(255,255,255,.06)}.av-opt.sel{border-color:var(--a);box-shadow:0 0 12px var(--ag);transform:scale(1.12);background:var(--ad)}.chat{display:none;flex-direction:column;flex:1;min-height:0}.chat.on{display:flex}.hdr{display:flex;align-items:center;justify-content:space-between;padding:5px 0;margin-bottom:3px}.logo{font-family:'Space Mono',monospace;font-size:1.15rem;font-weight:700;letter-spacing:3px;color:var(--a);text-shadow:0 0 20px var(--ag)}.hdr-r{display:flex;align-items:center;gap:6px}.badge{font-size:.7rem;padding:5px 10px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--gb);color:var(--td);font-family:'Space Mono',monospace;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.badge.on{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.ib{width:38px;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:var(--tm);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:.88rem}.ib:hover{background:rgba(255,255,255,.08)}.ib:active{transform:scale(.92)}.ib.act{background:var(--ad);border-color:rgba(0,229,160,.25);color:var(--a)}.update-btn{display:none}
    .menu-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80;backdrop-filter:blur(2px)}
    .menu-overlay.show{display:block}
    .side-menu{position:fixed;top:0;right:-290px;width:280px;height:100%;background:rgba(8,8,16,.95);border-left:1px solid rgba(255,255,255,.05);z-index:90;display:flex;flex-direction:column;transition:right .4s cubic-bezier(.25,.8,.25,1);overflow-y:auto;padding:0;padding-top:env(safe-area-inset-top,0px);backdrop-filter:blur(40px);box-shadow:-12px 0 50px rgba(0,0,0,.5)}
    .side-menu.show{right:0}
    .menu-header{display:flex;align-items:center;gap:12px;padding:22px 18px 14px;background:linear-gradient(180deg,rgba(0,229,160,.08) 0%,rgba(100,60,255,.03) 60%,transparent 100%);border-bottom:1px solid rgba(255,255,255,.05);position:relative}
    .menu-header::after{content:'';position:absolute;bottom:-1px;left:18px;right:18px;height:1px;background:linear-gradient(90deg,transparent,var(--a),transparent);opacity:.2}
    .menu-name{font-weight:700;font-size:.95rem;letter-spacing:.02em}.menu-login{font-size:.62rem;color:var(--td);font-family:'Space Mono',monospace;margin-top:1px}
    .menu-xp{padding:10px 18px 8px;border-bottom:1px solid rgba(255,255,255,.04)}
    .menu-coins{display:flex;align-items:center;gap:4px;font-size:.72rem;font-family:'Space Mono',monospace;color:#fbbf24;padding:0 18px 8px}
    .menu-section{font-size:.55rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--td);font-family:'Space Mono',monospace;padding:12px 18px 4px;opacity:.6}
    .menu-items{flex:1;padding:4px 0}
    .menu-item{padding:11px 16px;font-size:.84rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;border-radius:10px;margin:2px 10px;letter-spacing:.01em;position:relative}
    .menu-item:hover{background:rgba(255,255,255,.05)}
    .menu-item:active{background:var(--ad);transform:scale(.98)}
    .menu-item .mi-icon{width:20px;text-align:center;font-size:.95rem}
    .menu-item .mi-badge{margin-left:auto;font-size:.55rem;padding:2px 6px;border-radius:6px;background:rgba(0,229,160,.12);color:var(--a);font-family:'Space Mono',monospace}
    .menu-item.danger{color:var(--danger)}
    .menu-item.danger:hover{background:rgba(255,77,106,.08)}
    .menu-divider{height:1px;background:rgba(255,255,255,.04);margin:4px 18px}
    .menu-bottom{padding:6px 0;border-top:1px solid rgba(255,255,255,.04)}
    .game-card{display:flex;align-items:center;gap:14px;padding:14px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:14px;margin-bottom:8px;cursor:pointer;transition:all .25s}
    .game-card:hover{background:var(--ad);border-color:rgba(0,229,160,.25);transform:translateX(3px)}
    .game-card .g-icon{font-size:1.6rem;width:36px;text-align:center;flex-shrink:0}
    .game-card .g-info{flex:1}.game-card .g-name{font-weight:600;font-size:.85rem}.game-card .g-desc{font-size:.65rem;color:var(--td);margin-top:1px}
    .game-pick-title{font-size:.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);font-family:'Space Mono',monospace;margin:8px 0 6px}
    .game-friend-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s;font-size:.88rem}
    .game-friend-row:hover{background:rgba(255,255,255,.06);transform:translateX(2px)}
    .game-friend-row .av{font-size:1.3rem}.game-friend-row .nm{flex:1;font-weight:500}
    .conn-row{display:flex;gap:5px;margin-bottom:4px}.conn-row input{flex:1;padding:8px 12px;background:var(--glass);border:1px solid var(--gb);border-radius:10px;color:var(--t);font-size:.82rem;outline:none;font-family:'Outfit',sans-serif}.conn-row input:focus{border-color:rgba(0,229,160,.4)}.conn-row input::placeholder{color:var(--td)}
    .conn-btn{width:38px;height:38px;border-radius:12px;border:1px solid rgba(0,229,160,.15);background:rgba(0,229,160,.08);color:var(--a);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .25s;font-weight:700}.conn-btn:hover{background:rgba(0,229,160,.15);box-shadow:0 2px 10px var(--ag)}.conn-btn:active{transform:scale(.92)}
    .ach-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);padding:10px 18px;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(0,229,160,.15));border:1px solid rgba(167,139,250,.3);border-radius:14px;z-index:200;text-align:center;transition:transform .4s ease;pointer-events:none;backdrop-filter:blur(10px)}
    .ach-toast.show{transform:translateX(-50%) translateY(0)}
    .ach-toast .ach-icon{font-size:1.6rem;display:block}.ach-toast .ach-name{font-size:.82rem;font-weight:600;color:var(--t);margin-top:2px}.ach-toast .ach-lbl{font-size:.6rem;color:var(--purple);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px}
    .ach-grid{display:flex;flex-wrap:wrap;gap:4px;padding:0 16px 14px}
    .ach-item{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;position:relative;cursor:default}
    .ach-item.earned{background:linear-gradient(135deg,rgba(167,139,250,.15),rgba(0,229,160,.1));border:1px solid rgba(167,139,250,.25)}
    .ach-item.locked{background:var(--glass);border:1px solid var(--gb);opacity:.35;filter:grayscale(1)}
    .ach-item .ach-tip{display:none;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--gb);border-radius:8px;padding:5px 8px;white-space:nowrap;font-size:.6rem;color:var(--tm);z-index:10}
    .ach-item:hover .ach-tip{display:block}
    .lang-sw{display:flex;gap:3px;padding:8px 18px;border-bottom:1px solid var(--gb)}
    .lang-btn{padding:5px 12px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.75rem;cursor:pointer;font-family:'Space Mono',monospace;font-weight:600;transition:all .2s}
    .lang-btn.on{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}
    .ck-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:16px;max-width:380px;width:94%;animation:fu .3s ease;text-align:center}
    .ck-title{font-family:'Space Mono',monospace;font-size:.8rem;color:var(--a);margin-bottom:8px;letter-spacing:1px}
    .ck-status{font-size:.75rem;color:var(--tm);margin-bottom:10px}
    .ck-board{display:grid;grid-template-columns:repeat(8,1fr);gap:0;width:100%;max-width:320px;margin:0 auto 10px;aspect-ratio:1;border-radius:10px;overflow:hidden;border:2px solid var(--gb)}
    .ck-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:background .15s}
    .ck-cell.light{background:#b58863}.ck-cell.dark{background:#6d4c3d}
    .ck-cell.sel{box-shadow:inset 0 0 0 3px var(--a)}
    .ck-cell.hint::after{content:'';position:absolute;width:30%;height:30%;border-radius:50%;background:rgba(0,229,160,.5)}
    .ck-cell.cap-hint::after{content:'';position:absolute;width:60%;height:60%;border-radius:50%;background:rgba(255,77,106,.4)}
    .ck-cell.last-from{box-shadow:inset 0 0 0 2px rgba(167,139,250,.5)}.ck-cell.last-to{box-shadow:inset 0 0 0 2px rgba(167,139,250,.7)}
    .ck-piece{width:70%;height:70%;border-radius:50%;position:relative;pointer-events:none;transition:transform .15s}
    .ck-piece.black{background:radial-gradient(circle at 35% 35%,#555,#1a1a1a);border:2px solid #333;box-shadow:0 2px 6px rgba(0,0,0,.6)}
    .ck-piece.white{background:radial-gradient(circle at 35% 35%,#fff,#ccc);border:2px solid #aaa;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .ck-piece.king::after{content:'♛';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.7em}
    .ck-piece.black.king::after{color:#fbbf24}.ck-piece.white.king::after{color:#7c3aed}
    .ck-actions{display:flex;gap:6px;justify-content:center;margin-top:6px}
    .ck-actions button{padding:7px 14px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.78rem;cursor:pointer;font-family:'Outfit',sans-serif}
    .ck-actions button:hover{background:var(--ad);color:var(--a)}
    .ck-actions button.danger:hover{background:rgba(255,77,106,.15);color:var(--danger)}
    .ck-score{display:flex;justify-content:center;gap:16px;margin-bottom:8px;font-size:.78rem;font-family:'Space Mono',monospace}
    .ck-score .you{color:var(--a);font-weight:700}.ck-score .opp{color:var(--tm)}
    .dk-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:14px;max-width:400px;width:96%;animation:fu .3s ease}
    .dk-title{font-family:'Space Mono',monospace;font-size:.78rem;color:var(--a);text-align:center;margin-bottom:6px;letter-spacing:1px}
    .dk-info{display:flex;justify-content:space-between;align-items:center;font-size:.7rem;color:var(--tm);margin-bottom:8px;padding:0 4px}
    .dk-trump{padding:3px 8px;border-radius:8px;font-weight:700;font-size:.85rem}
    .dk-trump.red{color:#ff6b6b;background:rgba(255,107,107,.1)}.dk-trump.black{color:var(--tm);background:var(--glass)}
    .dk-opp{text-align:center;margin-bottom:6px}.dk-opp-cards{display:flex;justify-content:center;gap:2px}
    .dk-opp-card{width:28px;height:38px;background:linear-gradient(135deg,#2a3a5c,#1a2a4c);border:1px solid rgba(255,255,255,.15);border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:.5rem;color:rgba(255,255,255,.3)}
    .dk-table{min-height:80px;display:flex;flex-wrap:wrap;gap:4px;justify-content:center;padding:10px;background:rgba(34,85,34,.15);border:1px solid rgba(34,85,34,.3);border-radius:12px;margin-bottom:8px}
    .dk-pair{display:flex;flex-direction:column;align-items:center;gap:-10px;position:relative}
    .dk-card{width:44px;height:62px;border-radius:7px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;border:2px solid transparent;user-select:none;line-height:1.1;box-shadow:0 1px 4px rgba(0,0,0,.3)}
    .dk-card.white{background:linear-gradient(135deg,#fff,#f0f0f0);color:#333}
    .dk-card.white.red{color:#d42020}
    .dk-card.back{background:linear-gradient(135deg,#2a3a5c,#1a2a4c);border-color:rgba(255,255,255,.1)}
    .dk-card.sel{border-color:var(--a);transform:translateY(-6px);box-shadow:0 4px 12px var(--ag)}
    .dk-card.playable{border-color:rgba(0,229,160,.3)}
    .dk-card.def-card{position:relative;margin-top:-30px;transform:rotate(8deg)}
    .dk-hand{display:flex;flex-wrap:wrap;gap:3px;justify-content:center;padding:4px 0}
    .dk-status{text-align:center;font-size:.78rem;font-weight:600;margin-bottom:6px}
    .dk-actions{display:flex;gap:6px;justify-content:center;margin-top:6px}
    .dk-actions button{padding:8px 16px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.78rem;cursor:pointer;font-family:'Outfit',sans-serif;font-weight:600;transition:all .2s}
    .dk-actions button:hover{background:var(--ad);color:var(--a)}
    .dk-actions button.green{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}
    .dk-actions button.red{border-color:rgba(255,77,106,.2)}.dk-actions button.red:hover{background:rgba(255,77,106,.15);color:var(--danger)}
    .ttt-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:16px;max-width:320px;width:90%;animation:fu .3s ease;text-align:center}
    .ttt-title{font-family:'Space Mono',monospace;font-size:.8rem;color:var(--a);margin-bottom:6px;letter-spacing:1px}
    .ttt-status{font-size:.78rem;color:var(--tm);margin-bottom:10px}
    .ttt-board{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;max-width:220px;margin:0 auto 10px}
    .ttt-cell{aspect-ratio:1;border-radius:10px;background:var(--glass);border:1px solid var(--gb);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;cursor:pointer;transition:all .15s}
    .ttt-cell:hover{background:rgba(255,255,255,.08)}.ttt-cell.x{color:var(--a)}.ttt-cell.o{color:var(--purple)}
    .ttt-cell.win{background:rgba(0,229,160,.15);border-color:rgba(0,229,160,.4)}
    .shop-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:16px;max-width:380px;width:94%;max-height:80vh;overflow-y:auto;animation:fu .3s ease}
    .shop-title{font-family:'Space Mono',monospace;font-size:.85rem;color:var(--a);text-align:center;margin-bottom:4px;letter-spacing:1px}
    .shop-coins{text-align:center;font-size:.9rem;font-family:'Space Mono',monospace;color:#fbbf24;margin-bottom:10px}
    .shop-section{font-size:.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);font-family:'Space Mono',monospace;margin:10px 0 6px;padding-left:4px}
    .shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .shop-item{padding:10px;border-radius:10px;background:var(--glass);border:1px solid var(--gb);text-align:center;cursor:pointer;transition:all .2s}
    .shop-item:hover{border-color:rgba(0,229,160,.3);background:var(--ad)}
    .shop-item .si-icon{font-size:1.6rem;display:block;margin-bottom:2px}.shop-item .si-name{font-size:.75rem;font-weight:600}.shop-item .si-price{font-size:.7rem;color:#fbbf24;font-family:'Space Mono',monospace;margin-top:2px}
    .theme-colors{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:8px 18px;border-bottom:1px solid var(--gb)}
    .theme-dot{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .theme-dot:hover{transform:scale(1.15)}.theme-dot.sel{border-color:#fff;transform:scale(1.15)}
    .lb-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:16px;max-width:400px;width:96%;max-height:82vh;overflow-y:auto;animation:fu .3s ease}
    .lb-title{font-family:'Space Mono',monospace;font-size:.85rem;color:var(--a);text-align:center;margin-bottom:8px;letter-spacing:1px}
    .lb-tabs{display:flex;gap:3px;margin-bottom:8px;overflow-x:auto;scrollbar-width:none}
    .lb-tabs::-webkit-scrollbar{display:none}
    .lb-tab{padding:6px 12px;border-radius:8px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);white-space:nowrap;transition:all .2s}
    .lb-tab.active{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}
    .lb-row{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:3px;transition:background .15s;font-size:.82rem}
    .lb-row:hover{background:rgba(255,255,255,.04)}
    .lb-row.me{background:var(--ad);border:1px solid rgba(0,229,160,.2)}
    .lb-rank{width:24px;text-align:center;font-weight:700;font-family:'Space Mono',monospace;font-size:.85rem}
    .lb-rank.gold{color:#fbbf24}.lb-rank.silver{color:#94a3b8}.lb-rank.bronze{color:#cd7f32}
    .lb-av{font-size:1.2rem;width:26px;text-align:center}
    .lb-name{flex:1;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .lb-val{font-family:'Space Mono',monospace;font-size:.78rem;color:var(--a);font-weight:700}
    .ch-row{display:flex;align-items:center;gap:8px;padding:7px;border-radius:9px;cursor:pointer;transition:background .2s;font-size:.85rem}
    .ch-row:hover{background:rgba(255,255,255,.06)}
    .ch-row .ch-av{font-size:1.15rem;width:24px;text-align:center}
    .ch-row .ch-nm{flex:1;font-weight:500}.ch-row .ch-cnt{font-size:.6rem;color:var(--td);font-family:'Space Mono',monospace}
    .ch-row .ch-owner{font-size:.55rem;padding:1px 5px;border-radius:4px;background:rgba(0,229,160,.1);color:var(--a)}
    .ch-create{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
    .ch-create input{flex:1;min-width:100px;padding:5px 8px;font-size:.72rem;background:rgba(255,255,255,.04);border:1px solid var(--gb);border-radius:7px;color:var(--t);outline:none;font-family:'Outfit',sans-serif}
    .ch-badge{font-size:.5rem;padding:1px 4px;border-radius:4px;background:rgba(167,139,250,.15);color:#a78bfa}
    .wheel-modal{background:rgba(8,8,16,.95);border:1px solid rgba(255,255,255,.06);border-radius:22px;padding:20px;max-width:340px;width:92%;animation:fu .35s ease;backdrop-filter:blur(30px);text-align:center}
    .wheel-title{font-family:'Space Mono',monospace;font-size:.9rem;color:var(--a);margin-bottom:12px;letter-spacing:1px}
    .wheel-container{position:relative;width:240px;height:240px;margin:0 auto 14px}
    .wheel-canvas{width:240px;height:240px;border-radius:50%;border:3px solid rgba(255,255,255,.08);box-shadow:0 0 30px rgba(0,229,160,.15),inset 0 0 20px rgba(0,0,0,.3);transition:transform 4s cubic-bezier(.17,.67,.12,.99)}
    .wheel-pointer{position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-size:1.8rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));z-index:2}
    .wheel-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:44px;height:44px;border-radius:50%;background:rgba(8,8,16,.9);border:2px solid var(--a);display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 0 15px var(--ag);z-index:2;cursor:pointer;transition:all .2s}
    .wheel-center:hover{transform:translate(-50%,-50%) scale(1.08)}
    .wheel-center:active{transform:translate(-50%,-50%) scale(.95)}
    .wheel-result{font-size:1.1rem;font-weight:700;color:var(--a);margin:8px 0;min-height:30px}
    .wheel-info{font-size:.68rem;color:var(--td);font-family:'Space Mono',monospace;margin-top:6px}
    .myid-bar{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(15,15,25,.5);border:1px solid rgba(255,255,255,.06);border-radius:14px;margin-bottom:6px;font-size:.85rem;flex-wrap:wrap;backdrop-filter:blur(15px)}.myid-bar .av-icon{font-size:1.3rem}.myid-name{font-weight:600}.myid-login{color:var(--td);font-family:'Space Mono',monospace;font-size:.7rem}.myid-status{font-size:.7rem;color:var(--a)}.copy-btn{margin-left:auto;padding:4px 10px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.72rem;cursor:pointer;font-family:'Space Mono',monospace}.copy-btn:hover,.copy-btn.ok{background:var(--ad);color:var(--a)}.xp-bar{width:100%;height:5px;background:rgba(255,255,255,.04);border-radius:4px;margin-top:4px;overflow:hidden}.xp-fill{height:100%;background:linear-gradient(90deg,var(--a),#a78bfa,var(--a));background-size:200% 100%;border-radius:4px;transition:width .8s cubic-bezier(.4,0,.2,1);box-shadow:0 0 8px var(--ag)}.xp-text{font-size:.62rem;color:var(--td);font-family:'Space Mono',monospace;display:flex;justify-content:space-between;margin-top:2px}.lvl-badge{font-size:.6rem;padding:3px 8px;border-radius:6px;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(0,229,160,.12));color:#a78bfa;font-family:'Space Mono',monospace;font-weight:700;border:1px solid rgba(167,139,250,.15)}.panel{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:70;padding:12px;animation:panel-in .3s cubic-bezier(.4,0,.2,1);align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px)}.panel.show{display:flex}@keyframes panel-in{from{opacity:0}to{opacity:1}}.panel-card{width:100%;max-width:400px;max-height:85vh;background:rgba(15,15,25,.92);border:1px solid rgba(255,255,255,.08);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 16px 50px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.05);animation:panel-card-in .35s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(30px)}@keyframes panel-card-in{from{opacity:0;transform:translateY(30px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}.panel-header{display:flex;align-items:center;gap:10px;padding:16px 18px;background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}.panel-back{width:34px;height:34px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--tm);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.95rem;transition:all .2s;flex-shrink:0}.panel-back:hover{background:var(--ad);color:var(--a)}.panel-back:active{transform:scale(.9)}.panel-header-title{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t);font-family:'Space Mono',monospace}.panel-body{flex:1;padding:14px 16px;overflow-y:auto;-webkit-overflow-scrolling:touch}.panel-title{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin-bottom:7px;font-family:'Space Mono',monospace;display:flex;align-items:center;justify-content:space-between;gap:6px}.p-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:all .2s;font-size:.88rem}.p-row:hover{background:rgba(255,255,255,.05);transform:translateX(2px)}.p-row .av{font-size:1.4rem;width:30px;text-align:center}.p-row .name{font-weight:500;flex:1}.p-row .st{font-size:.7rem;color:var(--td)}.p-row .dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}.p-row .dot.on{background:var(--a);box-shadow:0 0 6px var(--ag)}.p-row .dot.off{background:rgba(255,255,255,.15)}.p-row-actions{display:flex;gap:4px;margin-left:auto}.mini-btn{padding:5px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:var(--tm);font-size:.7rem;cursor:pointer;transition:all .2s;font-family:'Outfit',sans-serif}.mini-btn:hover{background:var(--ad);color:var(--a);border-color:rgba(0,229,160,.2)}.mini-btn:active{transform:scale(.95)}.mini-btn.danger:hover{background:rgba(255,77,106,.12);color:var(--danger);border-color:rgba(255,77,106,.2)}.friend-badge{font-size:.6rem;padding:2px 6px;border-radius:5px;background:rgba(0,229,160,.12);color:var(--a);font-family:'Space Mono',monospace}.st-opt{display:inline-block;padding:10px 16px;margin:4px;border-radius:14px;font-size:.82rem;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);transition:all .2s}.st-opt:hover,.st-opt.sel{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.add-row{display:flex;gap:4px;margin-top:5px}.add-row input{flex:1;padding:5px 8px;font-size:.72rem;background:rgba(255,255,255,.04);border:1px solid var(--gb);border-radius:7px;color:var(--t);outline:none;font-family:'Outfit',sans-serif}.add-row input:focus{border-color:rgba(0,229,160,.3)}.grp-member-pick{display:flex;flex-wrap:wrap;gap:3px;margin:4px 0}.grp-mem{padding:2px 7px;border-radius:12px;font-size:.65rem;border:1px solid var(--gb);background:var(--glass);color:var(--tm);cursor:pointer;transition:all .2s}.grp-mem.sel{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.search-row{display:flex;gap:4px;margin-bottom:5px}.search-row input{flex:1;padding:6px 10px;font-size:.75rem;background:rgba(255,255,255,.04);border:1px solid var(--gb);border-radius:8px;color:var(--t);outline:none;font-family:'Outfit',sans-serif}.search-row input:focus{border-color:rgba(0,229,160,.3)}.search-results{overflow-y:auto}.card{background:rgba(15,15,25,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;backdrop-filter:blur(20px);margin-bottom:6px;animation:fu .4s ease;box-shadow:0 4px 20px rgba(0,0,0,.15)}.cl{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin-bottom:8px;font-family:'Space Mono',monospace}.irow{display:flex;gap:7px}input[type="text"]{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:11px 14px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.88rem;outline:none;transition:all .3s;letter-spacing:.01em}html.light input[type="text"]{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}input:focus{border-color:rgba(0,229,160,.4)!important;box-shadow:0 0 0 3px rgba(0,229,160,.06),0 4px 12px rgba(0,0,0,.1)}input::placeholder{color:var(--td)}.btn{padding:10px 14px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}.btn-p{background:var(--a);color:#0a0a0f}.btn-g{background:var(--glass);color:var(--tm);border:1px solid var(--gb)}.chat-tabs{display:flex;gap:3px;margin-bottom:3px;overflow-x:auto;scrollbar-width:none;padding:2px 0}.chat-tabs::-webkit-scrollbar{display:none}.chat-tab{padding:7px 13px;border-radius:11px;font-size:.78rem;font-weight:600;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);white-space:nowrap;transition:all .25s;display:flex;align-items:center;gap:4px;flex-shrink:0}.chat-tab.active{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a);box-shadow:0 2px 10px rgba(0,229,160,.1)}.chat-tab .unread{background:var(--danger);color:white;font-size:.48rem;padding:1px 4px;border-radius:8px;font-weight:700}.chat-tab .close-tab{font-size:.55rem;opacity:.4;cursor:pointer;margin-left:1px}.chat-tab .close-tab:hover{opacity:1}.msa{flex:1;min-height:0;display:flex;flex-direction:column}.msg-container{flex:1;overflow-y:auto;padding:10px 8px;display:flex;flex-direction:column;gap:4px;background:linear-gradient(180deg,rgba(0,229,160,.02) 0%,rgba(100,60,255,.02) 50%,rgba(0,0,0,0) 100%);border:1px solid var(--gb);border-radius:14px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.08) transparent}.msg-container::-webkit-scrollbar{width:3px}.msg-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}.msg-row{display:flex;gap:6px;align-items:flex-end;animation:msg-in .35s cubic-bezier(.4,0,.2,1) both}.msg-row.sent{flex-direction:row-reverse}.msg-row .msg-av{font-size:.9rem;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--glass);border:1px solid var(--gb);flex-shrink:0;margin-bottom:2px}.msg-row.sent .msg-av{display:none}@keyframes msg-in{from{opacity:0;transform:translateY(8px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}.m{max-width:78%;padding:10px 13px;border-radius:16px;font-size:.88rem;line-height:1.5;word-break:break-word;position:relative;letter-spacing:.01em}.m.s{background:var(--sb);border:1px solid var(--sbb);border-bottom-right-radius:4px}.m.s::after{content:'';position:absolute;bottom:0;right:-6px;width:12px;height:12px;background:var(--sb);clip-path:polygon(0 0,0% 100%,100% 100%);border-radius:0 0 0 4px}.m.r{background:var(--rb);border:1px solid var(--rbb);border-bottom-left-radius:4px}.m.r::after{content:'';position:absolute;bottom:0;left:-6px;width:12px;height:12px;background:var(--rb);clip-path:polygon(100% 0,0% 100%,100% 100%);border-radius:0 0 4px 0}.m.y{align-self:center;background:none;border:none;color:var(--td);font-size:.7rem;font-family:'Space Mono',monospace;padding:6px 0;letter-spacing:.5px}.mf{font-size:.7rem;color:var(--a);font-weight:600;margin-bottom:3px;letter-spacing:.02em}.reply-block{font-size:.6rem;padding:3px 6px;margin-bottom:3px;border-left:2px solid var(--a);background:rgba(0,229,160,.05);border-radius:0 6px 6px 0;color:var(--tm);max-height:30px;overflow:hidden}.mm{display:flex;align-items:center;gap:4px;margin-top:3px}.mt{font-size:.58rem;color:var(--td);font-family:'Space Mono',monospace;opacity:.7}.ms-icon{font-size:.62rem;opacity:.6}.mr{position:absolute;bottom:-8px;right:8px;background:rgba(12,12,20,.85);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:1px 5px;font-size:.58rem;backdrop-filter:blur(10px)}.m:hover .m-actions{opacity:1}.m-actions{position:absolute;top:-10px;right:-4px;opacity:0;display:flex;gap:3px;transition:opacity .2s}.m-act{background:rgba(12,12,20,.85);border:1px solid rgba(255,255,255,.08);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.55rem;backdrop-filter:blur(10px);transition:all .15s}.m-act:hover{background:var(--ad);transform:scale(1.1)}#ti{font-size:.68rem;color:var(--a);font-family:'Space Mono',monospace;height:14px;opacity:0;transition:opacity .3s}#ti.v{opacity:1}.reply-bar{display:none;align-items:center;gap:8px;padding:6px 10px;background:rgba(0,229,160,.04);border:1px solid rgba(0,229,160,.1);border-radius:10px;margin-bottom:4px;font-size:.72rem;animation:fu .15s ease}.reply-bar.show{display:flex}.reply-bar .rtext{flex:1;color:var(--tm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.reply-bar .rclose{cursor:pointer;color:var(--td)}.rps-bar{display:none;padding:8px;background:linear-gradient(135deg,rgba(167,139,250,.1),rgba(0,229,160,.08));border:1px solid rgba(167,139,250,.2);border-radius:10px;margin-bottom:4px;text-align:center;animation:fu .3s ease}.rps-bar.show{display:block}.rps-title{font-size:.7rem;font-weight:600;color:#a78bfa;margin-bottom:6px}.rps-choices{display:flex;gap:8px;justify-content:center}.rps-choice{font-size:1.8rem;cursor:pointer;padding:6px;border-radius:12px;border:2px solid transparent;transition:all .2s}.rps-choice:hover{border-color:var(--a);transform:scale(1.15);background:var(--ad)}.ibar{display:flex;gap:7px;margin-top:6px;padding-bottom:calc(10px + var(--safe-bottom,0px));align-items:center}.bs{width:42px;height:42px;padding:0;border-radius:50%;background:var(--a);color:#0a0a0f;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;box-shadow:0 3px 15px var(--ag);transition:all .2s}.bs:active{transform:scale(.92)}.bm{width:40px;height:40px;padding:0;border-radius:50%;background:var(--glass);border:1px solid var(--gb);color:var(--tm);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-size:1.1rem}.bm.rec{background:var(--danger);color:white;border-color:var(--danger);animation:pu 1s infinite}@keyframes pu{0%,100%{box-shadow:0 0 0 0 rgba(255,77,106,.4)}50%{box-shadow:0 0 0 7px rgba(255,77,106,0)}}.ep{display:none;position:absolute;bottom:50px;left:4px;right:4px;background:rgba(12,12,20,.92);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:8px;z-index:50;max-height:160px;overflow-y:auto;animation:fu .2s ease;backdrop-filter:blur(20px);box-shadow:0 -4px 20px rgba(0,0,0,.3)}.ep.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}.ei{font-size:1.5rem;text-align:center;padding:5px;border-radius:9px;cursor:pointer;transition:all .15s}.ei:hover{background:rgba(255,255,255,.08);transform:scale(1.15)}.rp{display:none;position:fixed;background:rgba(12,12,20,.9);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:4px 6px;z-index:60;backdrop-filter:blur(20px);box-shadow:0 6px 24px rgba(0,0,0,.4)}.rp.show{display:flex;gap:2px;animation:fu .2s ease}.rp span{font-size:.9rem;cursor:pointer;padding:3px 4px;border-radius:8px;transition:all .15s}.rp span:hover{background:rgba(255,255,255,.1);transform:scale(1.2)}.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(6px)}.modal-bg.show{display:flex}.modal{background:rgba(15,15,25,.85);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:22px;max-width:360px;width:90%;max-height:80vh;overflow-y:auto;animation:fu .3s ease;backdrop-filter:blur(30px);box-shadow:0 12px 50px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.05)}.modal-title{font-family:'Space Mono',monospace;font-size:.85rem;font-weight:700;color:var(--a);margin-bottom:10px;text-align:center}.modal-text{font-size:.75rem;color:var(--tm);line-height:1.6;white-space:pre-line}.modal-close{display:block;margin:12px auto 0;padding:8px 24px;border:none;border-radius:8px;background:var(--a);color:#0a0a0f;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif}.poll-box{background:linear-gradient(135deg,rgba(100,60,255,.08),rgba(0,229,160,.05));border:1px solid rgba(100,60,255,.2);border-radius:10px;padding:8px;margin:3px 0;max-width:85%}.poll-q{font-size:.75rem;font-weight:600;color:#a78bfa;margin-bottom:5px}.poll-opt{padding:5px 8px;margin:2px 0;border-radius:6px;font-size:.7rem;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);transition:all .2s;display:flex;justify-content:space-between}.poll-opt:hover{border-color:rgba(0,229,160,.3)}.poll-opt.voted{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}svg{display:block}
    .voice-msg{display:flex;align-items:center;gap:6px;padding:2px 0}
    .profile-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:0;max-width:360px;width:92%;max-height:85vh;overflow-y:auto;animation:fu .3s ease}
    .prof-header{position:relative;padding:28px 20px 16px;text-align:center;background:linear-gradient(180deg,rgba(0,229,160,.08) 0%,transparent 100%);border-radius:18px 18px 0 0}
    .prof-avatar{font-size:3rem;display:block;margin:0 auto 6px;filter:drop-shadow(0 2px 10px var(--ag))}
    .prof-name{font-size:1.1rem;font-weight:700;color:var(--t)}.prof-login{font-size:.7rem;color:var(--td);font-family:'Space Mono',monospace;margin-top:2px}
    .prof-level{display:inline-block;margin-top:6px;padding:3px 10px;border-radius:20px;font-size:.65rem;font-weight:700;font-family:'Space Mono',monospace;background:linear-gradient(135deg,rgba(167,139,250,.25),rgba(0,229,160,.15));color:#a78bfa}
    .prof-online{display:inline-block;margin-left:6px;padding:3px 8px;border-radius:20px;font-size:.6rem;font-weight:600}
    .prof-online.on{background:rgba(0,229,160,.15);color:var(--a)}.prof-online.off{background:rgba(255,255,255,.06);color:var(--td)}
    .prof-bio{padding:0 20px 10px;font-size:.8rem;color:var(--tm);text-align:center;font-style:italic}
    .prof-bio-edit{width:100%;padding:6px 10px;background:var(--glass);border:1px solid var(--gb);border-radius:8px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.78rem;outline:none;resize:none;text-align:center}
    .prof-bio-edit:focus{border-color:rgba(0,229,160,.4)}
    .prof-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;padding:0 16px 14px}
    .prof-stat{text-align:center;padding:10px 4px;background:var(--glass);border-radius:10px}
    .prof-stat:first-child{border-radius:10px 4px 4px 10px}.prof-stat:last-child{border-radius:4px 10px 10px 4px}
    .prof-stat .val{font-size:1.1rem;font-weight:700;color:var(--a);font-family:'Space Mono',monospace}
    .prof-stat .lbl{font-size:.55rem;color:var(--td);text-transform:uppercase;letter-spacing:1px;margin-top:2px;font-family:'Space Mono',monospace}
    .prof-weather{margin:0 16px 10px;padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,rgba(6,182,212,.08),rgba(100,60,255,.06));border:1px solid rgba(6,182,212,.12);display:flex;align-items:center;gap:10px;font-size:.82rem}
    .prof-weather .pw-icon{font-size:1.6rem}.prof-weather .pw-temp{font-size:1.2rem;font-weight:700;font-family:'Space Mono',monospace;color:var(--t)}.prof-weather .pw-desc{font-size:.68rem;color:var(--td)}.prof-weather .pw-city{font-size:.6rem;color:var(--td);font-family:'Space Mono',monospace;opacity:.7}
    .pet-box{margin:0 16px 10px;padding:10px 14px;border-radius:14px;background:linear-gradient(135deg,rgba(244,114,182,.06),rgba(167,139,250,.06));border:1px solid rgba(244,114,182,.12);cursor:pointer;transition:all .2s;text-align:center}
    .pet-box:hover{background:linear-gradient(135deg,rgba(244,114,182,.1),rgba(167,139,250,.1))}
    .pet-mini{display:flex;align-items:center;gap:10px;justify-content:center}
    .pet-mini-sprite{font-size:1.6rem;animation:pet-bounce 2s ease-in-out infinite}
    @keyframes pet-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    .pet-mini-info{text-align:left}.pet-mini-name{font-weight:600;font-size:.82rem}.pet-mini-lvl{font-size:.58rem;color:#a78bfa;font-family:'Space Mono',monospace}
    .pet-modal{background:rgba(6,6,14,.97);border-radius:22px;width:94%;max-width:380px;max-height:90vh;overflow-y:auto;animation:fu .35s ease;backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,.06)}
    .pet-scene{position:relative;height:300px;border-radius:22px 22px 0 0;overflow:hidden;display:flex;align-items:flex-end;justify-content:center;padding-bottom:10px;transition:background 1s ease}
    .pet-scene.day{background:linear-gradient(180deg,#1a6fc4 0%,#5bb8f5 25%,#8dd4a8 65%,#3d8c5c 100%)}
    .pet-scene.sunset{background:linear-gradient(180deg,#2d1b4e 0%,#c0392b 25%,#e67e22 50%,#4a7a3d 100%)}
    .pet-scene.night{background:linear-gradient(180deg,#0b1628 0%,#132844 30%,#1a4a3a 65%,#0f3025 100%)}
    .pet-scene.morning{background:linear-gradient(180deg,#1a3a5c 0%,#e8a87c 30%,#87ceeb 55%,#4a8c5c 100%)}
    .pet-sun{position:absolute;width:40px;height:40px;border-radius:50%;z-index:1;filter:blur(2px)}
    .pet-sun.day{top:12%;right:18%;background:radial-gradient(circle,#fff4a3,#ffd700);box-shadow:0 0 30px rgba(255,215,0,.4)}
    .pet-sun.sunset{top:35%;right:15%;background:radial-gradient(circle,#ff6b35,#ff4500);box-shadow:0 0 40px rgba(255,69,0,.3)}
    .pet-sun.morning{top:28%;left:18%;background:radial-gradient(circle,#ffeaa7,#fdcb6e);box-shadow:0 0 25px rgba(253,203,110,.4)}
    .pet-moon{position:absolute;top:10%;right:20%;width:30px;height:30px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#f0e68c,#ddd);box-shadow:0 0 20px rgba(240,230,140,.2);z-index:1}
    .pet-scene::before{content:'';position:absolute;top:15%;left:50%;width:120px;height:120px;background:radial-gradient(circle,rgba(255,200,50,.06),transparent 70%);transform:translateX(-50%);border-radius:50%;filter:blur(20px)}
    .pet-scene-stars{position:absolute;top:0;left:0;right:0;height:45%;pointer-events:none}
    .pet-scene-ground{position:absolute;bottom:0;left:0;right:0;height:35%;background:linear-gradient(180deg,rgba(34,197,94,.06) 0%,rgba(34,197,94,.03) 50%,rgba(16,70,50,.15) 100%)}
    .pet-scene-grass{position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,rgba(34,197,94,.2),rgba(34,197,94,.1),rgba(34,197,94,.2))}
    .pet-weather{position:absolute;inset:0;pointer-events:none;z-index:4;overflow:hidden}
    .rain-drop{position:absolute;width:2px;background:linear-gradient(180deg,transparent,rgba(100,180,255,.4));border-radius:0 0 2px 2px;animation:rain-fall linear infinite}
    @keyframes rain-fall{0%{transform:translateY(-20px)}100%{transform:translateY(310px)}}
    .snow-flake{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;animation:snow-fall linear infinite}
    @keyframes snow-fall{0%{transform:translateY(-10px) translateX(0) rotate(0)}50%{transform:translateY(150px) translateX(15px) rotate(180deg)}100%{transform:translateY(310px) translateX(-5px) rotate(360deg)}}
    .pet-rainbow{position:absolute;top:8%;left:50%;transform:translateX(-50%);width:160px;height:80px;border-radius:80px 80px 0 0;border:4px solid transparent;border-top:4px solid rgba(255,0,0,.15);box-shadow:0 -4px 0 rgba(255,127,0,.12),0 -8px 0 rgba(255,255,0,.1),0 -12px 0 rgba(0,255,0,.08),0 -16px 0 rgba(0,0,255,.06),0 -20px 0 rgba(75,0,130,.05);z-index:1;opacity:.7}
    .pet-footprints{position:absolute;bottom:5%;left:0;right:0;height:20px;pointer-events:none;z-index:1}
    .pet-footprint{position:absolute;font-size:.5rem;opacity:0;animation:footprint-show 3s ease forwards}
    @keyframes footprint-show{0%{opacity:0}10%{opacity:.3}80%{opacity:.2}100%{opacity:0}}
    .pet-evo-flash{position:absolute;inset:0;background:radial-gradient(circle,rgba(255,255,255,.9),rgba(167,139,250,.3),transparent 70%);z-index:20;animation:evo-flash 1.5s ease forwards;pointer-events:none}
    @keyframes evo-flash{0%{opacity:0;transform:scale(.5)}30%{opacity:1;transform:scale(1.2)}60%{opacity:.8;transform:scale(1)}100%{opacity:0;transform:scale(1.5)}}
    .pet-sick{animation:pet-sick 1.5s ease-in-out infinite !important}
    @keyframes pet-sick{0%,100%{transform:translateY(0) rotate(0);filter:hue-rotate(0)}25%{transform:translateY(-3px) rotate(-3deg);filter:hue-rotate(40deg)}75%{transform:translateY(-2px) rotate(3deg);filter:hue-rotate(-20deg)}}
    .pet-sick-icon{position:absolute;top:22%;left:20%;font-size:1.4rem;z-index:5;animation:sick-pulse 1.5s ease-in-out infinite}
    @keyframes sick-pulse{0%,100%{opacity:.5;transform:scale(.9)}50%{opacity:1;transform:scale(1.1)}}
    .pet-outfit{position:absolute;z-index:3;pointer-events:none}
    .pet-hat{top:-20px;left:50%;transform:translateX(-50%);font-size:1.6rem}
    .pet-costume{top:55%;left:50%;transform:translateX(-50%);font-size:1rem;opacity:.8}
    .pet-clothes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
    .pet-cloth-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:10px;border:1px solid rgba(255,255,255,.05);background:rgba(255,255,255,.02);cursor:pointer;transition:all .2s;font-size:.55rem}
    .pet-cloth-item:hover{background:rgba(0,229,160,.06);border-color:rgba(0,229,160,.15);transform:translateY(-2px)}
    .pet-cloth-item.owned{border-color:rgba(167,139,250,.2);background:rgba(167,139,250,.06)}
    .pet-cloth-item.equipped{border-color:var(--a);box-shadow:0 0 10px var(--ag)}
    .pet-cloth-item.disabled{opacity:.3;pointer-events:none}
    .pet-cloth-item .pc-icon{font-size:1.4rem}.pet-cloth-item .pc-cost{color:#fbbf24;font-family:'Space Mono',monospace}
    .pet-platform{position:absolute;bottom:15px;left:50%;transform:translateX(-50%);width:100px;height:14px;background:radial-gradient(ellipse,rgba(0,229,160,.15),transparent 70%);border-radius:50%;z-index:1}
    .pet-speech{position:absolute;top:8%;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.92);color:#1a1a2e;padding:8px 14px;border-radius:14px 14px 14px 4px;font-size:.72rem;font-weight:600;max-width:180px;text-align:center;z-index:10;animation:speech-in .4s ease;box-shadow:0 3px 12px rgba(0,0,0,.2)}
    .pet-speech::after{content:'';position:absolute;bottom:-6px;left:20px;width:0;height:0;border-left:8px solid rgba(255,255,255,.92);border-bottom:8px solid transparent}
    @keyframes speech-in{0%{opacity:0;transform:translateX(-50%) translateY(8px) scale(.8)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
    .pet-emotion{position:absolute;top:18%;right:15%;font-size:2rem;z-index:5;animation:emotion-pop .6s ease forwards;pointer-events:none}
    @keyframes emotion-pop{0%{opacity:0;transform:scale(0) rotate(-20deg)}40%{opacity:1;transform:scale(1.3) rotate(10deg)}100%{opacity:0;transform:scale(.8) translateY(-20px)}}
    .pet-food-menu{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;padding:0 2px}
    .pet-food-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;border-radius:10px;border:1px solid rgba(255,255,255,.05);background:rgba(255,255,255,.02);cursor:pointer;transition:all .2s;font-size:.55rem}
    .pet-food-item:hover{background:rgba(0,229,160,.06);border-color:rgba(0,229,160,.15);transform:translateY(-2px)}
    .pet-food-item:active{transform:scale(.93)}
    .pet-food-item .pf-icon{font-size:1.3rem}.pet-food-item .pf-cost{color:#fbbf24;font-family:'Space Mono',monospace}
    .pet-food-item.disabled{opacity:.3;pointer-events:none}
    .pet-room-items{position:absolute;bottom:0;left:0;right:0;height:40%;pointer-events:none;z-index:1}
    .pet-furniture{position:absolute;font-size:1.4rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
    .pet-character{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;animation:pet-idle 3s ease-in-out infinite;cursor:pointer;transition:transform .2s;margin-bottom:6px}
    .pet-character:hover{transform:scale(1.06)}
    .pet-character:active{transform:scale(.9)}
    .pet-character.eating{animation:pet-eat .5s ease 3}
    .pet-character.playing{animation:pet-play .5s ease 4}
    .pet-character.sleeping{animation:pet-sleep 2s ease-in-out infinite}
    .pet-body{position:relative;display:flex;flex-direction:column;align-items:center}
    .pet-head{font-size:4.5rem;filter:drop-shadow(0 0 25px rgba(255,200,100,.15));position:relative;z-index:2;line-height:1}
    .pet-belly{width:70px;height:50px;background:radial-gradient(ellipse at 50% 30%,rgba(255,220,150,.12),rgba(200,160,100,.06));border:1px solid rgba(255,220,150,.08);border-radius:50%;margin-top:-18px;position:relative;z-index:1;box-shadow:inset 0 -4px 10px rgba(0,0,0,.1),0 4px 15px rgba(0,0,0,.15)}
    .pet-belly::after{content:'';position:absolute;top:25%;left:50%;transform:translateX(-50%);width:30px;height:20px;background:radial-gradient(ellipse,rgba(255,255,255,.08),transparent);border-radius:50%}
    .pet-feet{display:flex;gap:20px;margin-top:-4px;z-index:1}
    .pet-foot{width:22px;height:14px;background:radial-gradient(ellipse at 50% 20%,rgba(200,160,100,.15),rgba(150,120,80,.08));border:1px solid rgba(200,160,100,.08);border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .pet-paws{display:flex;gap:52px;position:absolute;top:40%;z-index:0}
    .pet-paw{width:16px;height:24px;background:radial-gradient(ellipse,rgba(200,160,100,.1),transparent);border-radius:50%;transform:rotate(10deg)}
    .pet-paw:last-child{transform:rotate(-10deg)}
    .pet-shadow{width:80px;height:12px;background:radial-gradient(ellipse,rgba(0,0,0,.3),transparent);border-radius:50%;margin-top:2px;animation:shadow-pulse 3s ease-in-out infinite}
    @keyframes shadow-pulse{0%,100%{transform:scaleX(1);opacity:.8}25%{transform:scaleX(.85);opacity:.6}75%{transform:scaleX(.9);opacity:.7}}
    .pet-accessory{position:absolute;top:-14px;right:-16px;font-size:1.3rem;z-index:3;animation:pet-acc 2.5s ease-in-out infinite;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
    @keyframes pet-acc{0%,100%{transform:rotate(-8deg) translateY(0)}50%{transform:rotate(8deg) translateY(-3px)}}
    .pet-glow{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:140px;height:80px;background:radial-gradient(ellipse,rgba(0,229,160,.06),transparent 70%);border-radius:50%;z-index:0;filter:blur(15px);animation:glow-breathe 4s ease-in-out infinite}
    @keyframes glow-breathe{0%,100%{opacity:.5;transform:translateX(-50%) scale(1)}50%{opacity:1;transform:translateX(-50%) scale(1.15)}}
    .pet-particles{position:absolute;bottom:30%;left:0;right:0;height:40%;pointer-events:none;z-index:1}
    @keyframes pet-idle{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-10px) rotate(-2deg)}75%{transform:translateY(-5px) rotate(2deg)}}
    @keyframes pet-eat{0%,100%{transform:scale(1)}30%{transform:scale(1.15) rotate(5deg)}60%{transform:scale(1.08) rotate(-3deg)}}
    @keyframes pet-play{0%{transform:rotate(0) translateY(0)}25%{transform:rotate(-15deg) translateY(-18px)}50%{transform:rotate(15deg) translateY(-25px) scale(1.1)}75%{transform:rotate(-5deg) translateY(-10px)}100%{transform:rotate(0) translateY(0)}}
    @keyframes pet-sleep{0%,100%{transform:scale(1) translateY(0)}50%{transform:scale(1.03) translateY(2px)}}
    @keyframes pet-trick{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-20deg) scale(1.1) translateY(-20px)}50%{transform:rotate(360deg) scale(.9) translateY(-30px)}75%{transform:rotate(380deg) scale(1.05) translateY(-10px)}100%{transform:rotate(360deg) scale(1) translateY(0)}}
    .pet-zzz{position:absolute;top:30%;right:25%;font-size:1.2rem;opacity:0;animation:pet-zzz-float 2s ease-in-out infinite}
    @keyframes pet-zzz-float{0%{opacity:0;transform:translate(0,0)}50%{opacity:1}100%{opacity:0;transform:translate(10px,-20px)}}
    @keyframes twinkle{0%,100%{opacity:.15}50%{opacity:1}}
    @keyframes particle-float{0%,100%{transform:translateY(0) translateX(0)}25%{transform:translateY(-8px) translateX(3px)}50%{transform:translateY(-2px) translateX(-3px)}75%{transform:translateY(-10px) translateX(2px)}}
    .pet-hearts{position:absolute;pointer-events:none;z-index:3}
    .pet-heart{position:absolute;font-size:1rem;animation:pet-heart-rise 1s ease forwards;opacity:0}
    @keyframes pet-heart-rise{0%{opacity:1;transform:translateY(0) scale(0)}30%{opacity:1;transform:translateY(-15px) scale(1.2)}100%{opacity:0;transform:translateY(-40px) scale(.6)}}
    .pet-info{padding:18px 16px}
    .pet-name-row{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px}
    .pet-name-big{font-size:1.2rem;font-weight:700;letter-spacing:.02em}.pet-mood-icon{font-size:1.3rem}
    .pet-lvl-row{text-align:center;margin-bottom:12px}
    .pet-lvl-badge{font-size:.68rem;padding:4px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(167,139,250,.25),rgba(244,114,182,.18));color:#c4b5fd;font-family:'Space Mono',monospace;font-weight:700;border:1px solid rgba(167,139,250,.15)}
    .pet-lvl-xp{font-size:.58rem;color:var(--td);font-family:'Space Mono',monospace;margin-top:5px}
    .pet-stats{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .pet-stat-row{display:flex;align-items:center;gap:8px}
    .pet-stat-icon{font-size:1.1rem;width:26px;text-align:center}
    .pet-stat-lbl{font-size:.72rem;color:var(--td);width:55px;font-weight:500}
    .pet-stat-track{flex:1;height:10px;background:rgba(255,255,255,.04);border-radius:8px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.03)}
    .pet-stat-fill{height:100%;border-radius:7px;transition:width .8s cubic-bezier(.4,0,.2,1)}
    .pet-stat-fill.hunger{background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e);box-shadow:inset 0 1px 0 rgba(255,255,255,.2)}.pet-stat-fill.happy{background:linear-gradient(90deg,#6366f1,#a78bfa,#f472b6);box-shadow:inset 0 1px 0 rgba(255,255,255,.2)}
    .pet-stat-val{font-size:.72rem;font-family:'Space Mono',monospace;width:42px;text-align:right;font-weight:700}
    .pet-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
    .pet-action{display:flex;flex-direction:column;align-items:center;gap:5px;padding:14px 6px;border-radius:14px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);cursor:pointer;transition:all .25s}
    .pet-action:hover{background:linear-gradient(135deg,rgba(0,229,160,.08),rgba(167,139,250,.06));border-color:rgba(0,229,160,.15);transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .pet-action:active{transform:scale(.94)}
    .pet-action .pa-icon{font-size:1.6rem}.pet-action .pa-name{font-size:.7rem;font-weight:600;letter-spacing:.02em}.pet-action .pa-cost{font-size:.58rem;color:#fbbf24;font-family:'Space Mono',monospace}
    .pet-action.disabled{opacity:.35;pointer-events:none}
    .pet-adopt-modal{padding:20px;text-align:center}
    .pet-adopt-title{font-size:1rem;font-weight:700;color:var(--a);margin-bottom:4px}
    .pet-adopt-sub{font-size:.72rem;color:var(--td);margin-bottom:14px}
    .pet-adopt-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
    .pet-adopt-opt{font-size:2.2rem;padding:12px;border-radius:14px;border:2px solid transparent;cursor:pointer;transition:all .25s;background:rgba(255,255,255,.03)}
    .pet-adopt-opt:hover{border-color:rgba(0,229,160,.3);background:var(--ad);transform:scale(1.08)}
    .pet-adopt-opt.sel{border-color:var(--a);box-shadow:0 0 15px var(--ag);transform:scale(1.1)}
    .pet-adopt-name{margin-top:10px}.pet-adopt-name input{width:80%;padding:10px;text-align:center;font-size:.9rem;border-radius:10px}
    .prof-details{padding:0 16px 16px;display:flex;flex-direction:column;gap:6px}
    .prof-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--glass);border-radius:9px;font-size:.78rem}
    .prof-row .lbl{color:var(--td)}.prof-row .val{color:var(--t);font-weight:500;font-family:'Space Mono',monospace;font-size:.72rem}
    .prof-xp{padding:0 16px 14px}.prof-xp-bar{height:6px;background:var(--glass);border-radius:4px;overflow:hidden;margin-top:4px}.prof-xp-fill{height:100%;background:linear-gradient(90deg,var(--a),#a78bfa);border-radius:4px}
    .prof-xp-text{display:flex;justify-content:space-between;font-size:.55rem;color:var(--td);margin-top:2px;font-family:'Space Mono',monospace}
    .prof-actions{padding:0 16px 16px;display:flex;gap:6px}
    .prof-actions .abtn{font-size:.78rem;padding:9px}
    .voice-btn{width:28px;height:28px;border-radius:50%;border:none;background:var(--a);color:#0a0a0f;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;flex-shrink:0;transition:all .2s;box-shadow:0 1px 6px var(--ag)}.voice-btn:hover{transform:scale(1.08)}.voice-btn.playing{background:#a78bfa}
    .voice-wave{flex:1;height:24px;display:flex;align-items:center;gap:1px}.voice-bar{width:3px;border-radius:2px;background:var(--a);opacity:.4;transition:all .15s}.voice-bar.active{opacity:1}
    .voice-time{font-size:.5rem;color:var(--td);font-family:'Space Mono',monospace;min-width:28px;text-align:right}
    @media(max-width:540px){.app{padding:6px 6px 0 6px}}
  </style>
</head>
<body>
<div class="splash" id="splash"><img src="logo.png" alt="KÖRPÜ"><div class="splash-text">KÖRPÜ</div><div class="splash-bar"><div class="splash-bar-fill"></div></div></div>
<div class="app">
<div class="auth" id="authScr">
  <img src="logo.png" class="auth-logo" alt=""><div class="auth-title">KÖRPÜ</div><div class="auth-sub">Безопасный мессенджер</div>
  <div class="auth-card">
    <div class="tabs"><div class="tab on" id="tL" onclick="stab('l')">Войти</div><div class="tab" id="tR" onclick="stab('r')">Регистрация</div></div>
    <div id="fL"><div class="field"><label>Логин</label><input type="text" id="lU" placeholder="Введите логин..."></div><div class="field"><label>Пароль</label><input type="password" id="lP" placeholder="Введите пароль..."></div><button class="abtn abtn-p" onclick="doLogin()">Войти</button></div>
    <div id="fR" style="display:none"><div class="field"><label>Имя</label><input type="text" id="rN" placeholder="Ваше имя..."></div><div class="field"><label>Логин</label><input type="text" id="rU" placeholder="Только буквы и цифры..."></div><div class="field"><label>Пароль</label><input type="password" id="rP" placeholder="Минимум 4 символа..."></div><div class="field"><label>Аватар</label><div class="avatar-pick" id="regAP"></div></div><button class="abtn abtn-p" onclick="doReg()">Зарегистрироваться</button></div>
    <div class="auth-err" id="aErr"></div>
    <div class="divider">или</div>
    <div class="anon-box"><div class="anon-title">🕶 Анонимный чат</div><div class="field"><label style="text-align:center">Ваш никнейм</label><input type="text" id="gN" placeholder="Придумайте имя..." style="text-align:center"></div><button class="abtn abtn-g" onclick="doGuest()">Войти анонимно</button></div>
    <div class="saved-info" id="savedInfo" style="display:none">Последний вход: <a id="savedU" onclick="quickL()"></a></div>
  </div>
</div>
<div class="chat" id="chatScr">
  <div class="hdr"><div class="logo">KÖRPÜ</div><div class="hdr-r">
    <div class="badge on" id="stB">ОФЛАЙН</div>
    <div class="ib" onclick="isDark=!isDark;document.documentElement.classList.toggle('light',!isDark)">🌙</div>
    <div class="ib" id="menuBtn" onclick="toggleMenu()">☰</div>
  </div></div>
  <!-- Side Menu -->
  <div class="menu-overlay" id="menuOv" onclick="toggleMenu()"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <span class="av-icon" id="menuAv" onclick="showProfile(myId);toggleMenu()" style="cursor:pointer;font-size:2rem">🐱</span>
      <div style="flex:1"><div class="menu-name" id="menuNm">—</div><div class="menu-login" id="menuLg">@—</div></div>
      <span class="lvl-badge" id="menuLvl" style="font-size:.72rem;padding:4px 9px">LVL 1</span>
    </div>
    <div class="menu-xp"><div class="xp-bar"><div class="xp-fill" id="xpFill" style="width:0%"></div></div><div class="xp-text"><span id="xpTxt">0 XP</span><span id="xpNext">→ 50 XP</span></div></div>
    <div class="menu-coins" id="menuCoins">🪙 0</div>
    <div class="lang-sw"><button class="lang-btn" onclick="setLang('ru')">RU</button><button class="lang-btn" onclick="setLang('en')">EN</button><button class="lang-btn" onclick="setLang('az')">AZ</button></div>
    <div class="theme-colors" id="themeColors"></div>
    <div class="menu-items" id="menuItems"></div>
    <div class="menu-bottom"><div class="menu-item danger" onclick="doLogout()"><span class="mi-icon">🚪</span> <span id="menuLogout">Выйти</span></div></div>
  </div>
  <div class="panel" id="stP" onclick="if(event.target===this)toggleP('stP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('stP')">←</div><div class="panel-header-title">⚡ СТАТУС</div></div><div class="panel-body"><span class="st-opt" onclick="setSt('Онлайн');toggleP('stP')">🟢 Онлайн</span><span class="st-opt" onclick="setSt('Отдыхаю');toggleP('stP')">😴 Отдыхаю</span><span class="st-opt" onclick="setSt('Ку-Ку');toggleP('stP')">👋 Ку-Ку</span><span class="st-opt" onclick="setSt('Он тут');toggleP('stP')">👀 Он тут</span><span class="st-opt" onclick="setSt('Занят');toggleP('stP')">🔴 Занят</span><span class="st-opt" onclick="setSt('Играю');toggleP('stP')">🎮 Играю</span></div></div></div>
  <div class="panel" id="oP" onclick="if(event.target===this)toggleP('oP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('oP')">←</div><div class="panel-header-title">👥 ОНЛАЙН</div></div><div class="panel-body" id="oL"></div></div></div>
  <div class="panel" id="fP" onclick="if(event.target===this)toggleP('fP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('fP')">←</div><div class="panel-header-title">👫 ДРУЗЬЯ</div><span class="mini-btn" onclick="toggleP('fP');toggleP('grpC')" style="margin-left:auto">+ Группа</span><span class="mini-btn" onclick="toggleP('fP');toggleP('blP')">🚫</span></div><div class="panel-body"><div id="fL2"></div><div class="add-row" style="margin-top:10px"><input type="text" id="addFI" placeholder="Логин друга..."><button class="mini-btn" onclick="addFriend()">➕</button></div></div></div></div>
  <div class="panel" id="blP" onclick="if(event.target===this)toggleP('blP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('blP')">←</div><div class="panel-header-title">🚫 ЗАБЛОКИРОВАННЫЕ</div></div><div class="panel-body" id="blL"></div></div></div>
  <div class="panel" id="gP" onclick="if(event.target===this)toggleP('gP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('gP')">←</div><div class="panel-header-title">💬 ГРУППЫ</div></div><div class="panel-body" id="gL"></div></div></div>
  <div class="panel" id="grpC" onclick="if(event.target===this)toggleP('grpC')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('grpC')">←</div><div class="panel-header-title">➕ СОЗДАТЬ ГРУППУ</div></div><div class="panel-body"><div class="field"><label style="font-size:.72rem;color:var(--td)">Название</label><input type="text" id="grpName" placeholder="Имя группы..." style="margin-top:4px"></div><div style="font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin:10px 0 6px;font-family:'Space Mono',monospace">ВЫБЕРИ ДРУЗЕЙ</div><div class="grp-member-pick" id="grpMemPick"></div><button class="mini-btn" style="font-size:.78rem;padding:10px 20px;margin-top:12px" onclick="createGroup();toggleP('grpC')">Создать</button></div></div></div>
  <div class="panel" id="sP" onclick="if(event.target===this)toggleP('sP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('sP')">←</div><div class="panel-header-title">🔍 ПОИСК</div></div><div class="panel-body"><div class="search-row"><input type="text" id="searchI" placeholder="Имя или логин..." oninput="doSearch()"><button class="mini-btn" onclick="doSearch()">🔍</button></div><div class="search-results" id="searchR"></div></div></div></div>
  <div class="panel" id="gamesP" onclick="if(event.target===this)toggleP('gamesP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('gamesP')">←</div><div class="panel-header-title">🎮 ИГРЫ</div></div><div class="panel-body" id="gamesContent"></div></div></div>
  <div class="panel" id="chP" onclick="if(event.target===this)toggleP('chP')"><div class="panel-card"><div class="panel-header"><div class="panel-back" onclick="toggleP('chP')">←</div><div class="panel-header-title">📢 КАНАЛЫ</div></div><div class="panel-body"><div id="chList"></div><div class="ch-create" style="margin-top:10px"><input type="text" id="chNameI" placeholder="Название канала..."><button class="mini-btn" onclick="createCh()">+</button></div><div style="margin-top:10px"><div style="font-size:.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin-bottom:6px;font-family:'Space Mono',monospace">🔍 НАЙТИ</div><div class="ch-create"><input type="text" id="chSearchI" placeholder="Поиск..." oninput="searchCh()"><button class="mini-btn" onclick="searchCh()">🔍</button></div><div id="chSearchR"></div></div></div></div></div>
  <div class="conn-row" id="cC"><input type="text" id="pId" placeholder="ID или логин..."><button class="conn-btn" onclick="doConn()">→</button></div>
  <div class="rps-bar" id="rpsBar"><div class="rps-title" id="rpsTitle">🎲 Камень-Ножницы-Бумага</div><div class="rps-choices"><div class="rps-choice" onclick="rpsPlay('rock')">🪨</div><div class="rps-choice" onclick="rpsPlay('paper')">📄</div><div class="rps-choice" onclick="rpsPlay('scissors')">✂️</div></div></div>
  <div class="chat-tabs" id="chatTabs"></div>
  <div class="reply-bar" id="replyBar"><span>↩️</span><span class="rtext" id="replyText"></span><span class="rclose" onclick="cancelReply()">✕</span></div>
  <div class="msa"><div class="msg-container" id="msgArea"></div><div id="ti"></div></div>
  <div class="ibar" style="position:relative">
    <div class="ib" onclick="document.getElementById('eP').classList.toggle('show')">😊</div>
    <div class="bm" id="mic" onmousedown="srec()" onmouseup="erec()" ontouchstart="srec()" ontouchend="erec()">🎤</div>
    <input type="text" id="mI" placeholder="Сообщение..." onkeydown="hk(event)">
    <button class="bs" onclick="snd()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    <div class="ep" id="eP"></div>
  </div>
</div>
</div>
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="modal"><div class="modal-title" id="modalTitle"></div><div class="modal-text" id="modalText"></div><button class="modal-close" onclick="document.getElementById('modalBg').classList.remove('show')">Закрыть</button></div></div>
<div class="modal-bg" id="petBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="pet-modal" id="petModal"></div></div>
<div class="modal-bg" id="wheelBg" onclick="if(event.target===this&&!wheelSpinning)this.classList.remove('show')"><div class="wheel-modal" id="wheelModal"></div></div>
<div class="modal-bg" id="lbBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="lb-modal" id="lbModal"></div></div>
<div class="modal-bg" id="shopBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="shop-modal" id="shopModal"></div></div>
<div class="modal-bg" id="tttBg" onclick="if(event.target===this&&!tttGame)this.classList.remove('show')"><div class="ttt-modal" id="tttModal"></div></div>
<div class="modal-bg" id="dkBg" onclick="if(event.target===this&&!dkGame)this.classList.remove('show')"><div class="dk-modal" id="dkModal"></div></div>
<div class="modal-bg" id="ckBg" onclick="if(event.target===this&&!ckGame)this.classList.remove('show')"><div class="ck-modal" id="ckModal"></div></div>
<div class="ach-toast" id="achToast"><div class="ach-lbl" id="achToastLbl">🏅</div><div class="ach-icon" id="achToastIcon"></div><div class="ach-name" id="achToastName"></div></div>
<div class="modal-bg" id="profBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="profile-modal" id="profModal"></div></div>
<div class="rp" id="rPk"><span onclick="doReact('👍')">👍</span><span onclick="doReact('❤️')">❤️</span><span onclick="doReact('😂')">😂</span><span onclick="doReact('😮')">😮</span><span onclick="doReact('😢')">😢</span><span onclick="doReact('🔥')">🔥</span></div>
<script>
const WS='wss://korpu-server.onrender.com',API=WS.replace('wss','https');
const EM=['😀','😂','🤣','😊','😍','🥰','😘','😎','🤩','🥳','😏','😢','😭','😤','🤯','🤔','🤫','🤗','😴','👍','👎','👋','🙏','💪','❤️','🔥','⭐','🎉','💯','✅','❌','💀','👀','🚀','☕','🍕','🎵','🫡','🫶','🤮'];
const AVS=['🐱','🐶','🦊','🐼','🐨','🦁','🐯','🐸','🐵','🦄','🐺','🐰','🐻','🦋','🐙','🐧'];
const XPL=[0,50,150,300,500,800,1200,1800,2500,3500,5000];

// i18n
let curLang=localStorage.getItem('kLang')||'ru';
const THEMES=[
  {id:'green',color:'#00e5a0',rgb:'0,229,160'},
  {id:'blue',color:'#3b82f6',rgb:'59,130,246'},
  {id:'purple',color:'#a78bfa',rgb:'167,139,250'},
  {id:'pink',color:'#f472b6',rgb:'244,114,182'},
  {id:'red',color:'#ef4444',rgb:'239,68,68'},
  {id:'orange',color:'#f59e0b',rgb:'245,158,11'},
  {id:'cyan',color:'#06b6d4',rgb:'6,182,212'},
  {id:'white',color:'#e8e8ec',rgb:'232,232,236'},
];
let curTheme=localStorage.getItem('kTheme')||'green';
function setTheme(id){
  const th=THEMES.find(t=>t.id===id);if(!th)return;
  curTheme=id;localStorage.setItem('kTheme',id);
  document.documentElement.style.setProperty('--a',th.color);
  document.documentElement.style.setProperty('--ag','rgba('+th.rgb+',.3)');
  document.documentElement.style.setProperty('--ad','rgba('+th.rgb+',.1)');
  document.documentElement.style.setProperty('--sb','linear-gradient(135deg,rgba('+th.rgb+',.2),rgba('+th.rgb+',.08))');
  document.documentElement.style.setProperty('--sbb','rgba('+th.rgb+',.15)');
  renderThemeDots();
}
function renderThemeDots(){
  const c=document.getElementById('themeColors');if(!c)return;
  c.innerHTML=THEMES.map(t=>'<div class="theme-dot'+(t.id===curTheme?' sel':'')+'" style="background:'+t.color+'" onclick="setTheme(\''+t.id+'\')"></div>').join('');
}
const L={
  ru:{login:'Войти',register:'Регистрация',loginField:'Логин',passField:'Пароль',nameField:'Имя',avatarField:'Аватар',enterLogin:'Введите логин...',enterPass:'Введите пароль...',enterName:'Ваше имя...',onlyLetters:'Только буквы и цифры...',min4:'Минимум 4 символа...',doLogin:'Войти',doReg:'Зарегистрироваться',or:'или',anonChat:'🕶 Анонимный чат',nickname:'Ваш никнейм',enterNick:'Придумайте имя...',enterAnon:'Войти анонимно',lastLogin:'Последний вход:',fillAll:'Заполните все поля',min2:'Минимум 2 символа',offline:'ОФЛАЙН',online:'ОНЛАЙН',anon:'АНОНИМ',msg:'Сообщение...',idOrLogin:'ID или логин...',status:'СТАТУС',onlineList:'Онлайн',friends:'Друзья',groups:'Группы',search:'Поиск',setStatus:'Статус',copyId:'Копировать ID',whatsNew:'Что нового?',myProfile:'Мой профиль',logout:'Выйти',blocked:'ЗАБЛОКИРОВАННЫЕ',createGrp:'СОЗДАТЬ ГРУППУ',grpName:'Имя группы...',pickFriends:'ВЫБЕРИ ДРУЗЕЙ',create:'Создать',searchUsers:'ПОИСК ПОЛЬЗОВАТЕЛЕЙ',nameOrLogin:'Имя или логин...',friendLogin:'Логин друга...',connect:'Подключиться',connected:'Подключено к',notOnline:'не в сети',typing:'печатает...',achUnlocked:'ДОСТИЖЕНИЕ',messages:'Сообщений',days:'Дней',friendsN:'Друзей',experience:'ОПЫТ',games:'Игры',regDate:'Регистрация',lastVisit:'Последний визит',write:'Написать',addFriend:'В друзья',close:'Закрыть',achievements:'ДОСТИЖЕНИЯ',aboutMe:'О себе...',checkers:'ШАШКИ',yourTurn:'Ваш ход',oppTurn:'Ход соперника',resign:'Сдаться',resignConfirm:'Сдаться?',ckInviteSent:'Приглашение в шашки отправлено',ckInviteMsg:'приглашает в шашки!',accept:'Принять',gameOver:'ИГРА ОКОНЧЕНА',oppResigned:'Соперник сдался!',youWin:'Вы победили!',youLose:'Вы проиграли',games2:'Игры',rps:'Камень-Ножницы-Бумага',rpsDesc:'Классическая игра на удачу',checkersName:'Шашки',checkersDesc:'Стратегическая настольная игра',pickOpponent:'ВЫБЕРИ СОПЕРНИКА',noFriendsOnline:'Нет друзей онлайн',durakName:'Дурак',durakDesc:'Классическая карточная игра',youAttack:'Вы атакуете',youDefend:'Вы защищаетесь',takCards:'Забрать',donAtk:'Бита',throwMore:'Подкинуть',deckLeft:'Колода',trumpSuit:'Козырь',dkInviteSent:'Приглашение в Дурака отправлено',dkInviteMsg:'приглашает в Дурака!',sound:'Звук',justNow:'только что',minAgo:'мин назад',hAgo:'ч назад',dAgo:'д назад',tttName:'Крестики-нолики',tttDesc:'Классика на 3×3',tttInviteSent:'Приглашение в крестики-нолики',tttInviteMsg:'приглашает в крестики-нолики!',yourMark:'Вы',oppMark:'Соперник',draw:'Ничья!',shop:'Магазин',coins:'монет',premiumAvatars:'ПРЕМИУМ АВАТАРЫ',titles:'ТИТУЛЫ',boosts:'БУСТЫ',buySuccess:'Куплено!',notEnough:'Недостаточно монет',leaderboard:'Рейтинг',lbXP:'По XP',lbMsg:'Сообщения',lbWins:'Победы',lbCoins:'Монеты',lbEmpty:'Пусто',channels:'Каналы',chCreate:'Создать',chJoin:'Подписаться',chLeave:'Отписаться',chOwner:'автор',chMembers:'подписч.',chOnlyOwner:'Только автор может писать',chPost:'Опубликовать',social:'ОБЩЕНИЕ',entertainment:'РАЗВЛЕЧЕНИЯ',settings:'НАСТРОЙКИ',logout:'Выйти',wheel:'Колесо фортуны',wheelSpin:'КРУТИТЬ',wheelCooldown:'Следующий спин через',wheelMin:'мин',wheelWon:'Выигрыш!',wheelLost:'Пусто!',wheelJackpot:'ДЖЕКПОТ!',weatherLoading:'Загрузка...',petFeed:'Кормить',petPlay:'Играть',petAdopt:'Заведи питомца!',petNamePrompt:'Назови питомца:',petTap:'Нажми сюда',petChoose:'Выбери своего компаньона',petAdoptBtn:'Завести!',petHunger:'Голод',petHappy:'Радость',petMood:'Настр.',petPet:'Гладить',petFree:'Бесплатно',petMoodGreat:'Супер!',petMoodGood:'Хорошо',petMoodOk:'Норм',petMoodSad:'Грустно',petMoodCritical:'Критично!',petWash:'Купать',petSleep:'Спать',petTrick:'Трюк',petMenu:'Питомец',petEvo:'Эволюция',petFoodMenu:'ЕДА',petRoom:'Комната',petShop2:'Магазин',petBack:'Назад',petBowl:'Миска',petToy:'Игрушка',petLamp:'Лампа',petPlant:'Растение',petRug:'Коврик',petBed:'Кровать',petAqua:'Аквариум',petHouse:'Домик',petSickMsg:'Питомец заболел!',petHeal:'Лечить',petClothes:'Одежда',petHats:'ШАПКИ',petCostumes:'КОСТЮМЫ',petRemoveAll:'Снять всё'},
  en:{login:'Login',register:'Register',loginField:'Login',passField:'Password',nameField:'Name',avatarField:'Avatar',enterLogin:'Enter login...',enterPass:'Enter password...',enterName:'Your name...',onlyLetters:'Letters and numbers...',min4:'Min 4 characters...',doLogin:'Sign In',doReg:'Register',or:'or',anonChat:'🕶 Anonymous chat',nickname:'Your nickname',enterNick:'Choose name...',enterAnon:'Enter anonymously',lastLogin:'Last login:',fillAll:'Fill all fields',min2:'Min 2 characters',offline:'OFFLINE',online:'ONLINE',anon:'ANON',msg:'Message...',idOrLogin:'ID or login...',status:'STATUS',onlineList:'Online',friends:'Friends',groups:'Groups',search:'Search',setStatus:'Status',copyId:'Copy ID',whatsNew:'What\'s new?',myProfile:'My Profile',logout:'Log out',blocked:'BLOCKED',createGrp:'CREATE GROUP',grpName:'Group name...',pickFriends:'PICK FRIENDS',create:'Create',searchUsers:'SEARCH USERS',nameOrLogin:'Name or login...',friendLogin:'Friend login...',connect:'Connect',connected:'Connected to',notOnline:'is offline',typing:'typing...',achUnlocked:'ACHIEVEMENT',messages:'Messages',days:'Days',friendsN:'Friends',experience:'XP',games:'Games',regDate:'Registered',lastVisit:'Last visit',write:'Message',addFriend:'Add friend',close:'Close',achievements:'ACHIEVEMENTS',aboutMe:'About me...',checkers:'CHECKERS',yourTurn:'Your turn',oppTurn:'Opponent\'s turn',resign:'Resign',resignConfirm:'Resign?',ckInviteSent:'Checkers invite sent',ckInviteMsg:'invites you to checkers!',accept:'Accept',gameOver:'GAME OVER',oppResigned:'Opponent resigned!',youWin:'You won!',youLose:'You lost',games2:'Games',rps:'Rock-Paper-Scissors',rpsDesc:'Classic luck game',checkersName:'Checkers',checkersDesc:'Strategy board game',pickOpponent:'PICK OPPONENT',noFriendsOnline:'No friends online',durakName:'Durak',durakDesc:'Classic Russian card game',youAttack:'You attack',youDefend:'You defend',takCards:'Take',donAtk:'Done',throwMore:'Throw',deckLeft:'Deck',trumpSuit:'Trump',dkInviteSent:'Durak invite sent',dkInviteMsg:'invites you to Durak!',sound:'Sound',justNow:'just now',minAgo:'min ago',hAgo:'h ago',dAgo:'d ago',tttName:'Tic-Tac-Toe',tttDesc:'Classic 3×3 game',tttInviteSent:'Tic-tac-toe invite sent',tttInviteMsg:'invites you to tic-tac-toe!',yourMark:'You',oppMark:'Opponent',draw:'Draw!',shop:'Shop',coins:'coins',premiumAvatars:'PREMIUM AVATARS',titles:'TITLES',boosts:'BOOSTS',buySuccess:'Purchased!',notEnough:'Not enough coins',leaderboard:'Leaderboard',lbXP:'By XP',lbMsg:'Messages',lbWins:'Wins',lbCoins:'Coins',lbEmpty:'Empty',channels:'Channels',chCreate:'Create',chJoin:'Subscribe',chLeave:'Unsubscribe',chOwner:'owner',chMembers:'subs',chOnlyOwner:'Only owner can post',chPost:'Publish',social:'SOCIAL',entertainment:'ENTERTAINMENT',settings:'SETTINGS',logout:'Logout',wheel:'Fortune Wheel',wheelSpin:'SPIN',wheelCooldown:'Next spin in',wheelMin:'min',wheelWon:'You won!',wheelLost:'Nothing!',wheelJackpot:'JACKPOT!',weatherLoading:'Loading...',petFeed:'Feed',petPlay:'Play',petAdopt:'Adopt a pet!',petNamePrompt:'Name your pet:',petTap:'Tap here',petChoose:'Choose your companion',petAdoptBtn:'Adopt!',petHunger:'Hunger',petHappy:'Happy',petMood:'Mood',petPet:'Pet',petFree:'Free',petMoodGreat:'Great!',petMoodGood:'Good',petMoodOk:'Okay',petMoodSad:'Sad',petMoodCritical:'Critical!',petWash:'Wash',petSleep:'Sleep',petTrick:'Trick',petMenu:'Pet',petEvo:'Evolution',petFoodMenu:'FOOD',petRoom:'Room',petShop2:'Shop',petBack:'Back',petBowl:'Bowl',petToy:'Toy',petLamp:'Lamp',petPlant:'Plant',petRug:'Rug',petBed:'Bed',petAqua:'Aquarium',petHouse:'House',petSickMsg:'Your pet is sick!',petHeal:'Heal',petClothes:'Clothes',petHats:'HATS',petCostumes:'COSTUMES',petRemoveAll:'Remove all'},
  az:{login:'Daxil ol',register:'Qeydiyyat',loginField:'Login',passField:'Şifrə',nameField:'Ad',avatarField:'Avatar',enterLogin:'Login daxil edin...',enterPass:'Şifrə daxil edin...',enterName:'Adınız...',onlyLetters:'Hərf və rəqəmlər...',min4:'Minimum 4 simvol...',doLogin:'Daxil ol',doReg:'Qeydiyyatdan keç',or:'və ya',anonChat:'🕶 Anonim çat',nickname:'Ləqəbiniz',enterNick:'Ad seçin...',enterAnon:'Anonim daxil ol',lastLogin:'Son giriş:',fillAll:'Bütün sahələri doldurun',min2:'Minimum 2 simvol',offline:'OFFLAYn',online:'ONLAYN',anon:'ANONİM',msg:'Mesaj...',idOrLogin:'ID və ya login...',status:'STATUS',onlineList:'Onlayn',friends:'Dostlar',groups:'Qruplar',search:'Axtar',setStatus:'Status',copyId:'ID kopyala',whatsNew:'Yeniliklər',myProfile:'Profilim',logout:'Çıxış',blocked:'BLOKLANMIŞ',createGrp:'QRUP YARAT',grpName:'Qrup adı...',pickFriends:'DOST SEÇ',create:'Yarat',searchUsers:'İSTİFADƏÇİ AXTAR',nameOrLogin:'Ad və ya login...',friendLogin:'Dost logini...',connect:'Qoşul',connected:'Qoşuldu:',notOnline:'onlayn deyil',typing:'yazır...',achUnlocked:'NAİLİYYƏT',messages:'Mesaj',days:'Gün',friendsN:'Dost',experience:'XP',games:'Oyun',regDate:'Qeydiyyat',lastVisit:'Son giriş',write:'Yaz',addFriend:'Dost əlavə et',close:'Bağla',achievements:'NAİLİYYƏTLƏR',aboutMe:'Haqqında...',checkers:'DAMA',yourTurn:'Sizin növbə',oppTurn:'Rəqibin növbəsi',resign:'Təslim ol',resignConfirm:'Təslim olursan?',ckInviteSent:'Dama dəvəti göndərildi',ckInviteMsg:'sizi damaya dəvət edir!',accept:'Qəbul et',gameOver:'OYUN BİTDİ',oppResigned:'Rəqib təslim oldu!',youWin:'Siz qazandınız!',youLose:'Siz uduzudunuz',games2:'Oyunlar',rps:'Daş-Kağız-Qayçı',rpsDesc:'Klassik şans oyunu',checkersName:'Dama',checkersDesc:'Strateji masa oyunu',pickOpponent:'RƏQİB SEÇ',noFriendsOnline:'Onlayn dost yoxdur',durakName:'Durak',durakDesc:'Klassik kart oyunu',youAttack:'Siz hücum edirsiniz',youDefend:'Siz müdafiə edirsiniz',takCards:'Götür',donAtk:'Bitdi',throwMore:'At',deckLeft:'Dəstə',trumpSuit:'Kozır',dkInviteSent:'Durak dəvəti göndərildi',dkInviteMsg:'sizi Duraka dəvət edir!',sound:'Səs',justNow:'indicə',minAgo:'dəq əvvəl',hAgo:'saat əvvəl',dAgo:'gün əvvəl',tttName:'X və O',tttDesc:'Klassik 3×3 oyun',tttInviteSent:'X və O dəvəti göndərildi',tttInviteMsg:'sizi X və O oyununa dəvət edir!',yourMark:'Siz',oppMark:'Rəqib',draw:'Heç-heçə!',shop:'Mağaza',coins:'sikkə',premiumAvatars:'PREMİUM AVATARLAR',titles:'TİTULLAR',boosts:'BUSTLAR',buySuccess:'Alındı!',notEnough:'Kifayət qədər sikkə yoxdur',leaderboard:'Reytinq',lbXP:'XP üzrə',lbMsg:'Mesajlar',lbWins:'Qələbələr',lbCoins:'Sikkələr',lbEmpty:'Boşdur',channels:'Kanallar',chCreate:'Yarat',chJoin:'Abunə ol',chLeave:'Abunəni ləğv et',chOwner:'müəllif',chMembers:'abunəçi',chOnlyOwner:'Yalnız müəllif yaza bilər',chPost:'Dərc et',social:'ÜNSIYYƏT',entertainment:'ƏYLƏNCƏ',settings:'TƏNZIMLƏMƏLƏR',logout:'Çıxış',wheel:'Şans çarxı',wheelSpin:'FIRLA',wheelCooldown:'Növbəti fırlanma',wheelMin:'dəq',wheelWon:'Qazandın!',wheelLost:'Boş!',wheelJackpot:'CEKPOT!',weatherLoading:'Yüklənir...',petFeed:'Yedirt',petPlay:'Oyna',petAdopt:'Heyvan saxla!',petNamePrompt:'Heyvanın adı:',petTap:'Bura bas',petChoose:'Yoldaşını seç',petAdoptBtn:'Saxla!',petHunger:'Aclıq',petHappy:'Xoşbəxt',petMood:'Əhval',petPet:'Sığal',petFree:'Pulsuz',petMoodGreat:'Əla!',petMoodGood:'Yaxşı',petMoodOk:'Normal',petMoodSad:'Kədərli',petMoodCritical:'Kritik!',petWash:'Yu',petSleep:'Yat',petTrick:'Hünər',petMenu:'Heyvan',petEvo:'Təkamül',petFoodMenu:'YEMƏK',petRoom:'Otaq',petShop2:'Mağaza',petBack:'Geri',petBowl:'Qab',petToy:'Oyuncaq',petLamp:'Lampa',petPlant:'Bitki',petRug:'Xalça',petBed:'Yataq',petAqua:'Akvarium',petHouse:'Ev',petSickMsg:'Heyvan xəstədir!',petHeal:'Müalicə',petClothes:'Paltar',petHats:'PAPAQLAR',petCostumes:'KOSTÜMLƏR',petRemoveAll:'Hamısını çıxar'}
};
const ACHS=[
  {id:'first_msg',icon:'💬',name:{ru:'Первое слово',en:'First Word',az:'İlk söz'}},
  {id:'msg_100',icon:'📝',name:{ru:'Болтун',en:'Chatterbox',az:'Danışqan'}},
  {id:'msg_1000',icon:'🗣',name:{ru:'Оратор',en:'Orator',az:'Natiq'}},
  {id:'lvl5',icon:'⭐',name:{ru:'Опытный',en:'Experienced',az:'Təcrübəli'}},
  {id:'lvl10',icon:'👑',name:{ru:'Легенда',en:'Legend',az:'Əfsanə'}},
  {id:'first_friend',icon:'🤝',name:{ru:'Дружба',en:'Friendship',az:'Dostluq'}},
  {id:'friends_10',icon:'👥',name:{ru:'Популярный',en:'Popular',az:'Populyar'}},
  {id:'first_win',icon:'🎲',name:{ru:'Победитель',en:'Winner',az:'Qalib'}},
  {id:'wins_10',icon:'🏆',name:{ru:'Чемпион',en:'Champion',az:'Çempion'}},
  {id:'week_old',icon:'📅',name:{ru:'Старожил',en:'Veteran',az:'Köhnə sakin'}},
  {id:'month_old',icon:'🗓',name:{ru:'Долгожитель',en:'Long-timer',az:'Uzunömürlü'}},
  {id:'bio_set',icon:'✏️',name:{ru:'Личность',en:'Personality',az:'Şəxsiyyət'}}
];
function t(key){return L[curLang]?.[key]||L.ru[key]||key}
function setLang(lang){curLang=lang;localStorage.setItem('kLang',lang);applyLang();document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('on',b.textContent===lang.toUpperCase()))}
function applyLang(){
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('on',b.textContent===curLang.toUpperCase()));
  const $=id=>document.getElementById(id);
  if($('lU'))$('lU').placeholder=t('enterLogin');if($('lP'))$('lP').placeholder=t('enterPass');
  if($('rN'))$('rN').placeholder=t('enterName');if($('rU'))$('rU').placeholder=t('onlyLetters');if($('rP'))$('rP').placeholder=t('min4');
  if($('gN'))$('gN').placeholder=t('enterNick');if($('mI'))$('mI').placeholder=t('msg');if($('pId'))$('pId').placeholder=t('idOrLogin');
  if($('searchI'))$('searchI').placeholder=t('nameOrLogin');if($('addFI'))$('addFI').placeholder=t('friendLogin');
  if($('grpName'))$('grpName').placeholder=t('grpName');
  const mi=document.getElementById('menuItems');
  if(mi){
    const mc=document.getElementById('menuCoins');if(mc)mc.textContent='🪙 '+myCoins+' '+t('coins');
    const lo=document.getElementById('menuLogout');if(lo)lo.textContent=t('logout')||'Выйти';
    let h='';
    h+='<div class="menu-section">'+(t('social')||'ОБЩЕНИЕ')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'oP\')"><span class="mi-icon">👥</span> '+t('onlineList')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'fP\')"><span class="mi-icon">👫</span> '+t('friends')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'gP\')"><span class="mi-icon">💬</span> '+t('groups')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'chP\')"><span class="mi-icon">📢</span> '+t('channels')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'sP\')"><span class="mi-icon">🔍</span> '+t('search')+'</div>';
    h+='<div class="menu-divider"></div>';
    h+='<div class="menu-section">'+(t('entertainment')||'РАЗВЛЕЧЕНИЯ')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();openGames()"><span class="mi-icon">🎮</span> '+t('games2')+'<span class="mi-badge">5</span></div>';
    h+='<div class="menu-item" onclick="toggleMenu();openWheel()"><span class="mi-icon">🎰</span> '+t('wheel')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();openPetFromMenu()"><span class="mi-icon">🐾</span> '+(t('petMenu')||'Питомец')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();openShop()"><span class="mi-icon">🛒</span> '+t('shop')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();openLB()"><span class="mi-icon">🏆</span> '+t('leaderboard')+'</div>';
    h+='<div class="menu-divider"></div>';
    h+='<div class="menu-section">'+(t('settings')||'НАСТРОЙКИ')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();toggleP(\'stP\')"><span class="mi-icon">⚡</span> '+t('setStatus')+'</div>';
    h+='<div class="menu-item" onclick="toggleSound()"><span class="mi-icon">'+(soundOn?'🔔':'🔕')+'</span> '+t('sound')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();showProfile(myId)"><span class="mi-icon">👤</span> '+t('myProfile')+'</div>';
    h+='<div class="menu-divider"></div>';
    h+='<div class="menu-item" onclick="toggleMenu();cpId()"><span class="mi-icon">📋</span> '+t('copyId')+'</div>';
    h+='<div class="menu-item" onclick="toggleMenu();showUpdate()"><span class="mi-icon">🔄</span> '+t('whatsNew')+'</div>';
    mi.innerHTML=h;
  }
}
function toggleSound(){soundOn=!soundOn;localStorage.setItem('kSound',soundOn?'on':'off');applyLang()}
function openShop(){
  if(ws)ws.send(JSON.stringify({type:'get_coins'}));
  const md=document.getElementById('shopModal');
  let h='<div class="shop-title">🛒 '+t('shop')+'</div>';
  h+='<div class="shop-coins">🪙 '+myCoins+' '+t('coins')+'</div>';
  h+='<div class="shop-section">'+t('premiumAvatars')+'</div><div class="shop-grid">';
  [['av_dragon','🐉','Dragon',50],['av_phoenix','🦅','Phoenix',50],['av_robot','🤖','Robot',80],['av_alien','👽','Alien',80],['av_ghost','👻','Ghost',100],['av_crown','👸','Crown',150],['av_devil','😈','Devil',150],['av_skull','💀','Skull',200]].forEach(([id,icon,name,price])=>{
    h+='<div class="shop-item" onclick="shopBuy(\''+id+'\')"><div class="si-icon">'+icon+'</div><div class="si-name">'+name+'</div><div class="si-price">🪙 '+price+'</div></div>';
  });
  h+='</div>';
  h+='<div class="shop-section">'+t('titles')+'</div><div class="shop-grid">';
  [['title_pro','⚡','PRO',100],['title_vip','💎','VIP',200],['title_og','🔥','OG',300]].forEach(([id,icon,name,price])=>{
    h+='<div class="shop-item" onclick="shopBuy(\''+id+'\')"><div class="si-icon">'+icon+'</div><div class="si-name">'+name+'</div><div class="si-price">🪙 '+price+'</div></div>';
  });
  h+='</div>';
  h+='<div class="shop-section">'+t('boosts')+'</div><div class="shop-grid">';
  h+='<div class="shop-item" onclick="shopBuy(\'coins_xp50\')"><div class="si-icon">✨</div><div class="si-name">+50 XP</div><div class="si-price">🪙 30</div></div>';
  h+='<div class="shop-item" onclick="shopBuy(\'coins_xp200\')"><div class="si-icon">💫</div><div class="si-name">+200 XP</div><div class="si-price">🪙 100</div></div>';
  h+='</div>';
  h+='<div style="text-align:center;margin-top:12px"><button class="mini-btn" onclick="document.getElementById(\'shopBg\').classList.remove(\'show\')">'+t('close')+'</button></div>';
  md.innerHTML=h;
  document.getElementById('shopBg').classList.add('show');
}
function shopBuy(itemId){if(!ws)return;ws.send(JSON.stringify({type:'shop_buy',itemId}))}

// === FORTUNE WHEEL ===
let wheelSpinning=false,wheelAngle=0;
const WHEEL_SEGMENTS=[
  {label:'🪙5',color:'#1a3a2a',tcolor:'#00e5a0'},
  {label:'✨10',color:'#1a1a3a',tcolor:'#a78bfa'},
  {label:'🪙10',color:'#1a3a2a',tcolor:'#00e5a0'},
  {label:'💀0',color:'#2a1a1a',tcolor:'#666'},
  {label:'🪙25',color:'#1a3a2a',tcolor:'#00e5a0'},
  {label:'✨25',color:'#1a1a3a',tcolor:'#a78bfa'},
  {label:'🪙50',color:'#2a3a1a',tcolor:'#fbbf24'},
  {label:'✨50',color:'#1a1a3a',tcolor:'#a78bfa'},
  {label:'🪙100',color:'#3a2a0a',tcolor:'#fbbf24'},
  {label:'🎁ALL',color:'#3a1a2a',tcolor:'#f472b6'},
];
function drawWheel(angle){
  const c=document.getElementById('wheelCvs');if(!c)return;
  const ctx=c.getContext('2d');const cx=120,cy=120,r=115;
  c.width=240;c.height=240;
  const seg=WHEEL_SEGMENTS.length;const arc=2*Math.PI/seg;
  ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);
  for(let i=0;i<seg;i++){
    const a=i*arc;
    ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,r,a,a+arc);ctx.closePath();
    ctx.fillStyle=WHEEL_SEGMENTS[i].color;ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=1;ctx.stroke();
    ctx.save();ctx.rotate(a+arc/2);ctx.textAlign='center';ctx.fillStyle=WHEEL_SEGMENTS[i].tcolor;ctx.font='bold 13px "Space Mono",monospace';ctx.fillText(WHEEL_SEGMENTS[i].label,r*0.62,5);ctx.restore();
  }
  ctx.restore();
  // outer ring glow
  ctx.beginPath();ctx.arc(cx,cy,r,0,2*Math.PI);ctx.strokeStyle='rgba(0,229,160,.15)';ctx.lineWidth=2;ctx.stroke();
}
function openWheel(){
  const md=document.getElementById('wheelModal');
  let h='<div class="wheel-title">🎰 '+t('wheel')+'</div>';
  h+='<div class="wheel-container"><div class="wheel-pointer">▼</div><canvas id="wheelCvs" class="wheel-canvas" width="240" height="240"></canvas><div class="wheel-center" onclick="spinWheel()">🎰</div></div>';
  h+='<div class="wheel-result" id="wheelRes"></div>';
  h+='<div class="wheel-info" id="wheelInfo">'+t('wheelCooldown')+': 1h</div>';
  h+='<div style="margin-top:8px"><button class="mini-btn" onclick="document.getElementById(\'wheelBg\').classList.remove(\'show\')">'+t('close')+'</button></div>';
  md.innerHTML=h;
  document.getElementById('wheelBg').classList.add('show');
  setTimeout(()=>drawWheel(wheelAngle),50);
}
function spinWheel(){
  if(wheelSpinning||!ws)return;
  wheelSpinning=true;
  document.getElementById('wheelRes').textContent='...';
  ws.send(JSON.stringify({type:'spin_wheel'}));
}
function animateWheel(targetIdx){
  const seg=WHEEL_SEGMENTS.length;const arc=2*Math.PI/seg;
  // Spin 5+ full rotations + land on target segment
  const spins=5+Math.random()*3;
  const targetAngle=-(targetIdx*arc+arc/2)+Math.PI/2;// point to top
  const finalAngle=spins*2*Math.PI+targetAngle;
  const c=document.getElementById('wheelCvs');if(!c)return;
  const start=wheelAngle;const diff=finalAngle-start;
  let startTime=null;const duration=4000;
  function tick(ts){
    if(!startTime)startTime=ts;
    const p=Math.min((ts-startTime)/duration,1);
    // ease out cubic
    const ease=1-Math.pow(1-p,3);
    wheelAngle=start+diff*ease;
    drawWheel(wheelAngle);
    if(p<1)requestAnimationFrame(tick);
    else wheelSpinning=false;
  }
  requestAnimationFrame(tick);
}

// === CHANNELS ===
let channelsList=[];
function renderChannels(){
  const el=document.getElementById('chList');if(!el)return;
  el.innerHTML='';
  if(channelsList.length===0){el.innerHTML='<div style="text-align:center;color:var(--td);font-size:.72rem;padding:8px">📢 '+t('lbEmpty')+'</div>';return}
  channelsList.forEach(ch=>{
    const d=document.createElement('div');d.className='ch-row';
    d.innerHTML='<span class="ch-av">'+(ch.avatar||'📢')+'</span><span class="ch-nm">'+ch.name+(ch.isOwner?' <span class="ch-owner">'+t('chOwner')+'</span>':'')+'</span><span class="ch-cnt">👤 '+ch.members+'</span>';
    d.onclick=()=>openChannel(ch.id,ch.name,ch.avatar,ch.isOwner);
    el.appendChild(d);
  });
}
function openChannel(id,name,avatar,isOwner){
  ensureChat(id,name,avatar||'📢',false);
  chats[id].isChannel=true;
  chats[id].isOwner=isOwner;
  switchChat(id);
  if(ws)ws.send(JSON.stringify({type:'channel_history',channelId:id}));
}
function createCh(){
  const inp=document.getElementById('chNameI');if(!inp||!inp.value.trim()||!ws)return;
  ws.send(JSON.stringify({type:'create_channel',name:inp.value.trim()}));
  inp.value='';
}
function searchCh(){
  const inp=document.getElementById('chSearchI');if(!inp||!ws)return;
  const q=inp.value.trim();
  if(q.length<1){document.getElementById('chSearchR').innerHTML='';return}
  ws.send(JSON.stringify({type:'search_channels',query:q}));
}
function joinCh(id){if(!ws)return;ws.send(JSON.stringify({type:'join_channel',channelId:id}))}
function leaveCh(id){if(!ws)return;ws.send(JSON.stringify({type:'leave_channel',channelId:id}))}
function renderChSearch(channels){
  const el=document.getElementById('chSearchR');if(!el)return;
  el.innerHTML='';
  const myIds=channelsList.map(c=>c.id);
  channels.forEach(ch=>{
    const isMember=myIds.includes(ch.id);
    const d=document.createElement('div');d.className='ch-row';
    d.innerHTML='<span class="ch-av">'+(ch.avatar||'📢')+'</span><span class="ch-nm">'+ch.name+'</span><span class="ch-cnt">👤 '+ch.members+'</span>'+(isMember?'<span class="ch-badge">✓</span>':'<button class="mini-btn" onclick="event.stopPropagation();joinCh(\''+ch.id+'\')">'+t('chJoin')+'</button>');
    el.appendChild(d);
  });
}

// === LEADERBOARD ===
let lbData=null,lbTab='xp';
function openLB(){if(!ws)return;ws.send(JSON.stringify({type:'get_leaderboard'}));document.getElementById('lbBg').classList.add('show');renderLB()}
function renderLB(){
  const md=document.getElementById('lbModal');
  let h='<div class="lb-title">🏆 '+t('leaderboard')+'</div>';
  h+='<div class="lb-tabs">';
  [['xp',t('lbXP')],['messages',t('lbMsg')],['wins',t('lbWins')],['coins',t('lbCoins')]].forEach(([id,lbl])=>{
    h+='<div class="lb-tab'+(lbTab===id?' active':'')+'" onclick="lbTab=\''+id+'\';renderLB()">'+lbl+'</div>';
  });
  h+='</div>';
  if(!lbData){h+='<div style="text-align:center;color:var(--td);padding:20px;font-size:.78rem">⏳...</div>';md.innerHTML=h;return}
  const list=lbData[lbTab]||[];
  if(list.length===0){h+='<div style="text-align:center;color:var(--td);padding:20px;font-size:.78rem">'+t('lbEmpty')+'</div>';md.innerHTML=h;return}
  const medals=['🥇','🥈','🥉'];
  list.forEach((u,i)=>{
    const isMe=u.id===myId;
    const rankCls=i===0?' gold':i===1?' silver':i===2?' bronze':'';
    h+='<div class="lb-row'+(isMe?' me':'')+'" onclick="showProfile(\''+u.id+'\')">';
    h+='<div class="lb-rank'+rankCls+'">'+(i<3?medals[i]:(i+1))+'</div>';
    h+='<div class="lb-av">'+(u.avatar||'🐱')+'</div>';
    h+='<div class="lb-name">'+u.name+(isMe?' ⭐':'')+'</div>';
    let val='';
    if(lbTab==='xp')val=u.xp+' XP <span class="lvl-badge" style="margin-left:4px">LV'+u.level+'</span>';
    else if(lbTab==='messages')val='💬 '+u.count;
    else if(lbTab==='wins')val='🏆 '+u.count;
    else if(lbTab==='coins')val='🪙 '+u.count;
    h+='<div class="lb-val">'+val+'</div>';
    h+='</div>';
  });
  h+='<div style="text-align:center;margin-top:10px"><button class="mini-btn" onclick="document.getElementById(\'lbBg\').classList.remove(\'show\')">'+t('close')+'</button></div>';
  md.innerHTML=h;
}

// === AI BOT ===
const AI_RESPONSES={
  help:{ru:'🤖 Команды бота:\n/ai help — список команд\n/ai joke — случайная шутка\n/ai fact — интересный факт\n/ai quote — цитата\n/ai flip — подбросить монетку\n/ai 8ball — магический шар\n/ai dice — бросить кубик\n/ai time — текущее время\n/ai math 2+2 — калькулятор\n/ai fortune — предсказание',en:'🤖 Commands:\n/ai help — command list\n/ai joke — random joke\n/ai fact — fun fact\n/ai quote — quote\n/ai flip — coin flip\n/ai 8ball — magic ball\n/ai dice — roll dice\n/ai time — current time\n/ai math 2+2 — calculator\n/ai fortune — fortune',az:'🤖 Əmrlər:\n/ai help — əmrlər siyahısı\n/ai joke — zarafat\n/ai fact — maraqlı fakt\n/ai quote — sitat\n/ai flip — sikkə at\n/ai 8ball — sehrli kürə\n/ai dice — zar at\n/ai time — vaxt\n/ai math 2+2 — kalkulyator\n/ai fortune — falçılıq'},
};
const JOKES={ru:['Почему программист носит очки? Потому что не видит C#','Что сказал буфер? Дай мне минутку...','— Алло, это прачечная?\n— Нет, это программист.\n— А почему у вас всё зависло?','Код работает — не трогай!','Кофе — это жидкость, которая превращается в код'],en:['Why do programmers wear glasses? Because they can\'t C#','A SQL query walks into a bar and sees two tables. "Can I join you?"','There are 10 types of people: those who understand binary and those who don\'t','It works on my machine!','Coffee: liquid that turns into code'],az:['Proqramçı niyə eynək taxır? Çünki C# görə bilmir','Kodda 2 problem var: 1) İşləmir 2) Niyə işlədiyini bilmirsən','Kofedən proqrama — ən gözəl çevrilmə']};
const FACTS={ru:['Мёд не портится тысячелетиями','Осьминог имеет три сердца','Молния в 5 раз горячее Солнца','Клубника — не ягода, а орех','Бананы — это ягоды'],en:['Honey never spoils','An octopus has three hearts','Lightning is 5x hotter than the Sun','Strawberries aren\'t berries, but bananas are','A group of flamingos is called a "flamboyance"'],az:['Bal heç vaxt xarab olmur','Ahtapotun 3 ürəyi var','İldırım Günəşdən 5 dəfə istidir']};
const QUOTES={ru:['«Будь собой, все остальные роли заняты» — О. Уайльд','«Единственный способ делать великую работу — любить то, что делаешь» — С. Джобс','«Код — это поэзия» — неизвестный программист'],en:['"Be yourself; everyone else is taken" — O. Wilde','"The only way to do great work is to love what you do" — S. Jobs','"Code is poetry" — unknown dev'],az:['"Özün ol, digər rollar tutulub" — O. Uayld','"Böyük iş görmək üçün sevməlisən" — S. Cobs']};
const FORTUNES={ru:['🔮 Сегодня удачный день для кода','🔮 Жди неожиданное сообщение','🔮 Звёзды говорят: обнови зависимости','🔮 Тебя ждёт приятный сюрприз','🔮 Не забудь сделать коммит'],en:['🔮 Today is a great day for coding','🔮 Expect an unexpected message','🔮 Stars say: update your dependencies','🔮 A pleasant surprise awaits','🔮 Don\'t forget to commit'],az:['🔮 Bu gün kod üçün yaxşı gündür','🔮 Gözlənilməz mesaj gözlə','🔮 Ulduzlar deyir: yenilə']};
const BALL={ru:['🎱 Да','🎱 Нет','🎱 Определённо','🎱 Спроси позже','🎱 Не рассчитывай','🎱 Возможно','🎱 Без сомнений','🎱 Лучше не знать'],en:['🎱 Yes','🎱 No','🎱 Definitely','🎱 Ask later','🎱 Don\'t count on it','🎱 Maybe','🎱 Without a doubt','🎱 Better not tell'],az:['🎱 Bəli','🎱 Xeyr','🎱 Mütləq','🎱 Sonra soruş','🎱 Bəlkə']};
function randArr(a){return a[Math.floor(Math.random()*a.length)]}
function handleAI(text){
  const cmd=text.replace(/^\/ai\s*/i,'').trim().toLowerCase();
  const lang=curLang;
  if(!cmd||cmd==='help')return AI_RESPONSES.help[lang]||AI_RESPONSES.help.ru;
  if(cmd==='joke')return'😄 '+randArr(JOKES[lang]||JOKES.ru);
  if(cmd==='fact')return'🧠 '+randArr(FACTS[lang]||FACTS.ru);
  if(cmd==='quote')return'💬 '+randArr(QUOTES[lang]||QUOTES.ru);
  if(cmd==='fortune')return randArr(FORTUNES[lang]||FORTUNES.ru);
  if(cmd==='flip')return Math.random()>.5?'🪙 '+(lang==='ru'?'Орёл!':lang==='az'?'Üz!':'Heads!'):'🪙 '+(lang==='ru'?'Решка!':lang==='az'?'Yazı!':'Tails!');
  if(cmd==='8ball')return randArr(BALL[lang]||BALL.ru);
  if(cmd==='dice'){const d=Math.floor(Math.random()*6)+1;return'🎲 '+d}
  if(cmd==='time')return'🕐 '+new Date().toLocaleTimeString();
  if(cmd.startsWith('math ')){try{const expr=cmd.substring(5);const r=Function('"use strict";return ('+expr.replace(/[^0-9+\-*/.()% ]/g,'')+')')();return'🔢 '+expr+' = '+r}catch(e){return'❌ Error'}}
  return'🤖 '+(lang==='ru'?'Не понял. /ai help':lang==='az'?'Başa düşmədim. /ai help':'Unknown command. /ai help');
}
function showAchToast(ids){
  ids.forEach((id,i)=>{
    const a=ACHS.find(x=>x.id===id);if(!a)return;
    setTimeout(()=>{
      document.getElementById('achToastLbl').textContent='🏅 '+t('achUnlocked');
      document.getElementById('achToastIcon').textContent=a.icon;
      document.getElementById('achToastName').textContent=a.name[curLang]||a.name.ru;
      document.getElementById('achToast').classList.add('show');
      setTimeout(()=>document.getElementById('achToast').classList.remove('show'),3000);
    },i*3500);
  });
}
let ws,myId,myName,myAvatar='🐱',myStatus='',myXP=0,myLevel=1,myCoins=0,isG=false,isDark=true;
let activeChat=null,friendsList=[],groupsList=[],blockList=[];
const chats={},mE={},polls={};
let tto,mRec,aCh=[],isRec=false,rTgt,regAv='🐱',grpSel=new Set();
let replyToId=null,replyToText=null;
const ax=new(window.AudioContext||window.webkitAudioContext)();
let soundOn=localStorage.getItem('kSound')!=='off';
function bp(f,d){if(!soundOn)return;try{const o=ax.createOscillator(),g=ax.createGain();o.connect(g);g.connect(ax.destination);o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(.1,ax.currentTime);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+d);o.start();o.stop(ax.currentTime+d)}catch(e){}}
function sS(){bp(880,.1)}function sR2(){bp(660,.12);setTimeout(()=>bp(880,.1),100)}function sC(){bp(523,.1);setTimeout(()=>bp(659,.1),120);setTimeout(()=>bp(784,.15),240)}
function stab(t){document.getElementById('tL').classList.toggle('on',t==='l');document.getElementById('tR').classList.toggle('on',t==='r');document.getElementById('fL').style.display=t==='l'?'':'none';document.getElementById('fR').style.display=t==='r'?'':'none';document.getElementById('aErr').textContent=''}
function initAP(){const c=document.getElementById('regAP');AVS.forEach(a=>{const d=document.createElement('div');d.className='av-opt'+(a==='🐱'?' sel':'');d.textContent=a;d.onclick=()=>{c.querySelectorAll('.av-opt').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');regAv=a};c.appendChild(d)})}
function toggleP(id){const el=document.getElementById(id);if(el.classList.contains('show')){el.classList.remove('show')}else{document.querySelectorAll('.panel.show').forEach(p=>p.classList.remove('show'));el.classList.add('show')}}
function showUpdate(){fetch(API+'/changelog').then(r=>r.json()).then(d=>{document.getElementById('modalTitle').textContent='🔄 Что нового?';document.getElementById('modalText').textContent=d.changelog||'';document.getElementById('modalBg').classList.add('show')}).catch(()=>{})}
function updateXP(){const c=XPL[myLevel-1]||0,n=XPL[myLevel]||XPL[XPL.length-1];const p=Math.min(100,((myXP-c)/(n-c))*100);document.getElementById('xpFill').style.width=p+'%';document.getElementById('xpTxt').textContent=myXP+' XP';document.getElementById('xpNext').textContent='→ '+n+' XP';document.getElementById('menuLvl').textContent='LVL '+myLevel}
function cwss(onO){ws=new WebSocket(WS);ws.onopen=onO;ws.onmessage=e=>{try{handle(JSON.parse(e.data))}catch(er){console.error(er)}};ws.onclose=()=>{if(myId)setTimeout(reconn,3000)};ws.onerror=()=>{document.getElementById('aErr').textContent='Ошибка сервера'}}
function reconn(){cwss(()=>{if(isG)ws.send(JSON.stringify({type:'guest_login',nickname:myName}));else{const s=localStorage.getItem('kc');if(s){const c=JSON.parse(s);ws.send(JSON.stringify({type:'auth_login',login:c.l,password:c.p}))}}})}
function doLogin(){const l=document.getElementById('lU').value.trim(),p=document.getElementById('lP').value;if(!l||!p)return se(t('fillAll'));cwss(()=>{ws.send(JSON.stringify({type:'auth_login',login:l,password:p}));localStorage.setItem('kc',JSON.stringify({l,p}))})}
function doReg(){const n=document.getElementById('rN').value.trim(),l=document.getElementById('rU').value.trim(),p=document.getElementById('rP').value;if(!l||!p)return se(t('fillAll'));cwss(()=>{ws.send(JSON.stringify({type:'auth_register',login:l,password:p,displayName:n||l,avatar:regAv}));localStorage.setItem('kc',JSON.stringify({l,p}))})}
function doGuest(){const n=document.getElementById('gN').value.trim();if(!n||n.length<2)return se(t('min2'));cwss(()=>ws.send(JSON.stringify({type:'guest_login',nickname:n})))}
function se(t){document.getElementById('aErr').textContent=t}
function quickL(){const s=JSON.parse(localStorage.getItem('kc'));if(s){document.getElementById('lU').value=s.l;doLogin()}}
function doLogout(){if(ws)ws.close();myId=null;activeChat=null;Object.keys(chats).forEach(k=>delete chats[k]);friendsList=[];groupsList=[];document.getElementById('authScr').style.display='flex';document.getElementById('chatScr').classList.remove('on');document.getElementById('msgArea').innerHTML='';document.getElementById('chatTabs').innerHTML=''}
function showChat(){document.getElementById('authScr').style.display='none';document.getElementById('chatScr').classList.add('on');
  if(!isG){document.getElementById('menuItems').style.display=''}
  document.getElementById('menuAv').textContent=myAvatar;document.getElementById('menuNm').textContent=myName;
  document.getElementById('menuLg').textContent=isG?'(аноним)':'@'+myId;
  updateXP()}
function toggleMenu(){document.getElementById('sideMenu').classList.toggle('show');document.getElementById('menuOv').classList.toggle('show')}
function cpId(){navigator.clipboard.writeText(myId).catch(()=>{})}
function setSt(s){myStatus=s;document.getElementById('stP').classList.remove('show');if(ws)ws.send(JSON.stringify({type:'update_status',status:s}))}
function showProfile(id){
  fetch(API+'/profile?id='+encodeURIComponent(id)).then(r=>r.json()).then(p=>{
    if(p.error)return;
    const isMe=p.id===myId;
    const isFr=friendsList.some(f=>f.id===p.id);
    const created=new Date(p.createdAt).toLocaleDateString('ru-RU');
    const lastSeen=new Date(p.lastLogin).toLocaleDateString('ru-RU');
    const xpCur=XPL[p.level-1]||0,xpNext=XPL[p.level]||XPL[XPL.length-1];
    const xpPct=Math.min(100,((p.xp-xpCur)/(xpNext-xpCur))*100);
    const winRate=p.gamesPlayed>0?Math.round((p.gamesWon/p.gamesPlayed)*100):0;
    let h='<div class="prof-header">';
    h+='<div class="prof-avatar">'+p.avatar+'</div>';
    h+='<div class="prof-name">'+p.displayName+'</div>';
    h+='<div class="prof-login">@'+p.id+'</div>';
    h+='<span class="prof-level">LVL '+p.level+'</span>';
    h+='<span class="prof-online '+(p.online?'on':'off')+'">'+(p.online?'● Онлайн':'○ Оффлайн')+'</span>';
    h+='</div>';
    if(isMe)h+='<div class="prof-bio"><textarea class="prof-bio-edit" id="bioEdit" rows="2" maxlength="200" placeholder="О себе..."'+(p.bio?' ':'')+'onblur="saveBio()">'+escH(p.bio)+'</textarea></div>';
    else if(p.bio)h+='<div class="prof-bio">«'+escH(p.bio)+'»</div>';
    h+='<div class="prof-stats">';
    h+='<div class="prof-stat"><div class="val">'+p.messages+'</div><div class="lbl">'+t('messages')+'</div></div>';
    h+='<div class="prof-stat"><div class="val">'+p.daysInChat+'</div><div class="lbl">'+t('days')+'</div></div>';
    h+='<div class="prof-stat"><div class="val">'+p.friends+'</div><div class="lbl">'+t('friendsN')+'</div></div>';
    h+='<div class="prof-stat"><div class="val">🪙 '+(p.coins||0)+'</div><div class="lbl">'+t('coins')+'</div></div>';
    h+='</div>';
    if(isMe)h+='<div class="prof-weather" id="profWeather"><div class="pw-icon">ð¤</div><div><div class="pw-temp" id="pwTemp">--Â°</div><div class="pw-desc" id="pwDesc">'+(t('weatherLoading')||'...')+'</div></div></div>';
    if(isMe){if(p.petType){const petLvl=Math.floor((p.petXp||0)/50)+1;const petMood=(p.petHunger+p.petHappy)/2;const moodEmoji=petMood>70?'😊':petMood>40?'😐':'😢';window._profPet={type:p.petType,name:p.petName,hunger:p.petHunger,happy:p.petHappy,xp:p.petXp||0,room:JSON.parse(p.petRoom||'[]'),sick:p.petSick||false,hat:p.petHat||'',costume:p.petCostume||'',wardrobe:JSON.parse(p.petWardrobe||'[]')};h+='<div class="pet-box" onclick="openPetScreen(window._profPet.type,window._profPet.name,window._profPet.hunger,window._profPet.happy,window._profPet.xp,window._profPet.room,window._profPet.sick,window._profPet.hat,window._profPet.costume,window._profPet.wardrobe)"><div class="pet-mini"><span class="pet-mini-sprite">'+p.petType+'</span><div class="pet-mini-info"><div class="pet-mini-name">'+escH(p.petName)+' '+moodEmoji+'</div><div class="pet-mini-lvl">LVL '+petLvl+' • 🍖'+p.petHunger+'% 💖'+p.petHappy+'%</div></div></div></div>'}else{h+='<div class="pet-box" onclick="openPetAdopt()"><div class="pet-mini"><span class="pet-mini-sprite">🥚</span><div class="pet-mini-info"><div class="pet-mini-name">'+(t('petAdopt')||'Adopt a pet!')+'</div><div class="pet-mini-lvl">👉 '+(t('petTap')||'Tap here')+'</div></div></div></div>'}}
    h+='<div class="prof-xp"><div style="font-size:.65rem;color:var(--td);font-family:\'Space Mono\',monospace">'+t('experience')+'</div><div class="prof-xp-bar"><div class="prof-xp-fill" style="width:'+xpPct+'%"></div></div><div class="prof-xp-text"><span>'+p.xp+' XP</span><span>'+xpNext+' XP</span></div></div>';
    h+='<div class="prof-details">';
    h+='<div class="prof-row"><span class="lbl">🎲 '+t('games')+'</span><span class="val">'+p.gamesWon+'/'+p.gamesPlayed+(p.gamesPlayed>0?' ('+winRate+'%)':'')+'</span></div>';
    h+='<div class="prof-row"><span class="lbl">📅 '+t('regDate')+'</span><span class="val">'+created+'</span></div>';
    h+='<div class="prof-row"><span class="lbl">🕐 '+t('lastVisit')+'</span><span class="val">'+lastSeen+'</span></div>';
    h+='</div>';
    h+='<div style="padding:0 16px 4px;font-size:.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);font-family:\'Space Mono\',monospace">'+t('achievements')+'</div>';
    h+='<div class="ach-grid">';
    ACHS.forEach(a=>{const earned=(p.achievements||[]).includes(a.id);h+='<div class="ach-item '+(earned?'earned':'locked')+'" title="'+(a.name[curLang]||a.name.ru)+'">'+a.icon+'<div class="ach-tip">'+(a.name[curLang]||a.name.ru)+'</div></div>'});
    h+='</div>';
    if(!isMe){h+='<div class="prof-actions">';
      h+='<button class="abtn abtn-p" onclick="document.getElementById(\'pId\').value=\''+p.id+'\';doConn();document.getElementById(\'profBg\').classList.remove(\'show\')">💬 '+t('write')+'</button>';
      if(!isFr)h+='<button class="abtn abtn-g" onclick="addFD(\''+p.id+'\')">➕ '+t('addFriend')+'</button>';
      h+='</div>'}
    else{h+='<div class="prof-actions"><button class="abtn abtn-g" onclick="document.getElementById(\'profBg\').classList.remove(\'show\')">'+t('close')+'</button></div>'}
    document.getElementById('profModal').innerHTML=h;
    document.getElementById('profBg').classList.add('show');
    if(isMe)loadWeather();
  }).catch(()=>{})
}
const WEATHER_ICONS={'Clear':'\u2600\uFE0F','Sunny':'\u2600\uFE0F','Partly cloudy':'\u26C5','Cloudy':'\u2601\uFE0F','Overcast':'\u2601\uFE0F','Mist':'\uD83C\uDF2B','Fog':'\uD83C\uDF2B','Rain':'\uD83C\uDF27','Light rain':'\uD83C\uDF26','Light drizzle':'\uD83C\uDF26','Heavy rain':'\uD83C\uDF27','Thunderstorm':'\u26C8','Snow':'\u2744\uFE0F','Light snow':'\uD83C\uDF28','Haze':'\uD83C\uDF2B'};
function loadWeather(){
  fetch('https://wttr.in/Baku?format=j1').then(r=>r.json()).then(d=>{
    const cur=d.current_condition&&d.current_condition[0];if(!cur)return;
    const temp=cur.temp_C,desc=(cur.weatherDesc&&cur.weatherDesc[0]&&cur.weatherDesc[0].value)||'';
    const icon=WEATHER_ICONS[desc]||'\uD83C\uDF24';
    const pw=document.getElementById('profWeather');if(!pw)return;
    pw.innerHTML='<div class="pw-icon">'+icon+'</div><div style="flex:1"><div class="pw-temp">'+temp+'\u00B0C</div><div class="pw-desc">'+desc+'</div></div><div class="pw-city">\uD83D\uDCCD Baku</div>';
  }).catch(()=>{const pw=document.getElementById('profWeather');if(pw)pw.style.display='none'})
}
function petAdopt(emoji){
  const name=prompt(t('petNamePrompt')||'Name your pet:');
  if(!name||!name.trim()||!ws)return;
  ws.send(JSON.stringify({type:'pet_adopt',petType:emoji,petName:name.trim()}));
  setTimeout(()=>showProfile(myId),500);
}
function petFeed(){if(!ws)return;ws.send(JSON.stringify({type:'pet_feed'}))}
function petPlay(){if(!ws)return;ws.send(JSON.stringify({type:'pet_play'}))}
let petState={};
function openPetScreen(type,name,hunger,happy,xp,room,sick,hat,costume,wardrobe){
  petState={type,name,hunger,happy,xp,room:room||[],sick:sick||false,hat:hat||'',costume:costume||'',wardrobe:wardrobe||[],_lastEvo:petState._lastEvo};
  renderPetScreen();
  document.getElementById('petBg').classList.add('show');
}
function openPetAdopt(){
  const md=document.getElementById('petModal');
  let h='<div class="pet-adopt-modal">';
  h+='<div class="pet-adopt-title">'+(t('petAdopt')||'Adopt a pet!')+'</div>';
  h+='<div class="pet-adopt-sub">'+(t('petChoose')||'Choose your companion')+'</div>';
  h+='<div class="pet-adopt-grid">';
  ['🐱','🐶','🐰','🐹','🦊','🐸','🐧','🐻'].forEach(e=>{
    h+='<div class="pet-adopt-opt" onclick="selectPetOpt(this,\''+e+'\')">'+e+'</div>';
  });
  h+='</div>';
  h+='<div class="pet-adopt-name"><input type="text" id="petNameInput" placeholder="'+(t('petNamePrompt')||'Name your pet...')+'" maxlength="20"></div>';
  h+='<div style="margin-top:14px;display:flex;gap:8px;justify-content:center"><button class="mini-btn" onclick="doAdoptPet()" style="padding:8px 20px;font-size:.82rem">🐾 '+(t('petAdoptBtn')||'Adopt!')+'</button><button class="mini-btn" onclick="document.getElementById(\'petBg\').classList.remove(\'show\')">'+t('close')+'</button></div>';
  h+='</div>';
  md.innerHTML=h;
  document.getElementById('petBg').classList.add('show');
}
let selectedPetType='';
function selectPetOpt(el,type){
  selectedPetType=type;
  document.querySelectorAll('.pet-adopt-opt').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
}
function doAdoptPet(){
  const name=document.getElementById('petNameInput')?.value?.trim();
  if(!selectedPetType||!name||!ws)return;
  ws.send(JSON.stringify({type:'pet_adopt',petType:selectedPetType,petName:name}));
  document.getElementById('petBg').classList.remove('show');
  setTimeout(()=>showProfile(myId),600);
}
function renderPetScreen(){
  const md=document.getElementById('petModal');const p=petState;
  const lvl=Math.floor((p.xp||0)/50)+1;
  const xpInLvl=(p.xp||0)%50;
  const mood=(p.hunger+p.happy)/2;
  const moodEmoji=mood>80?'😊':mood>60?'🙂':mood>40?'😐':mood>20?'😢':'💀';
  const moodText=mood>80?(t('petMoodGreat')||'Great!'):mood>60?(t('petMoodGood')||'Good'):mood>40?(t('petMoodOk')||'Okay'):mood>20?(t('petMoodSad')||'Sad'):(t('petMoodCritical')||'Critical!');
  const isSleeping=p.happy<15;
  // EVOLUTION: different emoji per level
  const evoMap={'🐱':['🐱','😺','😸','😻','🦁'],'🐶':['🐶','🐕','🦮','🐺','🐲'],'🐰':['🐰','🐇','🐾','🦄','🐲'],'🐹':['🐹','🐭','🐀','🦔','🐲'],'🦊':['🦊','🐺','🦝','🐯','🐲'],'🐸':['🐸','🐊','🦎','🐉','🐲'],'🐧':['🐧','🐦','🦅','🦚','🐲'],'🐻':['🐻','🐼','🦊','🐯','🐲']};
  const evoStage=Math.min(4,Math.floor(lvl/3));
  const evos=evoMap[p.type]||[p.type,p.type,p.type,p.type,p.type];
  const displayPet=evos[evoStage];
  const acc=lvl>=10?'👑':lvl>=7?'🎩':lvl>=5?'🎀':lvl>=3?'⭐':'';
  // DAY/NIGHT by real time
  const hr=new Date().getHours();
  const timeOfDay=hr>=6&&hr<10?'morning':hr>=10&&hr<17?'day':hr>=17&&hr<20?'sunset':'night';
  let h='<div class="pet-scene '+timeOfDay+'">';
  h+='<div class="pet-scene-stars" id="petStars"></div>';
  if(timeOfDay==='night')h+='<div class="pet-moon"></div>';
  else if(timeOfDay==='day')h+='<div class="pet-sun day"></div>';
  else if(timeOfDay==='sunset')h+='<div class="pet-sun sunset"></div>';
  else h+='<div class="pet-sun morning"></div>';
  h+='<div class="pet-scene-ground"></div>';
  h+='<div class="pet-scene-grass"></div>';
  // WEATHER EFFECTS
  const weatherEffects=getPetWeather();
  if(weatherEffects)h+=weatherEffects;
  // ROOM FURNITURE
  const room=p.room||[];
  const furniturePos={bed:'bottom:8%;left:8%',plant:'bottom:12%;right:8%',lamp:'bottom:10%;right:22%',rug:'bottom:2%;left:30%',toy:'bottom:6%;left:22%',bowl:'bottom:4%;right:32%',house:'bottom:8%;left:42%',aqua:'bottom:10%;right:42%'};
  const furnitureIcons={bed:'🛏',plant:'🌿',lamp:'💡',rug:'🟫',toy:'🧸',bowl:'🥣',house:'🏠',aqua:'🐟'};
  if(room.length>0){h+='<div class="pet-room-items">';room.forEach(function(it){h+='<div class="pet-furniture" style="'+furniturePos[it]+'">'+furnitureIcons[it]+'</div>'});h+='</div>'}
  h+='<div class="pet-glow"></div>';
  h+='<div class="pet-platform"></div>';
  h+='<div class="pet-footprints" id="petFootprints"></div>';
  h+='<div class="pet-particles" id="petParticles"></div>';
  const isSick=p.sick||false;
  h+='<div class="pet-character'+(isSleeping?' sleeping':'')+(isSick?' pet-sick':'')+'" id="petSprite" onclick="petTap()">';
  h+='<div class="pet-body">';
  // CLOTHING
  const hat=p.hat||'';const costume=p.costume||'';
  const hatIcons={crown:'👑',tophat:'🎩',bow:'🎀',glasses:'🕶',ribbon:'🎗',flower:'🌸',devil:'😈',halo:'😇'};
  if(hat&&hatIcons[hat])h+='<div class="pet-outfit pet-hat">'+hatIcons[hat]+'</div>';
  else if(acc)h+='<div class="pet-accessory">'+acc+'</div>';
  h+='<div class="pet-head">'+displayPet+'</div>';
  const costumeIcons={scarf:'🧣',cape:'🦸'};
  if(costume&&costumeIcons[costume])h+='<div class="pet-outfit pet-costume">'+costumeIcons[costume]+'</div>';
  h+='<div class="pet-belly"><div class="pet-paws"><div class="pet-paw"></div><div class="pet-paw"></div></div></div>';
  h+='<div class="pet-feet"><div class="pet-foot"></div><div class="pet-foot"></div></div>';
  h+='</div>';
  h+='<div class="pet-shadow"></div>';
  h+='</div>';
  if(isSick)h+='<div class="pet-sick-icon">🤒</div>';
  if(isSleeping)h+='<div class="pet-zzz">💤</div>';
  h+='<div id="petSpeech"></div>';
  h+='<div class="pet-hearts" id="petHearts"></div>';
  h+='</div>';
  h+='<div class="pet-info">';
  h+='<div class="pet-name-row"><span class="pet-name-big">'+p.name+'</span><span class="pet-mood-icon">'+moodEmoji+'</span></div>';
  if(evoStage>0)h+='<div style="text-align:center;font-size:.55rem;color:#a78bfa;font-family:\'Space Mono\',monospace;margin-bottom:2px">'+(t('petEvo')||'Evolution')+' '+['I','II','III','IV','V'][evoStage]+'</div>';
  h+='<div class="pet-lvl-row"><span class="pet-lvl-badge">LVL '+lvl+'</span><div class="pet-lvl-xp">XP: '+xpInLvl+'/50</div></div>';
  h+='<div class="pet-stats">';
  h+='<div class="pet-stat-row"><span class="pet-stat-icon">🍖</span><span class="pet-stat-lbl">'+(t('petHunger')||'Hunger')+'</span><div class="pet-stat-track"><div class="pet-stat-fill hunger" style="width:'+p.hunger+'%"></div></div><span class="pet-stat-val" style="color:'+(p.hunger<30?'#ef4444':p.hunger<60?'#f59e0b':'#22c55e')+'">'+p.hunger+'%</span></div>';
  h+='<div class="pet-stat-row"><span class="pet-stat-icon">💖</span><span class="pet-stat-lbl">'+(t('petHappy')||'Happy')+'</span><div class="pet-stat-track"><div class="pet-stat-fill happy" style="width:'+p.happy+'%"></div></div><span class="pet-stat-val" style="color:'+(p.happy<30?'#ef4444':p.happy<60?'#a78bfa':'#f472b6')+'">'+p.happy+'%</span></div>';
  h+='<div class="pet-stat-row"><span class="pet-stat-icon">💪</span><span class="pet-stat-lbl">'+(t('petMood')||'Mood')+'</span><div class="pet-stat-track"><div class="pet-stat-fill" style="width:'+mood+'%;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e)"></div></div><span class="pet-stat-val">'+moodText+'</span></div>';
  h+='</div>';
  // SICKNESS
  if(isSick){h+='<div style="text-align:center;padding:8px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:10px;margin-bottom:8px"><span style="font-size:1.2rem">🤒</span><span style="font-size:.72rem;color:#ef4444;font-weight:600;margin-left:6px">'+(t('petSickMsg')||'Your pet is sick!')+'</span><div class="pet-action'+(myCoins<10?' disabled':'')+'" onclick="doPetHeal()" style="margin-top:6px;display:inline-flex"><span class="pa-icon">💊</span><span class="pa-name">'+(t('petHeal')||'Heal')+'</span><span class="pa-cost">10🪙</span></div></div>'}
  // FOOD MENU
  h+='<div style="font-size:.6rem;color:var(--td);text-transform:uppercase;letter-spacing:1.5px;font-family:\'Space Mono\',monospace;margin-bottom:6px">'+(t('petFoodMenu')||'FOOD')+'</div>';
  h+='<div class="pet-food-menu">';
  const foods=[{id:'milk',icon:'🥛',cost:2},{id:'apple',icon:'🍎',cost:3},{id:'candy',icon:'🍬',cost:4},{id:'fish',icon:'🐟',cost:5},{id:'pizza',icon:'🍕',cost:6},{id:'meat',icon:'🥩',cost:8},{id:'cake',icon:'🎂',cost:10},{id:'golden',icon:'🌟',cost:25}];
  foods.forEach(function(f){h+='<div class="pet-food-item'+(isSick||myCoins<f.cost?' disabled':'')+'" onclick="feedPetFood(\''+f.id+'\')"><span class="pf-icon">'+f.icon+'</span><span class="pf-cost">'+f.cost+'🪙</span></div>'});
  h+='</div>';
  // ACTION BUTTONS
  h+='<div class="pet-btns">';
  h+='<div class="pet-action'+(isSick||myCoins<3?' disabled':'')+'" onclick="doPetPlay()"><span class="pa-icon">🎾</span><span class="pa-name">'+(t('petPlay')||'Play')+'</span><span class="pa-cost">3🪙</span></div>';
  h+='<div class="pet-action'+(isSick||myCoins<4?' disabled':'')+'" onclick="doPetWash()"><span class="pa-icon">🛁</span><span class="pa-name">'+(t('petWash')||'Wash')+'</span><span class="pa-cost">4🪙</span></div>';
  h+='<div class="pet-action" onclick="petTap()"><span class="pa-icon">🤗</span><span class="pa-name">'+(t('petPet')||'Pet')+'</span><span class="pa-cost">'+(t('petFree')||'Free')+'</span></div>';
  h+='<div class="pet-action" onclick="doPetSleep()"><span class="pa-icon">😴</span><span class="pa-name">'+(t('petSleep')||'Sleep')+'</span><span class="pa-cost">'+(t('petFree')||'Free')+'</span></div>';
  h+='<div class="pet-action" onclick="openPetWardrobe()"><span class="pa-icon">👗</span><span class="pa-name">'+(t('petClothes')||'Clothes')+'</span><span class="pa-cost">'+(t('petShop2')||'Shop')+'</span></div>';
  h+='<div class="pet-action" onclick="openPetRoom()"><span class="pa-icon">🏠</span><span class="pa-name">'+(t('petRoom')||'Room')+'</span><span class="pa-cost">'+(t('petShop2')||'Shop')+'</span></div>';
  h+='</div>';
  h+='<div style="text-align:center"><button class="mini-btn" onclick="document.getElementById(\'petBg\').classList.remove(\'show\')">'+t('close')+'</button></div>';
  h+='</div>';
  md.innerHTML=h;
  drawPetStars();
  startPetFootprints();
  // Check evolution flash
  if(petState._lastEvo!==undefined && evoStage>petState._lastEvo){
    const sc=document.querySelector('.pet-scene');
    if(sc){const fl=document.createElement('div');fl.className='pet-evo-flash';sc.appendChild(fl);setTimeout(function(){fl.remove()},1500)}
    petSay('Я эволюционировал! ✨');petSound('trick');
  }
  petState._lastEvo=evoStage;
  // Speech bubble with delay
  setTimeout(function(){if(!petState.sick)petSay()},800);
}
function drawPetStars(){
  const c=document.getElementById('petStars');if(!c)return;
  let s='';for(let i=0;i<30;i++){
    const x=Math.random()*100,y=Math.random()*100,sz=Math.random()*2.5+.5,d=Math.random()*4+2;
    s+='<div style="position:absolute;left:'+x+'%;top:'+y+'%;width:'+sz+'px;height:'+sz+'px;background:rgba(255,255,255,'+(Math.random()*.5+.15)+');border-radius:50%;animation:twinkle '+d+'s ease-in-out '+(Math.random()*2)+'s infinite"></div>';
  }
  c.innerHTML=s;
  const pc=document.getElementById('petParticles');if(!pc)return;
  let ps='';const particles=['✨','🌿','🍃','·'];
  for(let i=0;i<6;i++){
    const x=Math.random()*90+5,d=Math.random()*6+4,sz=Math.random()>.5?'.7rem':'.5rem';
    ps+='<div style="position:absolute;left:'+x+'%;bottom:'+(Math.random()*60+10)+'%;font-size:'+sz+';opacity:'+(Math.random()*.3+.1)+';animation:particle-float '+d+'s ease-in-out '+(Math.random()*3)+'s infinite">'+particles[Math.floor(Math.random()*particles.length)]+'</div>';
  }
  pc.innerHTML=ps;
}
function petTap(){
  const sp=document.getElementById('petSprite');if(!sp)return;
  sp.style.animation='none';sp.offsetHeight;sp.style.animation='pet-eat .5s ease 1';
  showPetHearts();petEmote('💕');petSound('tap');
  petSay();
}
function showPetHearts(){
  const c=document.getElementById('petHearts');if(!c)return;
  const hearts=['❤️','💕','💖','✨','💫'];
  for(let i=0;i<5;i++){
    setTimeout(()=>{
      const h=document.createElement('div');h.className='pet-heart';
      h.textContent=hearts[Math.floor(Math.random()*hearts.length)];
      h.style.left=(30+Math.random()*40)+'%';h.style.top=(20+Math.random()*30)+'%';
      h.style.animationDelay=(Math.random()*.3)+'s';
      c.appendChild(h);setTimeout(()=>h.remove(),1200);
    },i*100);
  }
}
function doPetFeed(){
  if(!ws||myCoins<5)return;
  const sp=document.getElementById('petSprite');
  if(sp){sp.classList.add('eating');setTimeout(()=>sp.classList.remove('eating'),2000)}
  showPetHearts();petEmote('😋');petSound('feed');petSay('Вкусняшка!');
  ws.send(JSON.stringify({type:'pet_feed'}));
}
function doPetPlay(){
  if(!ws||myCoins<3)return;
  const sp=document.getElementById('petSprite');
  if(sp){sp.classList.add('playing');setTimeout(()=>sp.classList.remove('playing'),2200)}
  showPetHearts();petEmote('🥳');petSound('play');petSay('Вииии! 🎉');
  ws.send(JSON.stringify({type:'pet_play'}));
}
function openPetFromMenu(){
  fetch(API+'/profile?id='+encodeURIComponent(myId)).then(r=>r.json()).then(p=>{
    if(p.petType){let rm=[];try{rm=JSON.parse(p.petRoom||'[]')}catch(e){}let wd=[];try{wd=JSON.parse(p.petWardrobe||'[]')}catch(e){}openPetScreen(p.petType,p.petName||'Pet',p.petHunger||50,p.petHappy||50,p.petXp||0,rm,p.petSick||false,p.petHat||'',p.petCostume||'',wd)}
    else openPetAdopt();
  }).catch(()=>openPetAdopt());
}
function doPetWash(){
  if(!ws||myCoins<4)return;
  const sp=document.getElementById('petSprite');
  if(sp){sp.style.animation='none';sp.offsetHeight;sp.style.animation='pet-eat .6s ease 2'}
  showPetBubbles();petEmote('🧼');petSound('wash');petSay('Буль-буль! 🫧');
  ws.send(JSON.stringify({type:'pet_wash'}));
}
function doPetSleep(){
  const sp=document.getElementById('petSprite');
  if(sp){sp.classList.add('sleeping');setTimeout(()=>sp.classList.remove('sleeping'),3000)}
  const c=document.getElementById('petHearts');if(!c)return;
  for(let i=0;i<3;i++){
    setTimeout(()=>{
      const h=document.createElement('div');h.className='pet-heart';h.textContent='💤';
      h.style.left=(40+Math.random()*20)+'%';h.style.top=(15+Math.random()*20)+'%';
      c.appendChild(h);setTimeout(()=>h.remove(),1500);
    },i*400);
  }
}
function doPetTrick(){
  const sp=document.getElementById('petSprite');if(!sp)return;
  sp.style.animation='none';sp.offsetHeight;
  sp.style.animation='pet-trick .8s ease 2';
  showPetHearts();petEmote('🤩');petSound('trick');
}
function showPetBubbles(){
  const c=document.getElementById('petHearts');if(!c)return;
  const bubbles=['🫧','💧','🧼','✨','🫧'];
  for(let i=0;i<6;i++){
    setTimeout(()=>{
      const h=document.createElement('div');h.className='pet-heart';
      h.textContent=bubbles[Math.floor(Math.random()*bubbles.length)];
      h.style.left=(25+Math.random()*50)+'%';h.style.top=(20+Math.random()*30)+'%';
      c.appendChild(h);setTimeout(()=>h.remove(),1200);
    },i*120);
  }
}
// SPEECH BUBBLE
const PET_PHRASES={
  happy:['Я тебя люблю! ❤️','Мне хорошо!','Обнимашки? 🤗','Лучший день!','Ты мой друг! 💕'],
  hungry:['Хочу кушать... 🍖','Мой животик урчит','Еды! Еды!','Голодный...😿'],
  sad:['Мне грустно...','Поиграй со мной 😢','Скучаю по тебе','Не забывай меня!'],
  neutral:['Привет! 👋','Как дела?','Хм-м...','Чем займёмся?','Ля-ля-ля 🎵'],
  sleeping:['Zzz...💤','Хр-р-р...','Сплю...не буди']
};
function petSay(forced){
  const sb=document.getElementById('petSpeech');if(!sb)return;
  const p=petState;const mood=(p.hunger+p.happy)/2;
  let pool2;
  if(p.happy<15)pool2=PET_PHRASES.sleeping;
  else if(forced)pool2=[forced];
  else if(p.hunger<30)pool2=PET_PHRASES.hungry;
  else if(mood<40)pool2=PET_PHRASES.sad;
  else if(mood>70)pool2=PET_PHRASES.happy;
  else pool2=PET_PHRASES.neutral;
  const txt=pool2[Math.floor(Math.random()*pool2.length)];
  sb.innerHTML='<div class="pet-speech">'+txt+'</div>';
  setTimeout(function(){sb.innerHTML=''},3500);
}
// EMOTIONS
function petEmote(emoji){
  const sc=document.querySelector('.pet-scene');if(!sc)return;
  const em=document.createElement('div');em.className='pet-emotion';em.textContent=emoji;
  sc.appendChild(em);setTimeout(function(){em.remove()},1000);
}
// SOUND EFFECTS
function petSound(action){
  if(!soundOn)return;
  try{
    const ac=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ac.createOscillator();const gain=ac.createGain();
    osc.connect(gain);gain.connect(ac.destination);
    gain.gain.value=0.08;
    if(action==='feed'){osc.frequency.value=523;osc.type='sine';osc.start();osc.frequency.linearRampToValueAtTime(784,ac.currentTime+.15);gain.gain.linearRampToValueAtTime(0,ac.currentTime+.3);osc.stop(ac.currentTime+.3)}
    else if(action==='play'){osc.frequency.value=392;osc.type='triangle';osc.start();osc.frequency.linearRampToValueAtTime(523,ac.currentTime+.1);osc.frequency.linearRampToValueAtTime(659,ac.currentTime+.2);gain.gain.linearRampToValueAtTime(0,ac.currentTime+.35);osc.stop(ac.currentTime+.35)}
    else if(action==='wash'){osc.frequency.value=800;osc.type='sine';gain.gain.value=0.04;osc.start();osc.frequency.linearRampToValueAtTime(1200,ac.currentTime+.1);osc.frequency.linearRampToValueAtTime(600,ac.currentTime+.25);gain.gain.linearRampToValueAtTime(0,ac.currentTime+.4);osc.stop(ac.currentTime+.4)}
    else if(action==='trick'){osc.frequency.value=262;osc.type='square';gain.gain.value=0.05;osc.start();osc.frequency.linearRampToValueAtTime(523,ac.currentTime+.1);osc.frequency.linearRampToValueAtTime(784,ac.currentTime+.2);osc.frequency.linearRampToValueAtTime(1047,ac.currentTime+.3);gain.gain.linearRampToValueAtTime(0,ac.currentTime+.4);osc.stop(ac.currentTime+.4)}
    else if(action==='tap'){osc.frequency.value=600;osc.type='sine';gain.gain.value=0.06;osc.start();gain.gain.linearRampToValueAtTime(0,ac.currentTime+.15);osc.stop(ac.currentTime+.15)}
    else{osc.frequency.value=440;osc.type='sine';osc.start();gain.gain.linearRampToValueAtTime(0,ac.currentTime+.2);osc.stop(ac.currentTime+.2)}
  }catch(e){}
}
// FOOD SYSTEM
function feedPetFood(foodId){
  if(!ws)return;
  const sp=document.getElementById('petSprite');
  if(sp){sp.classList.add('eating');setTimeout(function(){sp.classList.remove('eating')},1800)}
  const foodEmojis={milk:'🥛',apple:'🍎',candy:'🍬',fish:'🐟',pizza:'🍕',meat:'🥩',cake:'🎂',golden:'🌟'};
  petEmote(foodEmojis[foodId]||'🍖');
  petSay('Ням-ням! '+( foodEmojis[foodId]||''));
  petSound('feed');showPetHearts();
  ws.send(JSON.stringify({type:'pet_feed_food',food:foodId}));
}
// ROOM SHOP
function openPetRoom(){
  const md=document.getElementById('petModal');
  const room=petState.room||[];
  const items=[
    {id:'bowl',icon:'🥣',cost:5,name:t('petBowl')||'Bowl'},
    {id:'toy',icon:'🧸',cost:10,name:t('petToy')||'Toy'},
    {id:'lamp',icon:'💡',cost:8,name:t('petLamp')||'Lamp'},
    {id:'plant',icon:'🌿',cost:10,name:t('petPlant')||'Plant'},
    {id:'rug',icon:'🟫',cost:12,name:t('petRug')||'Rug'},
    {id:'bed',icon:'🛏',cost:15,name:t('petBed')||'Bed'},
    {id:'aqua',icon:'🐟',cost:18,name:t('petAqua')||'Aquarium'},
    {id:'house',icon:'🏠',cost:20,name:t('petHouse')||'House'}
  ];
  let h='<div style="padding:18px;text-align:center">';
  h+='<div style="font-size:1rem;font-weight:700;color:var(--a);margin-bottom:4px">🏠 '+(t('petRoom')||'Room')+'</div>';
  h+='<div style="font-size:.68rem;color:var(--td);margin-bottom:12px">🪙 '+myCoins+' '+(t('coins')||'coins')+'</div>';
  h+='<div class="pet-food-menu" style="grid-template-columns:repeat(4,1fr);gap:8px">';
  items.forEach(function(it){
    const owned=room.includes(it.id);
    h+='<div class="pet-food-item'+(owned?' disabled':myCoins<it.cost?' disabled':'')+'" onclick="buyPetRoom(\''+it.id+'\')" style="padding:10px 4px">';
    h+='<span class="pf-icon" style="font-size:1.5rem">'+it.icon+'</span>';
    h+='<span style="font-size:.6rem;font-weight:600">'+it.name+'</span>';
    h+='<span class="pf-cost">'+(owned?'✅':it.cost+'🪙')+'</span>';
    h+='</div>';
  });
  h+='</div>';
  h+='<div style="margin-top:12px"><button class="mini-btn" onclick="renderPetScreen()">← '+(t('petBack')||'Back')+'</button></div>';
  h+='</div>';
  md.innerHTML=h;
}
function buyPetRoom(itemId){
  if(!ws)return;
  ws.send(JSON.stringify({type:'pet_buy_room',item:itemId}));
}
// WEATHER EFFECTS
function getPetWeather(){
  const hr=new Date().getHours();const min=new Date().getMinutes();
  const seed=Math.floor((hr*60+min)/30);// changes every 30min
  const w=seed%5;// 0=clear,1=rain,2=snow,3=rainbow,4=clear
  if(w===1){// rain
    let h='<div class="pet-weather">';
    for(let i=0;i<30;i++){const x=Math.random()*100,dur=.4+Math.random()*.4,del=Math.random()*2,ht=15+Math.random()*20;
    h+='<div class="rain-drop" style="left:'+x+'%;height:'+ht+'px;animation-duration:'+dur+'s;animation-delay:'+del+'s"></div>'}
    return h+'</div>';
  }
  if(w===2){// snow
    let h='<div class="pet-weather">';
    for(let i=0;i<20;i++){const x=Math.random()*100,dur=3+Math.random()*4,del=Math.random()*3,sz=2+Math.random()*4;
    h+='<div class="snow-flake" style="left:'+x+'%;width:'+sz+'px;height:'+sz+'px;animation-duration:'+dur+'s;animation-delay:'+del+'s"></div>'}
    return h+'</div>';
  }
  if(w===3)return '<div class="pet-rainbow"></div>';
  return '';
}
// FOOTPRINTS
function startPetFootprints(){
  const fp=document.getElementById('petFootprints');if(!fp)return;
  let idx=0;
  const intv=setInterval(function(){
    if(!document.getElementById('petFootprints')){clearInterval(intv);return}
    if(idx>=6){clearInterval(intv);return}
    const el=document.createElement('div');el.className='pet-footprint';
    el.textContent='🐾';
    el.style.left=(20+idx*10)+'%';el.style.bottom=(idx%2===0?'2px':'6px');
    el.style.fontSize='.55rem';el.style.animationDelay=(idx*0.3)+'s';
    fp.appendChild(el);idx++;
    setTimeout(function(){el.remove()},3000);
  },500);
}
// HEAL
function doPetHeal(){
  if(!ws||myCoins<10)return;
  petEmote('💊');petSound('feed');petSay('Мне лучше! 🥰');
  ws.send(JSON.stringify({type:'pet_heal'}));
}
// WARDROBE
function openPetWardrobe(){
  const md=document.getElementById('petModal');
  const wardrobe=petState.wardrobe||[];
  const hat=petState.hat||'';const costume=petState.costume||'';
  const hats=[
    {id:'flower',icon:'🌸',cost:6},{id:'ribbon',icon:'🎗',cost:8},{id:'glasses',icon:'🕶',cost:10},
    {id:'bow',icon:'🎀',cost:12},{id:'devil',icon:'😈',cost:18},{id:'tophat',icon:'🎩',cost:20},
    {id:'halo',icon:'😇',cost:22},{id:'crown',icon:'👑',cost:30}
  ];
  const costumes=[{id:'scarf',icon:'🧣',cost:15},{id:'cape',icon:'🦸',cost:25}];
  let h='<div style="padding:18px;text-align:center">';
  h+='<div style="font-size:1rem;font-weight:700;color:var(--a);margin-bottom:4px">👗 '+(t('petClothes')||'Wardrobe')+'</div>';
  h+='<div style="font-size:.68rem;color:var(--td);margin-bottom:12px">🪙 '+myCoins+' '+(t('coins')||'coins')+'</div>';
  // HATS
  h+='<div style="font-size:.6rem;color:var(--td);text-transform:uppercase;letter-spacing:1.5px;font-family:\'Space Mono\',monospace;margin-bottom:6px">'+(t('petHats')||'HATS')+'</div>';
  h+='<div class="pet-clothes-grid">';
  hats.forEach(function(it){
    const owned=wardrobe.includes(it.id);const eq=hat===it.id;
    h+='<div class="pet-cloth-item'+(eq?' equipped':owned?' owned':myCoins<it.cost?' disabled':'')+'" onclick="'+(owned?'equipPetHat(\''+it.id+'\')':'buyPetCloth(\''+it.id+'\')')+'">';
    h+='<span class="pc-icon">'+it.icon+'</span>';
    h+='<span class="pc-cost">'+(eq?'✅':owned?'👆':it.cost+'🪙')+'</span>';
    h+='</div>';
  });
  h+='</div>';
  // COSTUMES
  h+='<div style="font-size:.6rem;color:var(--td);text-transform:uppercase;letter-spacing:1.5px;font-family:\'Space Mono\',monospace;margin:8px 0 6px">'+(t('petCostumes')||'COSTUMES')+'</div>';
  h+='<div class="pet-clothes-grid" style="grid-template-columns:repeat(2,1fr)">';
  costumes.forEach(function(it){
    const owned=wardrobe.includes(it.id);const eq=costume===it.id;
    h+='<div class="pet-cloth-item'+(eq?' equipped':owned?' owned':myCoins<it.cost?' disabled':'')+'" onclick="'+(owned?'equipPetCostume(\''+it.id+'\')':'buyPetCloth(\''+it.id+'\')')+'">';
    h+='<span class="pc-icon" style="font-size:1.8rem">'+it.icon+'</span>';
    h+='<span class="pc-cost">'+(eq?'✅':owned?'👆':it.cost+'🪙')+'</span>';
    h+='</div>';
  });
  h+='</div>';
  if(hat||costume){h+='<div style="margin-top:8px"><button class="mini-btn" onclick="equipPetHat(\'\');equipPetCostume(\'\')">'+(t('petRemoveAll')||'Remove all')+'</button></div>'}
  h+='<div style="margin-top:12px"><button class="mini-btn" onclick="renderPetScreen()">← '+(t('petBack')||'Back')+'</button></div>';
  h+='</div>';
  md.innerHTML=h;
}
function buyPetCloth(itemId){if(!ws)return;ws.send(JSON.stringify({type:'pet_buy_cloth',item:itemId}))}
function equipPetHat(id){if(!ws)return;petState.hat=id;ws.send(JSON.stringify({type:'pet_equip',hat:id,costume:petState.costume||''}))}
function equipPetCostume(id){if(!ws)return;petState.costume=id;ws.send(JSON.stringify({type:'pet_equip',hat:petState.hat||'',costume:id}))}
function escH(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function saveBio(){const el=document.getElementById('bioEdit');if(!el||!ws)return;ws.send(JSON.stringify({type:'update_bio',bio:el.value}))}

// === CHECKERS ===
let ckGame=null,ckSel=null,ckMust=null;
function ckInvite(id){if(!ws)return;ws.send(JSON.stringify({type:'checkers_invite',target:id}));ensureChat(id,id);addToChat(id,{type:'y',text:'♟ '+t('ckInviteSent')||'Приглашение в шашки отправлено'})}
function ckAccept(from){if(!ws)return;ws.send(JSON.stringify({type:'checkers_accept',target:from}))}
function ckStartGame(data){
  ckGame={id:data.gameId,board:data.board,turn:data.turn,black:data.black,white:data.white,myColor:data.black===myId?'black':'white'};
  ckSel=null;ckMust=null;
  ckRender();document.getElementById('ckBg').classList.add('show');
}
function ckGetCaptures(board,r,c){
  const p=board[r][c];if(!p)return[];
  const isBlack=p===1||p===3;
  const caps=[];const dirs=[[-1,-1],[-1,1],[1,-1],[1,1]];
  for(const [dr,dc] of dirs){
    const mr=r+dr,mc=c+dc,jr=r+dr*2,jc=c+dc*2;
    if(jr<0||jr>7||jc<0||jc>7)continue;
    const mid=board[mr][mc];if(!mid)continue;
    const midBlack=mid===1||mid===3;
    if(midBlack===isBlack)continue;
    if(board[jr][jc]===0)caps.push({to:[jr,jc],captured:[mr,mc]});
  }
  return caps;
}
function ckGetMoves(board,r,c){
  const p=board[r][c];if(!p)return[];
  const isBlack=p===1||p===3;const isKing=p===3||p===4;
  const dirs=isKing?[[-1,-1],[-1,1],[1,-1],[1,1]]:isBlack?[[-1,-1],[-1,1]]:[[1,-1],[1,1]];
  const moves=[];
  for(const [dr,dc] of dirs){
    const nr=r+dr,nc=c+dc;
    if(nr<0||nr>7||nc<0||nc>7)continue;
    if(board[nr][nc]===0)moves.push({to:[nr,nc]});
  }
  return moves;
}
function ckHasCaptures(board,color){
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=board[r][c];if(!p)continue;
    const isBlack=p===1||p===3;
    if((color==='black')!==isBlack)continue;
    if(ckGetCaptures(board,r,c).length>0)return true;
  }
  return false;
}
function ckCountPieces(board){
  let b=0,w=0;
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=board[r][c];if(p===1||p===3)b++;if(p===2||p===4)w++;}
  return{b,w};
}
function ckRender(){
  if(!ckGame)return;
  const g=ckGame,myTurn=g.turn===g.myColor;
  const flip=g.myColor==='white';
  const cnt=ckCountPieces(g.board);
  const myPieces=g.myColor==='black'?cnt.b:cnt.w;
  const oppPieces=g.myColor==='black'?cnt.w:cnt.b;
  let h='<div class="ck-title">♟ '+(t('checkers')||'ШАШКИ')+'</div>';
  h+='<div class="ck-status">'+(myTurn?('🟢 '+(t('yourTurn')||'Ваш ход')):('⏳ '+(t('oppTurn')||'Ход соперника')))+'</div>';
  h+='<div class="ck-score"><span class="you">'+(g.myColor==='black'?'⚫':'⚪')+' '+myPieces+'</span><span>vs</span><span class="opp">'+(g.myColor==='black'?'⚪':'⚫')+' '+oppPieces+'</span></div>';
  h+='<div class="ck-board">';
  const forceCapture=myTurn&&ckHasCaptures(g.board,g.myColor);
  for(let ri=0;ri<8;ri++){
    const r=flip?7-ri:ri;
    for(let ci=0;ci<8;ci++){
      const c=flip?7-ci:ci;
      const isDark=(r+c)%2===1;
      const p=g.board[r][c];
      let cls='ck-cell '+(isDark?'dark':'light');
      if(ckSel&&ckSel[0]===r&&ckSel[1]===c)cls+=' sel';
      if(g.lastMove){if(g.lastMove.from[0]===r&&g.lastMove.from[1]===c)cls+=' last-from';if(g.lastMove.to[0]===r&&g.lastMove.to[1]===c)cls+=' last-to';}
      // Hints
      if(ckSel&&myTurn){
        const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
        const isCap=caps.some(x=>x.to[0]===r&&x.to[1]===c);
        if(isCap)cls+=' cap-hint';
        if(!forceCapture&&!isCap){
          const mvs=ckGetMoves(g.board,ckSel[0],ckSel[1]);
          if(mvs.some(x=>x.to[0]===r&&x.to[1]===c))cls+=' hint';
        }
      }
      h+='<div class="'+cls+'" onclick="ckClick('+r+','+c+')">';
      if(p){
        const isBlack=p===1||p===3;const isKing=p===3||p===4;
        h+='<div class="ck-piece '+(isBlack?'black':'white')+(isKing?' king':'')+'"></div>';
      }
      h+='</div>';
    }
  }
  h+='</div>';
  h+='<div class="ck-actions"><button class="danger" onclick="ckResign()">🏳 '+(t('resign')||'Сдаться')+'</button></div>';
  document.getElementById('ckModal').innerHTML=h;
}
function ckClick(r,c){
  if(!ckGame||ckGame.turn!==ckGame.myColor)return;
  const g=ckGame,p=g.board[r][c];
  const isBlack=p===1||p===3;
  const isMine=(g.myColor==='black'&&isBlack)||(g.myColor==='white'&&!isBlack&&p>0);
  // If must continue chain capture
  if(ckMust){
    if(r===ckMust[0]&&c===ckMust[1]){ckSel=[r,c];ckRender();return}
    if(ckSel){
      const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
      const cap=caps.find(x=>x.to[0]===r&&x.to[1]===c);
      if(cap){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
    }
    return;
  }
  if(isMine){ckSel=[r,c];ckRender();return}
  if(!ckSel)return;
  // Try move
  const forceCapture=ckHasCaptures(g.board,g.myColor);
  const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
  const cap=caps.find(x=>x.to[0]===r&&x.to[1]===c);
  if(cap){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
  if(!forceCapture){
    const mvs=ckGetMoves(g.board,ckSel[0],ckSel[1]);
    const mv=mvs.find(x=>x.to[0]===r&&x.to[1]===c);
    if(mv){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
  }
}
function ckResign(){if(!ckGame||!ws)return;if(!confirm(t('resignConfirm')||'Сдаться?'))return;ws.send(JSON.stringify({type:'checkers_resign',gameId:ckGame.id}))}

// GAMES PANEL
let selectedGame=null;
function openGames(){
  // Close other panels
  document.querySelectorAll('.panel.show').forEach(p=>p.classList.remove('show'));
  const gp=document.getElementById('gamesP');
  gp.classList.toggle('show');
  if(!gp.classList.contains('show'))return;
  selectedGame=null;
  renderGamesList();
}
function renderGamesList(){
  const gc=document.getElementById('gamesContent');
  gc.innerHTML='<div class="game-card" onclick="selectGame(\'rps\')"><div class="g-icon">🎲</div><div class="g-info"><div class="g-name">'+t('rps')+'</div><div class="g-desc">'+t('rpsDesc')+'</div></div></div><div class="game-card" onclick="selectGame(\'ttt\')"><div class="g-icon">❌</div><div class="g-info"><div class="g-name">'+t('tttName')+'</div><div class="g-desc">'+t('tttDesc')+'</div></div></div><div class="game-card" onclick="selectGame(\'checkers\')"><div class="g-icon">♟</div><div class="g-info"><div class="g-name">'+t('checkersName')+'</div><div class="g-desc">'+t('checkersDesc')+'</div></div></div><div class="game-card" onclick="selectGame(\'durak\')"><div class="g-icon">🃏</div><div class="g-info"><div class="g-name">'+t('durakName')+'</div><div class="g-desc">'+t('durakDesc')+'</div></div></div>';
}
function selectGame(game){
  selectedGame=game;
  const gc=document.getElementById('gamesContent');
  // Cross-reference with actual online users
  const onlineIds=new Set((window._onlineUsers||[]).map(u=>u.id));
  const onlineFriends=friendsList.filter(f=>f.online||onlineIds.has(f.id));
  const gameNames={rps:t('rps'),ttt:t('tttName'),checkers:t('checkersName'),durak:t('durakName')};
  const gameIcons={rps:'🎲',ttt:'❌',checkers:'♟',durak:'🃏'};
  let h='<div class="game-card" style="pointer-events:none;opacity:.7"><div class="g-icon">'+gameIcons[game]+'</div><div class="g-info"><div class="g-name">'+(gameNames[game]||game)+'</div></div></div>';
  h+='<div class="game-pick-title">'+t('pickOpponent')+'</div>';
  if(onlineFriends.length===0){h+='<div style="text-align:center;color:var(--td);font-size:.8rem;padding:16px">'+t('noFriendsOnline')+'</div>'}
  else{onlineFriends.forEach(f=>{h+='<div class="game-friend-row" onclick="startGameWith(\''+f.id+'\')"><span class="av">'+(f.avatar||'🐱')+'</span><span class="nm">'+f.displayName+'</span><div class="dot on" style="width:8px;height:8px;border-radius:50%;background:var(--a);box-shadow:0 0 6px var(--ag)"></div></div>'})}
  h+='<div style="text-align:center;margin-top:10px"><button class="mini-btn" onclick="selectedGame=null;renderGamesList()">← '+(t('close')||'Назад')+'</button></div>';
  gc.innerHTML=h;
}
function startGameWith(id){
  if(!selectedGame)return;
  document.getElementById('gamesP').classList.remove('show');
  if(selectedGame==='rps'){rpsInv(id)}
  else if(selectedGame==='ttt'){tttInvite(id)}
  else if(selectedGame==='checkers'){ckInvite(id)}
  else if(selectedGame==='durak'){dkInvite(id)}
  selectedGame=null;
}

// === TIC-TAC-TOE CLIENT ===
let tttGame=null;
function tttInvite(id){if(!ws)return;ws.send(JSON.stringify({type:'ttt_invite',target:id}));ensureChat(id,id);addToChat(id,{type:'y',text:'❌ '+(t('tttInviteSent'))})}
function tttAccept(from){if(!ws)return;ws.send(JSON.stringify({type:'ttt_accept',target:from}))}
function tttRender(){
  if(!tttGame)return;
  const g=tttGame,myMark=g.x===myId?'x':'o',myTurn=g.turn===myMark;
  let h='<div class="ttt-title">❌⭕ '+(t('tttName'))+'</div>';
  h+='<div class="ttt-status">'+(myTurn?('🟢 '+(t('yourTurn')||'Ваш ход')+' — '+(myMark==='x'?'❌':'⭕')):('⏳ '+(t('oppTurn')||'Ход соперника')))+'</div>';
  h+='<div class="ttt-board">';
  for(let i=0;i<9;i++){
    const v=g.board[i];
    let cls='ttt-cell';
    if(v==='x')cls+=' x';if(v==='o')cls+=' o';
    h+='<div class="'+cls+'" onclick="tttClick('+i+')">'+(v==='x'?'✕':v==='o'?'◯':'')+'</div>';
  }
  h+='</div>';
  h+='<div style="font-size:.7rem;color:var(--td)">'+t('yourMark')+': '+(myMark==='x'?'❌ ✕':'⭕ ◯')+'</div>';
  document.getElementById('tttModal').innerHTML=h;
}
function tttClick(i){if(!tttGame||!ws)return;const myMark=tttGame.x===myId?'x':'o';if(tttGame.turn!==myMark||tttGame.board[i])return;ws.send(JSON.stringify({type:'ttt_move',gameId:tttGame.gameId,cell:i}))}

// === DURAK CLIENT ===
let dkGame=null,dkSel=null,dkSelDefend=null;
function dkInvite(id){if(!ws)return;ws.send(JSON.stringify({type:'durak_invite',target:id}));ensureChat(id,id);addToChat(id,{type:'y',text:'🃏 '+(t('dkInviteSent')||'Приглашение в Дурака отправлено')})}
function dkAccept(from){if(!ws)return;ws.send(JSON.stringify({type:'durak_accept',target:from}))}
function dkCardHtml(card,cls,onclick){
  const isRed=card.suit==='♥'||card.suit==='♦';
  return '<div class="dk-card white'+(isRed?' red':'')+' '+(cls||'')+'"'+(onclick?' onclick="'+onclick+'"':'')+'><div>'+card.rank+'</div><div>'+card.suit+'</div></div>';
}
function dkRender(){
  if(!dkGame)return;
  const g=dkGame,isAtt=g.attacker===g.myId,isDef=g.defender===g.myId;
  const unbeaten=g.table.filter(x=>!x.defense);
  const allBeaten=g.table.length>0&&g.table.every(x=>x.defense);
  const isRedTrump=g.trump==='♥'||g.trump==='♦';
  let h='<div class="dk-title">🃏 '+(t('durakName')||'ДУРАК')+'</div>';
  // Info bar
  h+='<div class="dk-info"><span>'+t('deckLeft')+': '+g.deckLeft+'</span><span class="dk-trump '+(isRedTrump?'red':'black')+'">'+t('trumpSuit')+': '+g.trump+'</span></div>';
  // Status
  if(isAtt)h+='<div class="dk-status" style="color:var(--a)">⚔️ '+t('youAttack')+'</div>';
  else h+='<div class="dk-status" style="color:var(--purple)">🛡 '+t('youDefend')+'</div>';
  // Opponent cards
  h+='<div class="dk-opp"><div class="dk-opp-cards">';
  for(let i=0;i<g.oppCards;i++)h+='<div class="dk-opp-card">🂠</div>';
  h+='</div></div>';
  // Table
  h+='<div class="dk-table">';
  if(g.table.length===0)h+='<div style="color:rgba(255,255,255,.2);font-size:.75rem;padding:20px">'+(isAtt?'⬇️':'⏳')+'</div>';
  g.table.forEach((pair,i)=>{
    h+='<div class="dk-pair">';
    h+=dkCardHtml(pair.attack,'');
    if(pair.defense)h+=dkCardHtml(pair.defense,'def-card');
    else if(isDef)h+='<div class="dk-card back def-card" style="opacity:.3;width:44px;height:62px" onclick="dkDefendSlot('+i+')"></div>';
    h+='</div>';
  });
  h+='</div>';
  // My hand
  h+='<div class="dk-hand">';
  (g.hand||[]).forEach(card=>{
    let cls='';
    if(dkSel===card.id)cls='sel';
    else if(isAtt&&canThrowClient(g.table,card))cls='playable';
    else if(isDef&&dkSelDefend!==null&&canBeatClient(g.table[dkSelDefend]?.attack,card,g.trump))cls='playable';
    h+=dkCardHtml(card,cls,"dkClickCard('"+card.id+"')");
  });
  h+='</div>';
  // Actions
  h+='<div class="dk-actions">';
  if(isAtt&&allBeaten)h+='<button class="green" onclick="dkAction(\'done\')">✅ '+t('donAtk')+'</button>';
  if(isAtt&&allBeaten&&g.hand.length>0){
    const canThrowAny=g.hand.some(c=>canThrowClient(g.table,c));
    if(canThrowAny)h+='<button onclick="dkAction(\'throwSel\')">➕ '+t('throwMore')+'</button>';
  }
  if(isDef&&unbeaten.length>0)h+='<button class="red" onclick="dkAction(\'take\')">📥 '+t('takCards')+'</button>';
  h+='<button class="red" onclick="dkResign()">🏳 '+t('resign')+'</button>';
  h+='</div>';
  document.getElementById('dkModal').innerHTML=h;
}
function canThrowClient(table,card){
  if(table.length===0)return true;
  for(const t of table){if(t.attack.rank===card.rank)return true;if(t.defense&&t.defense.rank===card.rank)return true}
  return false;
}
function canBeatClient(attack,defense,trump){
  if(!attack||!defense)return false;
  const RV={'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
  if(defense.suit===attack.suit)return RV[defense.rank]>RV[attack.rank];
  if(defense.suit===trump)return true;
  return false;
}
function dkClickCard(cardId){
  if(!dkGame)return;
  const g=dkGame,isAtt=g.attacker===g.myId;
  if(isAtt){
    // Attack or throw
    const card=g.hand.find(c=>c.id===cardId);
    if(!card)return;
    if(!canThrowClient(g.table,card))return;
    const unbeaten=g.table.filter(x=>!x.defense);
    if(g.table.length===0||unbeaten.length===0){
      // Direct attack/throw
      const action=g.table.length===0?'attack':'throw';
      ws.send(JSON.stringify({type:'durak_action',gameId:g.gameId,action,cardId}));
    }else{
      dkSel=cardId;dkRender();
    }
  }else{
    // Defending: select card then click table slot
    dkSel=dkSel===cardId?null:cardId;
    dkRender();
  }
}
function dkDefendSlot(idx){
  if(!dkGame||!dkSel)return;
  ws.send(JSON.stringify({type:'durak_action',gameId:dkGame.gameId,action:'defend',cardId:dkSel,tableIdx:idx}));
  dkSel=null;dkSelDefend=null;
}
function dkAction(action){
  if(!dkGame||!ws)return;
  if(action==='throwSel'&&dkSel){ws.send(JSON.stringify({type:'durak_action',gameId:dkGame.gameId,action:'throw',cardId:dkSel}));dkSel=null;return}
  ws.send(JSON.stringify({type:'durak_action',gameId:dkGame.gameId,action}));
}
function dkResign(){if(!dkGame||!ws)return;if(!confirm(t('resignConfirm')||'Сдаться?'))return;ws.send(JSON.stringify({type:'durak_resign',gameId:dkGame.gameId}))}
let sto;function doSearch(){clearTimeout(sto);sto=setTimeout(()=>{const q=document.getElementById('searchI').value.trim();if(q.length<2){document.getElementById('searchR').innerHTML='';return}fetch(API+'/search?q='+encodeURIComponent(q)).then(r=>r.json()).then(d=>{const el=document.getElementById('searchR');el.innerHTML='';(d.users||[]).forEach(u=>{const isFr=friendsList.some(f=>f.id===u.id);const div=document.createElement('div');div.className='p-row';div.innerHTML='<span class="av">'+u.avatar+'</span><span class="name">'+u.displayName+' <span class="lvl-badge">LV'+u.level+'</span> '+(isFr?'<span class="friend-badge">друг</span>':'')+'</span><div class="p-row-actions"><button class="mini-btn" onclick="event.stopPropagation();document.getElementById(\'pId\').value=\''+u.id+'\';doConn();toggleP(\'sP\')">💬</button>'+(isFr?'':'<button class="mini-btn" onclick="event.stopPropagation();addFD(\''+u.id+'\')">➕</button>')+'<button class="mini-btn danger" onclick="event.stopPropagation();blockU(\''+u.id+'\')">🚫</button></div><div class="dot '+(u.online?'on':'off')+'"></div>';el.appendChild(div)})}).catch(()=>{})},300)}
function timeAgo(d){if(!d)return'';const ms=Date.now()-new Date(d).getTime();const m=Math.floor(ms/60000);if(m<1)return t('justNow')||'только что';if(m<60)return m+' '+(t('minAgo')||'мин назад');const h=Math.floor(m/60);if(h<24)return h+' '+(t('hAgo')||'ч назад');const dy=Math.floor(h/24);return dy+' '+(t('dAgo')||'д назад')}
function renderFriends(){const el=document.getElementById('fL2');el.innerHTML='';friendsList.forEach(f=>{const d=document.createElement('div');d.className='p-row';const lastSeen=f.online?'':(f.lastLogin?timeAgo(f.lastLogin):'');d.innerHTML='<span class="av">'+f.avatar+'</span><span class="name">'+f.displayName+' <span class="lvl-badge">LV'+f.level+'</span></span><span class="st">'+(f.online?(f.status?'• '+f.status:''):('<span style="font-size:.6rem;color:var(--td)">'+lastSeen+'</span>'))+'</span><div class="p-row-actions"><button class="mini-btn" onclick="event.stopPropagation();document.getElementById(\'pId\').value=\''+f.id+'\';doConn();toggleP(\'fP\')">💬</button><button class="mini-btn danger" onclick="event.stopPropagation();remFr(\''+f.id+'\')">✕</button><button class="mini-btn danger" onclick="event.stopPropagation();blockU(\''+f.id+'\')">🚫</button></div><div class="dot '+(f.online?'on':'off')+'"></div>';d.onclick=()=>{showProfile(f.id)};el.appendChild(d)});renderGM()}
function addFriend(){const l=document.getElementById('addFI').value.trim();if(!l||!ws)return;ws.send(JSON.stringify({type:'add_friend',login:l}));document.getElementById('addFI').value=''}
function addFD(l){if(ws)ws.send(JSON.stringify({type:'add_friend',login:l}))}
function remFr(l){if(ws)ws.send(JSON.stringify({type:'remove_friend',login:l}))}
function blockU(l){if(!ws||!confirm('Заблокировать '+l+'?'))return;ws.send(JSON.stringify({type:'block_user',login:l}))}
function unblockU(l){if(ws)ws.send(JSON.stringify({type:'unblock_user',login:l}))}
function renderBlocks(){const el=document.getElementById('blL');el.innerHTML='';blockList.forEach(b=>{const d=document.createElement('div');d.className='p-row';d.innerHTML='<span class="name">'+b.displayName+'</span><button class="mini-btn" onclick="unblockU(\''+b.id+'\')">Разблокировать</button>';el.appendChild(d)})}
function rOL(u){
  window._onlineUsers=u;
  // Update friends online status
  const onlineIds=new Set(u.map(x=>x.id));
  friendsList.forEach(f=>{f.online=onlineIds.has(f.id)});
  // Render online list
  const el=document.getElementById('oL');el.innerHTML='';const fIds=friendsList.map(f=>f.id);u.filter(x=>x.id!==myId&&!x.isGuest).forEach(x=>{const d=document.createElement('div');d.className='p-row';const isFr=fIds.includes(x.id);d.innerHTML='<span class="av">'+(x.avatar||'🐱')+'</span><span class="name">'+x.displayName+' <span class="lvl-badge">LV'+(x.level||1)+'</span> '+(isFr?'<span class="friend-badge">друг</span>':'')+'</span><span class="st">'+(x.status?'• '+x.status:'')+'</span><div class="dot on"></div>';d.onclick=()=>{showProfile(x.id)};el.appendChild(d)});
  // Re-render friends if panel open
  if(document.getElementById('fP').classList.contains('show'))renderFriends();
}
function renderGroups(){const el=document.getElementById('gL');el.innerHTML='';groupsList.forEach(g=>{const d=document.createElement('div');d.className='p-row';d.innerHTML='<span class="av">'+g.avatar+'</span><span class="name">'+g.name+'</span><span class="st">'+g.members.length+' чел.</span>';d.onclick=()=>{ensureChat(g.id,g.name,g.avatar,true);switchChat(g.id);toggleP('gP')};el.appendChild(d)})}
function renderGM(){const el=document.getElementById('grpMemPick');el.innerHTML='';grpSel.clear();friendsList.forEach(f=>{const d=document.createElement('div');d.className='grp-mem';d.textContent=f.avatar+' '+f.displayName;d.onclick=()=>{if(grpSel.has(f.id)){grpSel.delete(f.id);d.classList.remove('sel')}else{grpSel.add(f.id);d.classList.add('sel')}};el.appendChild(d)})}
function createGroup(){const n=document.getElementById('grpName').value.trim();if(!n||grpSel.size<1)return;ws.send(JSON.stringify({type:'create_group',name:n,members:[...grpSel]}));document.getElementById('grpName').value='';document.getElementById('grpC').classList.remove('show')}
function rpsInv(id){if(!ws)return;ws.send(JSON.stringify({type:'rps_invite',target:id}));document.getElementById('rpsBar').classList.add('show');document.getElementById('rpsTitle').textContent='🎲 Выберите!';document.getElementById('rpsBar').dataset.target=id}
function rpsPlay(c){const t=document.getElementById('rpsBar').dataset.target||activeChat;if(!t||!ws)return;ws.send(JSON.stringify({type:'rps_choice',target:t,choice:c}));document.getElementById('rpsTitle').textContent='⏳ Ждём...';document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='none');setTimeout(()=>{document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='');document.getElementById('rpsBar').classList.remove('show')},15000)}
function setReply(id,text){replyToId=id;replyToText=text;document.getElementById('replyText').textContent=text.substring(0,60);document.getElementById('replyBar').classList.add('show');document.getElementById('mI').focus()}
function cancelReply(){replyToId=null;replyToText=null;document.getElementById('replyBar').classList.remove('show')}
function ensureChat(id,nm,av,isGrp){if(!chats[id])chats[id]={displayName:nm||id,avatar:av||'👤',messages:[],unread:0,isGroup:!!isGrp};else{if(nm)chats[id].displayName=nm;if(av)chats[id].avatar=av}renderTabs()}
function switchChat(id){activeChat=id;if(chats[id])chats[id].unread=0;renderTabs();renderMsgs()}
function closeTab(id,e){e.stopPropagation();delete chats[id];if(activeChat===id)activeChat=Object.keys(chats)[0]||null;renderTabs();renderMsgs()}
function renderTabs(){const c=document.getElementById('chatTabs');c.innerHTML='';const keys=Object.keys(chats);
document.getElementById('cC').style.display=keys.length>0?'none':'flex';
keys.forEach(id=>{const ch=chats[id];const d=document.createElement('div');d.className='chat-tab'+(activeChat===id?' active':'');let h='<span>'+ch.avatar+' '+ch.displayName+'</span>';if(ch.unread>0)h+='<span class="unread">'+ch.unread+'</span>';h+='<span class="close-tab" onclick="closeTab(\''+id+'\',event)">✕</span>';d.innerHTML=h;d.onclick=()=>switchChat(id);c.appendChild(d)})}
function renderMsgs(){const a=document.getElementById('msgArea');a.innerHTML='';if(!activeChat||!chats[activeChat])return;const ch=chats[activeChat];ch.messages.forEach(m=>{if(m.poll){renderPoll(a,m);return}if(m.type==='y'){const d=document.createElement('div');d.className='m y';d.innerHTML=m.text;a.appendChild(d);return}const row=document.createElement('div');row.className='msg-row'+(m.type==='s'?' sent':'');if(m.type==='r'){const avD=document.createElement('div');avD.className='msg-av';avD.textContent=ch.avatar||'👤';row.appendChild(avD)}const d=document.createElement('div');d.className='m '+m.type;let h='';if(m.type==='r'&&m.from)h+='<div class="mf" onclick="showProfile(\''+(m.fromId||'')+'\')">'+(m.from)+'</div>';if(m.replyText)h+='<div class="reply-block">↩️ '+m.replyText.substring(0,50)+'</div>';h+=m.text;h+='<div class="mm"><span class="mt">'+m.time+'</span>';if(m.type==='s')h+='<span class="ms-icon" id="st-'+m.id+'">✓</span>';h+='</div>';const safeText=(m.text||'').replace(/<[^>]*>/g,'').replace(/'/g,"\\'").replace(/"/g,'&quot;');h+='<div class="m-actions"><div class="m-act" onclick="setReply(\''+m.id+'\',\''+safeText+'\')">↩️</div><div class="m-act" onclick="sRx(\''+m.id+'\',this.closest(\'.m\'))">😊</div></div>';d.innerHTML=h;if(m.id)mE[m.id]=d;row.appendChild(d);a.appendChild(row)});a.scrollTop=a.scrollHeight}
function renderPoll(a,m){const d=document.createElement('div');d.className='poll-box';d.style.alignSelf=m.type==='s'?'flex-end':'flex-start';let h='<div class="poll-q">📊 '+m.poll.question+'</div>';const v=polls[m.poll.pollId]||{};m.poll.options.forEach((opt,i)=>{const cnt=Object.values(v).filter(x=>x===i).length;const voted=v[myId]===i;h+='<div class="poll-opt'+(voted?' voted':'')+'" onclick="votePoll(\''+m.poll.groupId+'\',\''+m.poll.pollId+'\','+i+')">'+opt+' <span>'+cnt+'</span></div>'});d.innerHTML=h;a.appendChild(d)}
function votePoll(g,p,o){if(!ws)return;ws.send(JSON.stringify({type:'poll_vote',groupId:g,pollId:p,option:o}));if(!polls[p])polls[p]={};polls[p][myId]=o;renderMsgs()}
function addToChat(pid,msg){ensureChat(pid);chats[pid].messages.push(msg);if(activeChat===pid)renderMsgs();else{chats[pid].unread++;renderTabs()}}
function ts(){const n=new Date();return String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')}
function initE(){const g=document.getElementById('eP');let h='<div class="eg">';EM.forEach(e=>{h+='<div class="ei" onclick="iE(\''+e+'\')">'+e+'</div>'});h+='</div>';g.innerHTML=h}
function iE(e){document.getElementById('mI').value+=e;document.getElementById('eP').classList.remove('show');document.getElementById('mI').focus()}
function sRx(mid,el){rTgt=mid;const p=document.getElementById('rPk');const r=el.getBoundingClientRect();p.style.top=(r.top-34)+'px';p.style.left=Math.min(r.left,window.innerWidth-190)+'px';p.classList.add('show');setTimeout(()=>document.addEventListener('click',hRx,{once:true}),10)}
function hRx(){document.getElementById('rPk').classList.remove('show')}
function doReact(em){if(!rTgt||!ws||!activeChat)return;ws.send(JSON.stringify({type:'reaction',target:activeChat,msgId:rTgt,emoji:em}));const el=mE[rTgt];if(el){let r=el.querySelector('.mr');if(!r){r=document.createElement('div');r.className='mr';el.appendChild(r)}r.textContent=em}hRx()}
const vAudios={};
function mkVoice(src,id){vAudios[id]=src;let bars='';for(let i=0;i<20;i++){const h=Math.floor(Math.random()*16)+4;bars+='<div class="voice-bar" style="height:'+h+'px"></div>'}return '<div class="voice-msg"><button class="voice-btn" id="vb-'+id+'" onclick="playV(\''+id+'\')">▶</button><div class="voice-wave" id="vw-'+id+'">'+bars+'</div><span class="voice-time" id="vt-'+id+'">0:00</span></div>'}
function playV(id){const src=vAudios[id];if(!src)return;const btn=document.getElementById('vb-'+id);const wave=document.getElementById('vw-'+id);const tm=document.getElementById('vt-'+id);if(btn.dataset.playing==='1'){if(btn._audio){btn._audio.pause();btn._audio.currentTime=0}btn.textContent='▶';btn.classList.remove('playing');btn.dataset.playing='0';if(wave)wave.querySelectorAll('.voice-bar').forEach(b=>b.classList.remove('active'));return}const a=new Audio(src);btn._audio=a;btn.textContent='⏸';btn.classList.add('playing');btn.dataset.playing='1';let vi=0;const bars=wave?wave.querySelectorAll('.voice-bar'):[];const iv=setInterval(()=>{if(a.paused){clearInterval(iv);return}bars.forEach(b=>b.classList.remove('active'));if(bars.length>0){const pos=Math.floor((a.currentTime/Math.max(a.duration,1))*bars.length);for(let i=0;i<=pos&&i<bars.length;i++)bars[i].classList.add('active')}const s=Math.floor(a.currentTime);tm.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0')},100);a.onended=()=>{clearInterval(iv);btn.textContent='▶';btn.classList.remove('playing');btn.dataset.playing='0';bars.forEach(b=>b.classList.remove('active'));const dur=Math.floor(a.duration);tm.textContent=Math.floor(dur/60)+':'+String(dur%60).padStart(2,'0')};a.play().catch(()=>{btn.textContent='▶';btn.dataset.playing='0'})}
async function srec(){if(!activeChat)return;try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mRec=new MediaRecorder(s);aCh=[];isRec=true;document.getElementById('mic').classList.add('rec');mRec.ondataavailable=e=>aCh.push(e.data);mRec.onstop=()=>{s.getTracks().forEach(t=>t.stop());const b=new Blob(aCh,{type:'audio/webm'});const r=new FileReader();r.onloadend=()=>{const mid=Date.now().toString(36);const vHtml=mkVoice(r.result,mid);addToChat(activeChat,{type:'s',text:vHtml,time:ts(),id:mid,isVoice:true});sS();const ch=chats[activeChat];if(ch&&ch.isGroup){ws.send(JSON.stringify({type:'group_message',groupId:activeChat,text:'🎤 Голосовое',msgId:mid}))}else{ws.send(JSON.stringify({type:'voice',target:activeChat,audio:r.result,duration:3,msgId:mid}))}};r.readAsDataURL(b)};mRec.start()}catch(e){}}
function erec(){if(mRec&&isRec){mRec.stop();isRec=false;document.getElementById('mic').classList.remove('rec')}}
function handle(m){switch(m.type){
case'auth_success':myId=m.id;myName=m.displayName;isG=m.isGuest;myAvatar=m.avatar||'👤';myStatus=m.status||'';myXP=m.xp||0;myLevel=m.level||1;myCoins=m.coins||0;showChat();document.getElementById('stB').textContent=isG?'АНОНИМ':'ОНЛАЙН';sC();if(!isG&&ws){ws.send(JSON.stringify({type:'get_online'}));ws.send(JSON.stringify({type:'get_friends'}));ws.send(JSON.stringify({type:'get_groups'}));ws.send(JSON.stringify({type:'get_blocks'}))}break;
case'auth_error':se(m.text);break;case'kicked':doLogout();break;
case'connected':ensureChat(m.peer,m.displayName,m.avatar);switchChat(m.peer);addToChat(m.peer,{type:'y',text:'Подключено к «'+m.displayName+'»'});sC();break;
case'message':ensureChat(m.from,m.displayName,m.avatar);var mm={type:'r',text:m.text,from:m.displayName||m.from,fromId:m.from,time:ts(),id:m.msgId};if(m.replyText)mm.replyText=m.replyText;addToChat(m.from,mm);sR2();if(ws)ws.send(JSON.stringify({type:'read',target:m.from,msgId:m.msgId}));break;
case'voice':ensureChat(m.from,m.displayName,m.avatar);var vH=mkVoice(m.audio,m.msgId);addToChat(m.from,{type:'r',text:vH,from:m.displayName||m.from,time:ts(),id:m.msgId,isVoice:true});sR2();break;
case'group_message':var grp=groupsList.find(g=>g.id===m.groupId);ensureChat(m.groupId,grp?.name||m.groupId,grp?.avatar||'👥',true);var gm={type:'r',text:m.text,from:m.displayName||m.from,fromId:m.from,time:ts(),id:m.msgId};if(m.replyText)gm.replyText=m.replyText;addToChat(m.groupId,gm);sR2();break;
case'xp_update':myXP=m.xp;myLevel=m.level;updateXP();break;
case'achievement':showAchToast(m.ids);break;
case'coins_update':myCoins=m.coins;const mc2=document.getElementById('menuCoins');if(mc2)mc2.textContent='🪙 '+myCoins+' '+t('coins');break;
case'shop_success':myCoins=m.coins;if(m.itemId&&m.itemId.startsWith('av_')){const SHOP_AV={'av_dragon':'🐉','av_phoenix':'🦅','av_robot':'🤖','av_alien':'👽','av_ghost':'👻','av_crown':'👸','av_devil':'😈','av_skull':'💀'};myAvatar=SHOP_AV[m.itemId]||myAvatar;document.getElementById('menuAv').textContent=myAvatar}openShop();break;
case'shop_error':alert(m.text==='Not enough coins'?(t('notEnough')):m.text);break;
case'leaderboard':lbData=m;renderLB();break;
case'channels_list':channelsList=m.channels||[];renderChannels();break;
case'channel_created':if(ws)ws.send(JSON.stringify({type:'get_channels'}));break;
case'channel_history':if(m.channelId&&chats[m.channelId]){chats[m.channelId].messages=[];(m.messages||[]).forEach(msg=>{addToChat(m.channelId,{type:'r',text:msg.text,from:msg.display_name||msg.sender,fromId:msg.sender,time:new Date(msg.created_at).toLocaleTimeString().slice(0,5),id:'ch_'+msg.id})});renderMsgs()}break;
case'channel_msg':if(m.channelId){ensureChat(m.channelId,m.channelId,'📢',false);chats[m.channelId].isChannel=true;addToChat(m.channelId,{type:'r',text:m.text,from:m.displayName||m.from,fromId:m.from,time:ts(),id:'chm_'+Date.now()});sR2()}break;
case'channels_search_result':renderChSearch(m.channels||[]);break;
case'wheel_result':{
  myCoins=m.totalCoins;const mc3=document.getElementById('menuCoins');if(mc3)mc3.textContent='🪙 '+myCoins+' '+t('coins');
  // Find segment index by matching prize label
  const prizeMap={'🪙 5':0,'🪙 10':2,'🪙 25':4,'🪙 50':6,'🪙 100':8,'✨ 10 XP':1,'✨ 25 XP':5,'✨ 50 XP':7,'💀 0':3,'🎁 ALL':9};
  const idx=prizeMap[m.prize]||0;
  animateWheel(idx);
  setTimeout(()=>{
    const rd=document.getElementById('wheelRes');if(!rd)return;
    if(m.prizeType==='nothing')rd.innerHTML='<span style="color:var(--td)">💀 '+t('wheelLost')+'</span>';
    else if(m.prizeType==='jackpot')rd.innerHTML='<span style="color:#f472b6;font-size:1.3rem">🎁 '+t('wheelJackpot')+' +50🪙 +100XP</span>';
    else rd.innerHTML='<span style="color:var(--a)">🎉 '+t('wheelWon')+' '+m.prize+'</span>';
    const wi=document.getElementById('wheelInfo');if(wi)wi.textContent=t('wheelCooldown')+': 60 '+t('wheelMin');
  },4200);
  break;
}
case'wheel_cooldown':{
  const rd2=document.getElementById('wheelRes');if(rd2)rd2.innerHTML='<span style="color:var(--td)">⏳</span>';
  const wi2=document.getElementById('wheelInfo');if(wi2)wi2.textContent=t('wheelCooldown')+': '+m.minutes+' '+t('wheelMin');
  wheelSpinning=false;break;
}
case'pet_update':if(m.coins!==undefined){myCoins=m.coins;const mc4=document.getElementById('menuCoins');if(mc4)mc4.textContent='🪙 '+myCoins+' '+t('coins')}if(m.hunger!==undefined){petState.hunger=m.hunger;petState.happy=m.happy;petState.xp=m.xp;if(m.sick!==undefined)petState.sick=m.sick;if(document.getElementById('petBg').classList.contains('show'))renderPetScreen()}break;
case'pet_room_update':if(m.coins!==undefined){myCoins=m.coins;const mc5=document.getElementById('menuCoins');if(mc5)mc5.textContent='🪙 '+myCoins+' '+t('coins')}petState.room=m.room||[];openPetRoom();break;
case'pet_wardrobe_update':if(m.coins!==undefined){myCoins=m.coins;const mc6=document.getElementById('menuCoins');if(mc6)mc6.textContent='🪙 '+myCoins+' '+t('coins')}petState.wardrobe=m.wardrobe||[];openPetWardrobe();break;
case'pet_equip_ok':petState.hat=m.hat||'';petState.costume=m.costume||'';openPetWardrobe();break;
case'checkers_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'♟ '+m.displayName+' '+(t('ckInviteMsg')||'приглашает в шашки!')+'<br><button class="mini-btn" onclick="ckAccept(\''+m.from+'\')">✅ '+(t('accept')||'Принять')+'</button>'});sR2();break;
case'checkers_start':ckStartGame(m);break;
case'checkers_update':if(ckGame&&ckGame.id===m.gameId){ckGame.board=m.board;ckGame.turn=m.turn;ckGame.lastMove=m.lastMove;if(m.mustContinue){ckMust=m.continueFrom;ckSel=m.continueFrom}else{ckMust=null;ckSel=null}ckRender()}break;
case'checkers_end':if(ckGame&&ckGame.id===m.gameId){ckGame.board=m.board;ckGame=null;ckSel=null;ckMust=null;const won=m.winnerId===myId;const md=document.getElementById('ckModal');md.innerHTML='<div class="ck-title">♟ '+(t('gameOver')||'ИГРА ОКОНЧЕНА')+'</div><div style="font-size:2rem;margin:16px 0">'+(won?'🏆':'😔')+'</div><div class="ck-status">'+(m.resigned?(t('oppResigned')||'Соперник сдался!'):(won?(t('youWin')||'Вы победили!'):(t('youLose')||'Вы проиграли')))+'</div>'+(won?'<div style="color:var(--a);font-size:.75rem;margin:6px 0">+15 XP</div>':'')+'<div class="ck-actions"><button onclick="document.getElementById(\'ckBg\').classList.remove(\'show\')">'+(t('close')||'Закрыть')+'</button></div>';if(won)sC();else sR2()}break;
case'durak_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'🃏 '+m.displayName+' '+(t('dkInviteMsg')||'приглашает в Дурака!')+'<br><button class="mini-btn" onclick="dkAccept(\''+m.from+'\')">✅ '+(t('accept')||'Принять')+'</button>'});sR2();break;
case'ttt_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'❌ '+m.displayName+' '+(t('tttInviteMsg')||'приглашает в крестики-нолики!')+'<br><button class="mini-btn" onclick="tttAccept(\''+m.from+'\')">✅ '+(t('accept')||'Принять')+'</button>'});sR2();break;
case'ttt_start':tttGame=m;document.getElementById('tttBg').classList.add('show');tttRender();break;
case'ttt_update':if(tttGame)Object.assign(tttGame,m);tttRender();break;
case'ttt_end':if(tttGame){const won=m.winner===myId;const isDraw=m.isDraw;tttGame=null;const md=document.getElementById('tttModal');md.innerHTML='<div class="ttt-title">❌⭕ '+(t('gameOver')||'ИГРА ОКОНЧЕНА')+'</div><div style="font-size:2.5rem;margin:14px 0">'+(isDraw?'🤝':(won?'🏆':'😔'))+'</div><div class="ttt-status">'+(isDraw?(t('draw')||'Ничья!'):(won?(t('youWin')||'Вы победили!'):(t('youLose')||'Вы проиграли')))+'</div>'+(won?'<div style="color:var(--a);font-size:.75rem;margin:6px 0">+5 XP</div>':'')+'<div style="margin-top:10px"><button class="mini-btn" onclick="document.getElementById(\'tttBg\').classList.remove(\'show\')">'+(t('close')||'Закрыть')+'</button></div>';if(won)sC();else sR2()}break;
case'durak_start':document.getElementById('dkBg').classList.add('show');break;
case'durak_update':dkGame=m;dkSel=null;dkSelDefend=null;dkRender();break;
case'durak_end':if(dkGame){const won=m.winner===myId;const isDraw=m.isDraw;dkGame=null;dkSel=null;const md=document.getElementById('dkModal');md.innerHTML='<div class="dk-title">🃏 '+(t('gameOver')||'ИГРА ОКОНЧЕНА')+'</div><div style="font-size:2rem;margin:16px 0">'+(isDraw?'🤝':(won?'🏆':'😔'))+'</div><div class="dk-status" style="color:var(--tm)">'+(m.resigned?(t('oppResigned')||'Соперник сдался!'):(isDraw?'🤝 Ничья!':(won?(t('youWin')||'Вы победили!'):(t('youLose')||'Вы проиграли'))))+'</div>'+(won?'<div style="color:var(--a);font-size:.75rem;margin:6px 0">+15 XP</div>':'')+'<div class="dk-actions"><button onclick="document.getElementById(\'dkBg\').classList.remove(\'show\')">'+(t('close')||'Закрыть')+'</button></div>';if(won)sC();else sR2()}break;
case'typing':var el2=document.getElementById('ti');el2.textContent=(m.from||'')+' печатает...';el2.classList.add('v');clearTimeout(tto);tto=setTimeout(()=>el2.classList.remove('v'),2000);break;
case'delivered':var s2=document.getElementById('st-'+m.msgId);if(s2)s2.textContent='✓';break;
case'read':var s3=document.getElementById('st-'+m.msgId);if(s3){s3.textContent='✓✓';s3.style.color='var(--a)'}break;
case'reaction':var el3=mE[m.msgId];if(el3){var r2=el3.querySelector('.mr');if(!r2){r2=document.createElement('div');r2.className='mr';el3.appendChild(r2)}r2.textContent=m.emoji}break;
case'user_offline':if(chats[m.id])addToChat(m.id,{type:'y',text:'Вышел из сети'});if(!isG&&ws)ws.send(JSON.stringify({type:'get_online'}));break;
case'online_list':if(!isG)rOL(m.users);break;
case'user_online':case'user_updated':if(!isG&&ws)ws.send(JSON.stringify({type:'get_online'}));break;
case'friends_list':friendsList=m.friends;renderFriends();break;
case'groups_list':groupsList=m.groups;renderGroups();break;
case'block_list':blockList=m.blocked;renderBlocks();break;
case'user_blocked':if(chats[m.login]){delete chats[m.login];if(activeChat===m.login)activeChat=null;renderTabs();renderMsgs()}break;
case'group_created':addToChat(m.groupId,{type:'y',text:'Группа «'+m.name+'» создана!'});break;
case'friend_added_you':ensureChat(m.from);addToChat(m.from,{type:'y',text:m.displayName+' добавил(а) вас в друзья!'});if(ws)ws.send(JSON.stringify({type:'get_friends'}));break;
case'rps_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'🎲 '+m.displayName+' приглашает в КНБ!'});document.getElementById('rpsBar').classList.add('show');document.getElementById('rpsTitle').textContent='🎲 '+m.displayName+' вызвал вас!';document.getElementById('rpsBar').dataset.target=m.from;sR2();break;
case'rps_waiting':if(activeChat)addToChat(activeChat,{type:'y',text:'⏳ Ждём соперника...'});break;
case'rps_result':var ic={rock:'🪨',paper:'📄',scissors:'✂️'};var rm={win:'🏆 Победа!',lose:'😢 Поражение',draw:'🤝 Ничья'};ensureChat(m.opponent,m.opponentName);addToChat(m.opponent,{type:'y',text:ic[m.myChoice]+' vs '+ic[m.opChoice]+' — '+rm[m.result]});document.getElementById('rpsBar').classList.remove('show');document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='');if(m.result==='win')sC();else sR2();break;
case'poll':var pg=groupsList.find(g=>g.id===m.groupId);ensureChat(m.groupId,pg?.name||m.groupId,pg?.avatar||'👥',true);polls[m.pollId]={};addToChat(m.groupId,{type:'r',poll:{pollId:m.pollId,question:m.question,options:m.options,groupId:m.groupId},time:ts()});sR2();break;
case'poll_vote':if(!polls[m.pollId])polls[m.pollId]={};polls[m.pollId][m.voter]=m.option;if(activeChat===m.groupId)renderMsgs();break;
case'error':if(activeChat)addToChat(activeChat,{type:'y',text:m.text});break;
}}
function doConn(){const t=document.getElementById('pId').value.trim();if(!t||!ws)return;ws.send(JSON.stringify({type:'connect',target:t}));document.getElementById('pId').value=''}
function snd(){const i=document.getElementById('mI');const t=i.value.trim();if(!t||!ws||!activeChat)return;
// AI Bot intercept
if(t.startsWith('/ai')){const resp=handleAI(t);addToChat(activeChat,{type:'s',text:t,time:ts(),id:Date.now().toString(36)});setTimeout(()=>addToChat(activeChat,{type:'r',text:resp,from:'🤖 KÖRPÜ Bot',time:ts(),id:'ai_'+Date.now().toString(36)}),500);i.value='';renderMsgs();return}
// Channel message
const ach=chats[activeChat];
if(ach&&ach.isChannel){if(!ach.isOwner){addToChat(activeChat,{type:'y',text:'🔒 '+t('chOnlyOwner')});renderMsgs();i.value='';return}ws.send(JSON.stringify({type:'channel_message',channelId:activeChat,text:t}));addToChat(activeChat,{type:'s',text:t,time:ts(),id:'chs_'+Date.now().toString(36)});i.value='';renderMsgs();return}
const mid=Date.now().toString(36)+Math.random().toString(36).substr(2,3);const ch=chats[activeChat];const p={type:ch?.isGroup?'group_message':'message',target:activeChat,text:t,msgId:mid};if(ch?.isGroup)p.groupId=activeChat;if(replyToId){p.replyTo=replyToId;p.replyText=replyToText}ws.send(JSON.stringify(p));const mo={type:'s',text:t,time:ts(),id:mid};if(replyToId)mo.replyText=replyToText;addToChat(activeChat,mo);sS();i.value='';cancelReply();document.getElementById('eP').classList.remove('show')}
let lT=0;function hk(e){if(e.key==='Enter'){snd();return}if(activeChat&&ws&&Date.now()-lT>1000){ws.send(JSON.stringify({type:'typing',target:activeChat}));lT=Date.now()}}
window.addEventListener('load',()=>{
if(window.Telegram&&Telegram.WebApp){const tg=Telegram.WebApp;tg.expand();tg.setHeaderColor('#0a0a0f');tg.setBackgroundColor('#0a0a0f');try{tg.requestFullscreen()}catch(e){}function sa(){const s=tg.safeAreaInset||{},c=tg.contentSafeAreaInset||{};const top=38+Math.max(s.top||0,c.top||0);document.querySelector('.app').style.paddingTop=top+'px';const sm=document.getElementById('sideMenu');if(sm)sm.style.paddingTop=top+'px'}sa();tg.onEvent('safeAreaChanged',sa);tg.onEvent('contentSafeAreaChanged',sa);tg.onEvent('fullscreenChanged',sa)}
setTimeout(()=>document.getElementById('splash').classList.add('hidden'),1800);initE();initAP();applyLang();setTheme(curTheme);renderThemeDots();
const s=localStorage.getItem('kc');if(s){const c=JSON.parse(s);document.getElementById('savedInfo').style.display='';document.getElementById('savedU').textContent=c.l}
document.addEventListener('click',e=>{if(!e.target.closest('.ep')&&!e.target.closest('.ib'))document.getElementById('eP').classList.remove('show')})});
</script></body></html>

</script>
</body>
</html>