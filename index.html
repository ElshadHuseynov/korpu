<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K√ñRP√ú ‚Äî Chat</title>
  <style>
    :root {
      --font-size-base: 18px;
      --font-size-small: 16px;
      --font-size-large: 24px;
      --button-padding: 16px 32px;
      --input-padding: 14px 20px;
      --border-radius: 12px;
      --spacing-sm: 12px;
      --spacing-md: 20px;
      --spacing-lg: 30px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: var(--font-size-base);
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      width: 100%;
      display: flex;
      gap: var(--spacing-lg);
    }

    /* === AUTH FORMS === */
    .auth-form {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      min-width: 400px;
    }

    .auth-form h2 {
      text-align: center;
      font-size: var(--font-size-large);
      margin-bottom: var(--spacing-md);
      color: #667eea;
    }

    .auth-form label {
      display: block;
      margin-top: var(--spacing-sm);
      font-weight: 600;
      color: #333;
    }

    .auth-form input {
      width: 100%;
      padding: var(--input-padding);
      margin-top: var(--spacing-sm);
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      transition: border-color 0.3s;
    }

    .auth-form input:focus {
      outline: none;
      border-color: #667eea;
    }

    .auth-form button {
      width: 100%;
      padding: var(--button-padding);
      margin-top: var(--spacing-md);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .auth-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .auth-form button:active {
      transform: translateY(0);
    }

    .auth-form .switch {
      text-align: center;
      margin-top: var(--spacing-md);
      color: #666;
    }

    .auth-form .switch a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-form .switch a:hover {
      text-decoration: underline;
    }

    .guest-login {
      background: #f8f9fa;
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      text-align: center;
    }

    .guest-login h3 {
      margin-bottom: var(--spacing-sm);
      color: #666;
    }

    .guest-login button {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      margin-top: var(--spacing-sm);
    }

    /* === MAIN CHAT === */
    .main-chat {
      display: none;
      flex: 1;
      height: 80vh;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      position: relative;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .chat-header .logo {
      font-size: 48px;
      font-weight: bold;
      cursor: pointer;
    }

    .chat-header .status-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 12px 24px;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 120px;
    }

    .chat-header .status-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .chat-header .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 12px 24px;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 120px;
    }

    .chat-header .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .chat-layout {
      display: flex;
      height: calc(100% - 60px);
    }

    .sidebar {
      width: 320px;
      border-right: 1px solid #eee;
      display: flex;
      flex-direction: column;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid #eee;
    }

    .tab-btn {
      flex: 1;
      padding: var(--spacing-sm);
      background: none;
      border: none;
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      color: #666;
      transition: background 0.2s;
    }

    .tab-btn.active {
      color: #667eea;
      background: #f0f4ff;
    }

    .tab-btn:hover:not(.active) {
      background: #f5f5f5;
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-sm);
    }

    .user-item, .friend-item {
      display: flex;
      align-items: center;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      background: #f8f9fa;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-item:hover, .friend-item:hover {
      background: #e9ecef;
    }

    .user-avatar, .friend-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: white;
      margin-right: var(--spacing-sm);
      flex-shrink: 0;
    }

    .user-info, .friend-info {
      flex: 1;
    }

    .user-name, .friend-name {
      font-weight: 600;
      font-size: var(--font-size-base);
      margin-bottom: 4px;
    }

    .user-status, .friend-status {
      font-size: var(--font-size-small);
      color: #666;
    }

    .status-online {
      color: #28a745;
    }

    .status-busy {
      color: #dc3545;
    }

    .status-invisible {
      color: #6c757d;
    }

    .user-action {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius);
      font-size: var(--font-size-small);
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-action:hover {
      background: #5568d3;
    }

    .friend-remove {
      background: #dc3545;
      padding: 8px 16px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      font-size: var(--font-size-small);
      cursor: pointer;
      transition: background 0.2s;
    }

    .friend-remove:hover {
      background: #c82333;
    }

    .add-friend-btn {
      width: 100%;
      padding: var(--button-padding);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      margin-top: var(--spacing-sm);
      transition: transform 0.2s;
    }

    .add-friend-btn:hover {
      transform: translateY(-2px);
    }

    /* === CHAT AREA === */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-md);
      background: #f8f9fa;
    }

    .no-chat {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
      text-align: center;
      padding: var(--spacing-lg);
    }

    .no-chat-icon {
      font-size: 80px;
      margin-bottom: var(--spacing-md);
      opacity: 0.3;
    }

    .no-chat-text {
      font-size: var(--font-size-large);
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .no-chat-subtext {
      color: #999;
      font-size: var(--font-size-base);
    }

    .message-bubble {
      max-width: 70%;
      padding: 14px 20px;
      margin-bottom: var(--spacing-sm);
      border-radius: 16px;
      position: relative;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-incoming {
      background: white;
      border: 1px solid #eee;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
    }

    .message-outgoing {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
      align-self: flex-end;
    }

    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      margin-right: 8px;
    }

    .message-sender {
      font-weight: 600;
      font-size: var(--font-size-small);
    }

    .message-time {
      font-size: var(--font-size-small);
      color: #999;
      margin-left: auto;
    }

    .message-content {
      word-wrap: break-word;
      line-height: 1.5;
    }

    .message-encrypted {
      opacity: 0.8;
      font-style: italic;
    }

    .message-delivered {
      font-size: var(--font-size-small);
      color: #28a745;
      text-align: right;
      margin-top: 4px;
    }

    .chat-input-area {
      padding: 16px;
      border-top: 1px solid #eee;
      background: white;
      display: flex;
      gap: var(--spacing-sm);
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 16px;
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      font-size: var(--font-size-large);
      resize: none;
      min-height: 60px;
      max-height: 200px;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .emoji-btn, .voice-btn, .send-btn, .encrypt-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, background 0.2s;
    }

    .emoji-btn:hover, .voice-btn:hover {
      transform: scale(1.1);
      background: #f0f4ff;
    }

    .send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 24px;
    }

    .send-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .encrypt-btn {
      background: #ffc107;
      color: #333;
      font-size: 20px;
    }

    .encrypt-btn.active {
      background: #28a745;
      color: white;
    }

    .encrypt-btn:hover {
      transform: scale(1.1);
    }

    .typing-indicator {
      font-size: var(--font-size-small);
      color: #666;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 0.3;
      }
      50% {
        opacity: 1;
      }
    }

    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      font-size: 14px;
      min-width: 28px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === MODAL === */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      min-width: 400px;
      max-width: 90%;
    }

    .modal h3 {
      margin-bottom: var(--spacing-md);
      color: #333;
      font-size: var(--font-size-large);
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-close:hover {
      color: #333;
    }

    .status-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .status-btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 120px;
    }

    .status-btn:hover {
      background: #f0f4ff;
    }

    .status-online-btn {
      background: #d4edda;
      color: #155724;
    }

    .status-resting-btn {
      background: #fff3cd;
      color: #856404;
    }

    .status-away-btn {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-busy-btn {
      background: #f8d7da;
      color: #721c24;
    }

    .status-gaming-btn {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      color: white;
    }

    .status-invisible-btn {
      background: #e2e3e5;
      color: #383d41;
    }

    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: var(--spacing-sm);
    }

    .emoji {
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      transition: transform 0.2s;
    }

    .emoji:hover {
      transform: scale(1.3);
    }

    /* === LOADING === */
    .loading {
      text-align: center;
      padding: var(--spacing-lg);
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-sm);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }

      .auth-form {
        min-width: 100%;
      }

      .sidebar {
        width: 280px;
      }
    }

    @media (max-width: 768px) {
      .chat-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: 300px;
      }

      .message-bubble {
        max-width: 90%;
      }

      :root {
        --font-size-base: 16px;
        --font-size-small: 14px;
        --font-size-large: 20px;
        --button-padding: 14px 28px;
        --input-padding: 12px 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Forms -->
    <div class="auth-form" id="loginForm">
      <h2>K√ñRP√ú</h2>
      <p style="text-align: center; color: #666; margin-bottom: var(--spacing-md);">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
      <label>–õ–æ–≥–∏–Ω</label>
      <input type="text" id="loginInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" autocomplete="username">
      <label>–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="current-password">
      <button onclick="login()">–í–æ–π—Ç–∏</button>
      <div class="switch">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      </div>
      <div class="guest-login">
        <h3>üï∂ –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç üï∂</h3>
        <p style="color: #666; margin-bottom: var(--spacing-sm);">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</p>
        <input type="text" id="guestNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" value="–ì–æ—Å—Ç—å">
        <button onclick="guestLogin()">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
      </div>
    </div>

    <!-- Main Chat -->
    <div class="main-chat" id="mainChat">
      <div class="chat-header">
        <div class="logo" onclick="showNoChat()">K√ñRP√ú</div>
        <div style="display: flex; gap: var(--spacing-sm);">
          <button class="status-btn" onclick="showStatusModal()">üìã –°—Ç–∞—Ç—É—Å</button>
          <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>
      </div>
      <div class="chat-layout">
        <div class="sidebar">
          <div class="sidebar-tabs">
            <button class="tab-btn active" onclick="switchTab('online')">–û–ù–õ–ê–ô–ù</button>
            <button class="tab-btn" onclick="switchTab('friends')">–î–†–£–ó–¨–Ø</button>
            <button class="tab-btn" onclick="switchTab('groups')">üë• –ì–†–£–ü–ü–´</button>
          </div>
          <div class="tab-content" id="onlineTab">
            <div id="onlineList" class="loading">
              <div class="loading-spinner"></div>
              <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </div>
          <div class="tab-content" id="friendsTab" style="display: none;">
            <div id="friendsList" class="loading">
              <div class="loading-spinner"></div>
              <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <input type="text" id="friendSearch" placeholder="–õ–æ–≥–∏–Ω –¥—Ä—É–≥–∞" style="width: 100%; padding: var(--input-padding); margin-top: var(--spacing-sm);">
            <button class="add-friend-btn" onclick="addFriend()">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
          </div>
          <div class="tab-content" id="groupsTab" style="display: none;">
            <div id="groupsList" class="loading">
              <div class="loading-spinner"></div>
              <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <button class="add-friend-btn" onclick="createGroup()">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
          </div>
        </div>
        <div class="chat-area">
          <div class="chat-messages" id="chatMessages">
            <div class="no-chat" id="noChat">
              <div class="no-chat-icon">üí¨</div>
              <div class="no-chat-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>
              <div class="no-chat-subtext">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
            </div>
          </div>
          <div class="chat-input-area">
            <button class="emoji-btn" onclick="showEmojiPicker()">üòä</button>
            <button class="voice-btn" onclick="startVoiceRecording()">üé§</button>
            <textarea class="chat-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKeyPress(event)"></textarea>
            <button class="encrypt-btn" id="encryptBtn" onclick="toggleEncryption()" title="–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ">üîí</button>
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Modal -->
  <div class="modal" id="statusModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeStatusModal()">√ó</button>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</h3>
      <div class="status-list">
        <button class="status-btn status-online-btn" onclick="updateStatus('–û–Ω–ª–∞–π–Ω')">üü¢ –û–Ω–ª–∞–π–Ω</button>
        <button class="status-btn status-resting-btn" onclick="updateStatus('–û—Ç–¥—ã—Ö–∞—é')">üò¥ –û—Ç–¥—ã—Ö–∞—é</button>
        <button class="status-btn status-away-btn" onclick="updateStatus('–ö—É-–ö—É')">üëã –ö—É-–ö—É</button>
        <button class="status-btn status-away-btn" onclick="updateStatus('–û–Ω —Ç—É—Ç')">üëÄ –û–Ω —Ç—É—Ç</button>
        <button class="status-btn status-busy-btn" onclick="updateStatus('–ó–∞–Ω—è—Ç')">üî¥ –ó–∞–Ω—è—Ç</button>
        <button class="status-btn status-gaming-btn" onclick="updateStatus('–ò–≥—Ä–∞—é')">üéÆ –ò–≥—Ä–∞—é</button>
        <button class="status-btn status-invisible-btn" onclick="updateStatus('–ù–µ–≤–∏–¥–∏–º–∫–∞')">üëª –ù–µ–≤–∏–¥–∏–º–∫–∞</button>
      </div>
    </div>
  </div>

  <!-- Emoji Picker -->
  <div class="modal" id="emojiModal">
    <div class="modal-content" style="min-width: 500px;">
      <button class="modal-close" onclick="closeEmojiPicker()">√ó</button>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</h3>
      <div class="emoji-picker" id="emojiPicker">
        <!-- Will be populated by JS -->
      </div>
    </div>
  </div>

  <!-- Group Create Modal -->
  <div class="modal" id="groupModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeGroupModal()">√ó</button>
      <h3>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
      <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width: 100%; padding: var(--input-padding); margin-top: var(--spacing-md);">
      <button class="add-friend-btn" style="margin-top: var(--spacing-sm);" onclick="confirmCreateGroup()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>

  <script>
    const emojis = ['üòä', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•', 'üëç', 'üéâ', 'üíØ', '‚ú®', 'üåü', 'üí´', 'üí•', 'üéØ', 'üèÜ', 'üöÄ', 'üåà', 'üçï', 'üéÆ', 'üéµ', 'üé®', 'üìö', 'üê±', 'üê∂', 'ü¶Ñ', 'üçï', 'üåÆ', 'üç¶', 'üç∫', '‚òï'];

    let ws = null;
    let currentPeer = null;
    let myId = null;
    let isGuest = false;
    let encryptionEnabled = false;
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];

    function connectWebSocket() {
      const wsUrl = window.location.hostname === 'localhost' 
        ? 'ws://localhost:9000'
        : `wss://${window.location.host}`;
      
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      ws.onclose = () => {
        console.log('WebSocket disconnected');
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }

    function handleMessage(msg) {
      switch (msg.type) {
        case 'auth_success':
          myId = msg.id;
          isGuest = msg.isGuest;
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('mainChat').style.display = 'flex';
          if (!isGuest) {
            ws.send(JSON.stringify({ type: 'get_friends' }));
            ws.send(JSON.stringify({ type: 'get_groups' }));
          }
          break;

        case 'auth_error':
          alert('–û—à–∏–±–∫–∞: ' + msg.text);
          break;

        case 'online_list':
          renderOnlineList(msg.users);
          break;

        case 'user_online':
          updateOnlineList();
          break;

        case 'user_offline':
          if (currentPeer === msg.id) {
            showNoChat();
          }
          updateOnlineList();
          break;

        case 'connected':
          currentPeer = msg.peer;
          document.getElementById('noChat').style.display = 'none';
          document.getElementById('chatMessages').innerHTML = '';
          document.getElementById('messageInput').focus();
          addSystemMessage(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${msg.displayName}`);
          break;

        case 'message':
          addMessage(msg.from, msg.displayName, msg.avatar, msg.text, false, msg.time, msg.encrypted);
          if (msg.from === currentPeer) {
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
          break;

        case 'offline_message':
          addMessage(msg.from, msg.displayName, msg.avatar, msg.text, false, msg.time, msg.encrypted);
          break;

        case 'delivered':
          markMessageDelivered(msg.msgId);
          break;

        case 'friends_list':
          renderFriendsList(msg.friends);
          break;

        case 'friend_added':
          alert(`–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω: ${msg.friendName}`);
          ws.send(JSON.stringify({ type: 'get_friends' }));
          break;

        case 'friend_removed':
          ws.send(JSON.stringify({ type: 'get_friends' }));
          break;

        case 'groups_list':
          renderGroupsList(msg.groups);
          break;

        case 'group_created':
          alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!');
          ws.send(JSON.stringify({ type: 'get_groups' }));
          break;

        case 'group_joined':
          currentPeer = 'group_' + msg.groupId;
          document.getElementById('noChat').style.display = 'none';
          document.getElementById('chatMessages').innerHTML = '';
          msg.messages.forEach(m => {
            addMessage(m.from_user, m.display_name, m.avatar, m.message, false, new Date(m.created_at).getTime(), m.is_encrypted);
          });
          document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          break;

        case 'group_message':
          if (currentPeer === 'group_' + msg.groupId) {
            addMessage(msg.from, msg.displayName, msg.avatar, msg.text, false, msg.time, msg.encrypted);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
          }
          break;

        case 'error':
          alert('–û—à–∏–±–∫–∞: ' + msg.text);
          break;
      }
    }

    function login() {
      const login = document.getElementById('loginInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      if (!login || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        return;
      }
      ws.send(JSON.stringify({
        type: 'auth_login',
        login: login,
        password: password
      }));
    }

    function showRegister() {
      const loginForm = document.getElementById('loginForm');
      loginForm.innerHTML = `
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <label>–ò–º—è</label>
        <input type="text" id="regDisplayName" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
        <label>–õ–æ–≥–∏–Ω</label>
        <input type="text" id="regLogin" placeholder="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _" autocomplete="username">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="regPassword" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" autocomplete="new-password">
        <label>–ê–≤–∞—Ç–∞—Ä</label>
        <input type="text" id="regAvatar" placeholder="–≠–º–æ–¥–∑–∏" value="üê±">
        <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <div class="switch">
          –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showLogin()">–í–æ–π—Ç–∏</a>
        </div>
      `;
    }

    function showLogin() {
      const loginForm = document.getElementById('loginForm');
      loginForm.innerHTML = `
        <h2>K√ñRP√ú</h2>
        <p style="text-align: center; color: #666; margin-bottom: var(--spacing-md);">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
        <label>–õ–æ–≥–∏–Ω</label>
        <input type="text" id="loginInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" autocomplete="username">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="current-password">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <div class="switch">
          –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        </div>
        <div class="guest-login">
          <h3>üï∂ –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç üï∂</h3>
          <p style="color: #666; margin-bottom: var(--spacing-sm);">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</p>
          <input type="text" id="guestNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" value="–ì–æ—Å—Ç—å">
          <button onclick="guestLogin()">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
        </div>
      `;
    }

    function register() {
      const displayName = document.getElementById('regDisplayName').value.trim();
      const login = document.getElementById('regLogin').value.trim().toLowerCase();
      const password = document.getElementById('regPassword').value;
      const avatar = document.getElementById('regAvatar').value || 'üê±';
      if (!displayName || !login || !password) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      ws.send(JSON.stringify({
        type: 'auth_register',
        login: login,
        password: password,
        displayName: displayName,
        avatar: avatar
      }));
    }

    function guestLogin() {
      const nickname = document.getElementById('guestNickname').value.trim();
      if (!nickname || nickname.length < 2) {
        alert('–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
        return;
      }
      ws.send(JSON.stringify({
        type: 'guest_login',
        nickname: nickname
      }));
    }

    function logout() {
      if (ws) ws.close();
      document.getElementById('mainChat').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      showLogin();
      setTimeout(connectWebSocket, 500);
    }

    function updateOnlineList() {
      ws.send(JSON.stringify({ type: 'get_online' }));
    }

    function renderOnlineList(users) {
      const list = document.getElementById('onlineList');
      if (!users || users.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: var(--spacing-md); color: #999;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
        return;
      }
      list.innerHTML = users.filter(u => u.id !== myId).map(user => `
        <div class="user-item" onclick="connectTo('${user.id}')">
          <div class="user-avatar">${user.avatar || 'üë§'}</div>
          <div class="user-info">
            <div class="user-name">${user.displayName}</div>
            <div class="user-status ${user.status === '–û–Ω–ª–∞–π–Ω' ? 'status-online' : user.status === '–ó–∞–Ω—è—Ç' ? 'status-busy' : 'status-invisible'}">
              ${user.status || (user.isGuest ? '–ì–æ—Å—Ç—å' : '–û—Ñ–ª–∞–π–Ω')}
            </div>
          </div>
          ${!isGuest && !user.isGuest ? `<button class="user-action" onclick="event.stopPropagation(); addFriendDirect('${user.id}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>` : ''}
        </div>
      `).join('');
    }

    function renderFriendsList(friends) {
      const list = document.getElementById('friendsList');
      if (!friends || friends.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: var(--spacing-md); color: #999;">–£ –≤–∞—Å –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
        return;
      }
      list.innerHTML = friends.map(friend => `
        <div class="friend-item" onclick="connectTo('${friend.id}')">
          <div class="friend-avatar">${friend.avatar || 'üë§'}</div>
          <div class="friend-info">
            <div class="friend-name">${friend.displayName}</div>
            <div class="friend-status ${friend.status === '–û–Ω–ª–∞–π–Ω' ? 'status-online' : friend.status === '–ó–∞–Ω—è—Ç' ? 'status-busy' : 'status-invisible'}">
              ${friend.status || '–û—Ñ–ª–∞–π–Ω'}
            </div>
          </div>
          <button class="friend-remove" onclick="event.stopPropagation(); removeFriend('${friend.id}')">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderGroupsList(groups) {
      const list = document.getElementById('groupsList');
      if (!groups || groups.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: var(--spacing-md); color: #999;">–£ –≤–∞—Å –Ω–µ—Ç –≥—Ä—É–ø–ø</div>';
        return;
      }
      list.innerHTML = groups.map(group => `
        <div class="friend-item" onclick="joinGroup(${group.id})">
          <div class="friend-avatar">üë•</div>
          <div class="friend-info">
            <div class="friend-name">${group.group_name}</div>
            <div class="friend-status" style="color: #666;">
              ${group.member_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </div>
          </div>
        </div>
      `).join('');
    }

    function connectTo(target) {
      currentPeer = target;
      ws.send(JSON.stringify({
        type: 'connect',
        target: target
      }));
    }

    function addFriend() {
      const friendId = document.getElementById('friendSearch').value.trim().toLowerCase();
      if (!friendId) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥—Ä—É–≥–∞');
        return;
      }
      ws.send(JSON.stringify({
        type: 'add_friend',
        friendId: friendId
      }));
    }

    function addFriendDirect(friendId) {
      if (confirm(`–î–æ–±–∞–≤–∏—Ç—å ${friendId} –≤ –¥—Ä—É–∑—å—è?`)) {
        ws.send(JSON.stringify({
          type: 'add_friend',
          friendId: friendId
        }));
      }
    }

    function removeFriend(friendId) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å ${friendId} –∏–∑ –¥—Ä—É–∑–µ–π?`)) {
        ws.send(JSON.stringify({
          type: 'remove_friend',
          friendId: friendId
        }));
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentPeer) return;
      const msgId = Date.now().toString(36);
      ws.send(JSON.stringify({
        type: currentPeer.startsWith('group_') ? 'group_message' : 'message',
        target: currentPeer.replace('group_', ''),
        groupId: currentPeer.startsWith('group_') ? currentPeer.replace('group_', '') : null,
        text: text,
        msgId: msgId,
        encrypted: encryptionEnabled
      }));
      addMessage(myId, '–í—ã', '', text, true, Date.now(), encryptionEnabled);
      input.value = '';
      input.style.height = 'auto';
    }

    function addMessage(from, displayName, avatar, text, isOutgoing, time, encrypted) {
      const messages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-bubble ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
      if (encrypted) messageDiv.classList.add('message-encrypted');
      const timeStr = new Date(time).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      messageDiv.innerHTML = `
        <div class="message-header">
          ${!isOutgoing ? `<div class="message-avatar">${avatar || 'üë§'}</div>` : ''}
          <div class="message-sender">${displayName}</div>
          <div class="message-time">${timeStr}</div>
        </div>
        <div class="message-content">${text}</div>
        ${isOutgoing ? `<div class="message-delivered" id="msg-${msgId}">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>` : ''}
      `;
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function markMessageDelivered(msgId) {
      const el = document.getElementById(`msg-${msgId}`);
      if (el) {
        el.textContent = '‚úì‚úì –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
        el.style.color = '#28a745';
      }
    }

    function addSystemMessage(text) {
      const messages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.style.textAlign = 'center';
      messageDiv.style.padding = '10px';
      messageDiv.style.color = '#666';
      messageDiv.style.fontStyle = 'italic';
      messageDiv.textContent = text;
      messages.appendChild(messageDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function showNoChat() {
      currentPeer = null;
      document.getElementById('noChat').style.display = 'flex';
      document.getElementById('chatMessages').innerHTML = '';
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function showStatusModal() {
      document.getElementById('statusModal').classList.add('active');
    }

    function closeStatusModal() {
      document.getElementById('statusModal').classList.remove('active');
    }

    function updateStatus(status) {
      ws.send(JSON.stringify({
        type: 'update_status',
        status: status
      }));
      closeStatusModal();
    }

    function toggleEncryption() {
      encryptionEnabled = !encryptionEnabled;
      const btn = document.getElementById('encryptBtn');
      btn.classList.toggle('active');
      btn.textContent = encryptionEnabled ? 'üîê' : 'üîí';
      btn.title = encryptionEnabled ? '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ' : '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ';
    }

    function showEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      if (picker.innerHTML === '') {
        picker.innerHTML = emojis.map(e => `<div class="emoji" onclick="insertEmoji('${e}')">${e}</div>`).join('');
      }
      document.getElementById('emojiModal').classList.add('active');
    }

    function closeEmojiPicker() {
      document.getElementById('emojiModal').classList.remove('active');
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      input.value += emoji;
      input.focus();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').style.display = 'block';
      if (tab === 'online') updateOnlineList();
      if (tab === 'friends' && !isGuest) ws.send(JSON.stringify({ type: 'get_friends' }));
      if (tab === 'groups' && !isGuest) ws.send(JSON.stringify({ type: 'get_groups' }));
    }

    function createGroup() {
      document.getElementById('groupModal').classList.add('active');
      document.getElementById('groupNameInput').value = '';
    }

    function closeGroupModal() {
      document.getElementById('groupModal').classList.remove('active');
    }

    function confirmCreateGroup() {
      const name = document.getElementById('groupNameInput').value.trim();
      if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
        return;
      }
      ws.send(JSON.stringify({
        type: 'create_group',
        groupName: name
      }));
      closeGroupModal();
    }

    function joinGroup(groupId) {
      ws.send(JSON.stringify({
        type: 'join_group',
        groupId: groupId
      }));
    }

    function startVoiceRecording() {
      alert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!');
    }

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Initialize
    connectWebSocket();
  </script>
</body>
</html>
