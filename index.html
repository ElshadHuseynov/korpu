<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>K√ñRP√ú ‚Äî Chat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .splash{position:fixed;inset:0;z-index:999;background:#0c1a2e;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s,visibility .6s}.splash.hidden{opacity:0;visibility:hidden;pointer-events:none}.splash img{width:160px;height:160px;object-fit:contain;animation:sp 1.5s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(0,229,160,.3))}.splash-text{margin-top:16px;font-family:'Space Mono',monospace;font-size:.65rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.3)}@keyframes sp{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0f;--glass:rgba(255,255,255,.06);--gb:rgba(255,255,255,.08);--a:#00e5a0;--ag:rgba(0,229,160,.3);--ad:rgba(0,229,160,.1);--danger:#ff4d6a;--t:#e8e8ec;--td:rgba(255,255,255,.4);--tm:rgba(255,255,255,.65);--sb:linear-gradient(135deg,rgba(0,229,160,.2),rgba(0,229,160,.08));--sbb:rgba(0,229,160,.15);--rb:rgba(255,255,255,.06);--rbb:rgba(255,255,255,.06);--cb:rgba(255,255,255,.06);--safe-top:env(safe-area-inset-top,0px)}
    html.light{--bg:#f0f2f5;--glass:rgba(0,0,0,.04);--gb:rgba(0,0,0,.08);--a:#00b386;--ag:rgba(0,179,134,.2);--ad:rgba(0,179,134,.08);--t:#1a1a2e;--td:rgba(0,0,0,.4);--tm:rgba(0,0,0,.55);--sb:linear-gradient(135deg,rgba(0,179,134,.15),rgba(0,179,134,.06));--sbb:rgba(0,179,134,.2);--rb:rgba(0,0,0,.04);--rbb:rgba(0,0,0,.06);--cb:rgba(255,255,255,.7)}
    html{font-size:16px}body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;overflow:hidden;transition:background .3s,color .3s}
    body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 50%,rgba(0,229,160,.06) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(100,60,255,.05) 0%,transparent 50%);animation:bga 20s ease-in-out infinite alternate;z-index:0}@keyframes bga{0%{transform:translate(0,0)}100%{transform:translate(-5%,3%)}}
    body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:60px 60px;z-index:0}
    .app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;max-width:520px;margin:0 auto;padding:10px 10px 0 10px;padding-top:calc(10px + var(--safe-top))}@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.auth{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;animation:fu .5s ease}.auth-logo{width:80px;height:80px;object-fit:contain;margin-bottom:8px;filter:drop-shadow(0 0 20px var(--ag))}.auth-title{font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700;color:var(--a);letter-spacing:3px;margin-bottom:2px}.auth-sub{font-size:.75rem;color:var(--td);margin-bottom:16px}.auth-card{width:100%;max-width:360px;background:var(--cb);border:1px solid var(--gb);border-radius:16px;padding:20px;backdrop-filter:blur(20px)}.tabs{display:flex;margin-bottom:16px;background:var(--glass);border-radius:10px;padding:3px}.tab{flex:1;padding:9px;text-align:center;font-size:.78rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all .25s;color:var(--tm)}.tab.on{background:var(--a);color:#0a0a0f;box-shadow:0 2px 10px var(--ag)}.field{margin-bottom:10px}.field label{display:block;font-size:.58rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--td);margin-bottom:4px;font-family:'Space Mono',monospace}.field input{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.84rem;outline:none;transition:all .3s}html.light .field input{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}.field input:focus{border-color:rgba(0,229,160,.4);box-shadow:0 0 0 3px rgba(0,229,160,.08)}.field input::placeholder{color:var(--td)}.abtn{width:100%;padding:11px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s;margin-top:4px}.abtn-p{background:var(--a);color:#0a0a0f;box-shadow:0 3px 15px var(--ag)}.abtn-g{background:var(--glass);color:var(--tm);border:1px solid var(--gb)}.divider{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--td);font-size:.68rem}.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--gb)}.auth-err{color:var(--danger);font-size:.74rem;text-align:center;margin-top:6px;min-height:16px}.anon-box{background:rgba(255,255,255,.03);border:1px solid var(--gb);border-radius:12px;padding:14px;text-align:center}.anon-title{font-size:.9rem;font-weight:700;color:var(--tm);margin-bottom:10px}.saved-info{font-size:.66rem;color:var(--td);text-align:center;margin-top:8px}.saved-info a{color:var(--a);cursor:pointer;text-decoration:underline}.avatar-pick{display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin:8px 0}.av-opt{width:34px;height:34px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .2s;background:var(--glass)}.av-opt.sel{border-color:var(--a);box-shadow:0 0 10px var(--ag);transform:scale(1.1)}.chat{display:none;flex-direction:column;flex:1;min-height:0}.chat.on{display:flex}.hdr{display:flex;align-items:center;justify-content:space-between;padding:5px 0;margin-bottom:3px}.logo{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;letter-spacing:2px;color:var(--a)}.hdr-r{display:flex;align-items:center;gap:6px}.badge{font-size:.7rem;padding:5px 10px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--gb);color:var(--td);font-family:'Space Mono',monospace;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.badge.on{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.ib{width:36px;height:36px;border-radius:9px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:.85rem}.ib:hover{background:rgba(255,255,255,.1)}.ib.act{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.update-btn{display:none}
    .menu-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80;backdrop-filter:blur(2px)}
    .menu-overlay.show{display:block}
    .side-menu{position:fixed;top:0;right:-280px;width:270px;height:100%;background:var(--bg);border-left:1px solid var(--gb);z-index:90;display:flex;flex-direction:column;transition:right .3s ease;overflow-y:auto;padding:0;padding-top:env(safe-area-inset-top,0px)}
    .side-menu.show{right:0}
    .menu-header{display:flex;align-items:center;gap:10px;padding:20px 16px 12px;background:linear-gradient(180deg,rgba(0,229,160,.06) 0%,transparent 100%);border-bottom:1px solid var(--gb)}
    .menu-name{font-weight:600;font-size:.95rem}.menu-login{font-size:.65rem;color:var(--td);font-family:'Space Mono',monospace}
    .menu-xp{padding:8px 16px;border-bottom:1px solid var(--gb)}
    .menu-items{flex:1;padding:8px 0}
    .menu-item{padding:12px 18px;font-size:.88rem;cursor:pointer;transition:background .15s;display:flex;align-items:center;gap:8px}
    .menu-item:hover{background:rgba(255,255,255,.05)}
    .menu-item:active{background:var(--ad)}
    .menu-item.danger{color:var(--danger)}
    .menu-item.danger:hover{background:rgba(255,77,106,.08)}
    .games-panel{display:none;background:var(--cb);border:1px solid var(--gb);border-radius:12px;padding:10px;margin-bottom:6px;animation:fu .2s ease;max-height:260px;overflow-y:auto}.games-panel.show{display:block}
    .game-card{display:flex;align-items:center;gap:10px;padding:10px;background:var(--glass);border:1px solid var(--gb);border-radius:10px;margin-bottom:6px;cursor:pointer;transition:all .2s}
    .game-card:hover{background:var(--ad);border-color:rgba(0,229,160,.3)}
    .game-card .g-icon{font-size:1.6rem;width:36px;text-align:center;flex-shrink:0}
    .game-card .g-info{flex:1}.game-card .g-name{font-weight:600;font-size:.85rem}.game-card .g-desc{font-size:.65rem;color:var(--td);margin-top:1px}
    .game-pick-title{font-size:.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);font-family:'Space Mono',monospace;margin:8px 0 6px}
    .game-friend-row{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;cursor:pointer;transition:background .15s;font-size:.82rem}
    .game-friend-row:hover{background:rgba(255,255,255,.06)}
    .game-friend-row .av{font-size:1rem}.game-friend-row .nm{flex:1;font-weight:500}
    .menu-bottom{border-top:1px solid var(--gb);padding:8px 0}
    .conn-row{display:flex;gap:5px;margin-bottom:4px}.conn-row input{flex:1;padding:8px 12px;background:var(--glass);border:1px solid var(--gb);border-radius:10px;color:var(--t);font-size:.82rem;outline:none;font-family:'Outfit',sans-serif}.conn-row input:focus{border-color:rgba(0,229,160,.4)}.conn-row input::placeholder{color:var(--td)}
    .conn-btn{width:36px;height:36px;border-radius:10px;border:1px solid var(--gb);background:var(--glass);color:var(--a);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-weight:700}.conn-btn:hover{background:var(--ad)}
    .ach-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);padding:10px 18px;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(0,229,160,.15));border:1px solid rgba(167,139,250,.3);border-radius:14px;z-index:200;text-align:center;transition:transform .4s ease;pointer-events:none;backdrop-filter:blur(10px)}
    .ach-toast.show{transform:translateX(-50%) translateY(0)}
    .ach-toast .ach-icon{font-size:1.6rem;display:block}.ach-toast .ach-name{font-size:.82rem;font-weight:600;color:var(--t);margin-top:2px}.ach-toast .ach-lbl{font-size:.6rem;color:var(--purple);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px}
    .ach-grid{display:flex;flex-wrap:wrap;gap:4px;padding:0 16px 14px}
    .ach-item{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;position:relative;cursor:default}
    .ach-item.earned{background:linear-gradient(135deg,rgba(167,139,250,.15),rgba(0,229,160,.1));border:1px solid rgba(167,139,250,.25)}
    .ach-item.locked{background:var(--glass);border:1px solid var(--gb);opacity:.35;filter:grayscale(1)}
    .ach-item .ach-tip{display:none;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--bg);border:1px solid var(--gb);border-radius:8px;padding:5px 8px;white-space:nowrap;font-size:.6rem;color:var(--tm);z-index:10}
    .ach-item:hover .ach-tip{display:block}
    .lang-sw{display:flex;gap:3px;padding:8px 18px;border-bottom:1px solid var(--gb)}
    .lang-btn{padding:5px 12px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.75rem;cursor:pointer;font-family:'Space Mono',monospace;font-weight:600;transition:all .2s}
    .lang-btn.on{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}
    .ck-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:16px;max-width:380px;width:94%;animation:fu .3s ease;text-align:center}
    .ck-title{font-family:'Space Mono',monospace;font-size:.8rem;color:var(--a);margin-bottom:8px;letter-spacing:1px}
    .ck-status{font-size:.75rem;color:var(--tm);margin-bottom:10px}
    .ck-board{display:grid;grid-template-columns:repeat(8,1fr);gap:0;width:100%;max-width:320px;margin:0 auto 10px;aspect-ratio:1;border-radius:10px;overflow:hidden;border:2px solid var(--gb)}
    .ck-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:background .15s}
    .ck-cell.light{background:#b58863}.ck-cell.dark{background:#6d4c3d}
    .ck-cell.sel{box-shadow:inset 0 0 0 3px var(--a)}
    .ck-cell.hint::after{content:'';position:absolute;width:30%;height:30%;border-radius:50%;background:rgba(0,229,160,.5)}
    .ck-cell.cap-hint::after{content:'';position:absolute;width:60%;height:60%;border-radius:50%;background:rgba(255,77,106,.4)}
    .ck-cell.last-from{box-shadow:inset 0 0 0 2px rgba(167,139,250,.5)}.ck-cell.last-to{box-shadow:inset 0 0 0 2px rgba(167,139,250,.7)}
    .ck-piece{width:70%;height:70%;border-radius:50%;position:relative;pointer-events:none;transition:transform .15s}
    .ck-piece.black{background:radial-gradient(circle at 35% 35%,#555,#1a1a1a);border:2px solid #333;box-shadow:0 2px 6px rgba(0,0,0,.6)}
    .ck-piece.white{background:radial-gradient(circle at 35% 35%,#fff,#ccc);border:2px solid #aaa;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .ck-piece.king::after{content:'‚ôõ';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.7em}
    .ck-piece.black.king::after{color:#fbbf24}.ck-piece.white.king::after{color:#7c3aed}
    .ck-actions{display:flex;gap:6px;justify-content:center;margin-top:6px}
    .ck-actions button{padding:7px 14px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.78rem;cursor:pointer;font-family:'Outfit',sans-serif}
    .ck-actions button:hover{background:var(--ad);color:var(--a)}
    .ck-actions button.danger:hover{background:rgba(255,77,106,.15);color:var(--danger)}
    .ck-score{display:flex;justify-content:center;gap:16px;margin-bottom:8px;font-size:.78rem;font-family:'Space Mono',monospace}
    .ck-score .you{color:var(--a);font-weight:700}.ck-score .opp{color:var(--tm)}
    .myid-bar{display:flex;align-items:center;gap:7px;padding:8px 12px;background:var(--glass);border:1px solid var(--gb);border-radius:12px;margin-bottom:6px;font-size:.85rem;flex-wrap:wrap}.myid-bar .av-icon{font-size:1.3rem}.myid-name{font-weight:600}.myid-login{color:var(--td);font-family:'Space Mono',monospace;font-size:.7rem}.myid-status{font-size:.7rem;color:var(--a)}.copy-btn{margin-left:auto;padding:4px 10px;border-radius:8px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.72rem;cursor:pointer;font-family:'Space Mono',monospace}.copy-btn:hover,.copy-btn.ok{background:var(--ad);color:var(--a)}.xp-bar{width:100%;height:6px;background:var(--glass);border-radius:4px;margin-top:4px;overflow:hidden}.xp-fill{height:100%;background:linear-gradient(90deg,var(--a),#a78bfa);border-radius:4px;transition:width .5s ease}.xp-text{font-size:.62rem;color:var(--td);font-family:'Space Mono',monospace;display:flex;justify-content:space-between;margin-top:2px}.lvl-badge{font-size:.62rem;padding:2px 7px;border-radius:5px;background:linear-gradient(135deg,rgba(167,139,250,.2),rgba(0,229,160,.15));color:#a78bfa;font-family:'Space Mono',monospace;font-weight:700}.panel{display:none;background:var(--cb);border:1px solid var(--gb);border-radius:12px;padding:10px;margin-bottom:6px;animation:fu .2s ease;max-height:200px;overflow-y:auto}.panel.show{display:block}.panel-title{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin-bottom:7px;font-family:'Space Mono',monospace;display:flex;align-items:center;justify-content:space-between;gap:6px}.p-row{display:flex;align-items:center;gap:8px;padding:6px 7px;border-radius:9px;cursor:pointer;transition:background .2s;font-size:.88rem}.p-row:hover{background:rgba(255,255,255,.06)}.p-row .av{font-size:1.15rem;width:24px;text-align:center}.p-row .name{font-weight:500;flex:1}.p-row .st{font-size:.68rem;color:var(--td)}.p-row .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}.p-row .dot.on{background:var(--a)}.p-row .dot.off{background:var(--td)}.p-row-actions{display:flex;gap:4px;margin-left:auto}.mini-btn{padding:4px 9px;border-radius:7px;border:1px solid var(--gb);background:var(--glass);color:var(--tm);font-size:.7rem;cursor:pointer;transition:all .2s}.mini-btn:hover{background:var(--ad);color:var(--a)}.mini-btn.danger:hover{background:rgba(255,77,106,.15);color:var(--danger)}.friend-badge{font-size:.6rem;padding:2px 6px;border-radius:5px;background:rgba(0,229,160,.12);color:var(--a);font-family:'Space Mono',monospace}.st-opt{display:inline-block;padding:3px 9px;margin:2px;border-radius:14px;font-size:.68rem;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);transition:all .2s}.st-opt:hover,.st-opt.sel{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.add-row{display:flex;gap:4px;margin-top:5px}.add-row input{flex:1;padding:5px 8px;font-size:.72rem;background:rgba(255,255,255,.04);border:1px solid var(--gb);border-radius:7px;color:var(--t);outline:none;font-family:'Outfit',sans-serif}.add-row input:focus{border-color:rgba(0,229,160,.3)}.grp-member-pick{display:flex;flex-wrap:wrap;gap:3px;margin:4px 0}.grp-mem{padding:2px 7px;border-radius:12px;font-size:.65rem;border:1px solid var(--gb);background:var(--glass);color:var(--tm);cursor:pointer;transition:all .2s}.grp-mem.sel{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.search-row{display:flex;gap:4px;margin-bottom:5px}.search-row input{flex:1;padding:6px 10px;font-size:.75rem;background:rgba(255,255,255,.04);border:1px solid var(--gb);border-radius:8px;color:var(--t);outline:none;font-family:'Outfit',sans-serif}.search-row input:focus{border-color:rgba(0,229,160,.3)}.search-results{max-height:120px;overflow-y:auto}.card{background:var(--cb);border:1px solid var(--gb);border-radius:14px;padding:12px;backdrop-filter:blur(20px);margin-bottom:6px;animation:fu .4s ease}.cl{font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);margin-bottom:8px;font-family:'Space Mono',monospace}.irow{display:flex;gap:7px}input[type="text"]{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:11px;padding:10px 12px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.9rem;outline:none;transition:all .3s}html.light input[type="text"]{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}input:focus{border-color:rgba(0,229,160,.4)!important;box-shadow:0 0 0 3px rgba(0,229,160,.08)}input::placeholder{color:var(--td)}.btn{padding:10px 14px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}.btn-p{background:var(--a);color:#0a0a0f}.btn-g{background:var(--glass);color:var(--tm);border:1px solid var(--gb)}.chat-tabs{display:flex;gap:3px;margin-bottom:3px;overflow-x:auto;scrollbar-width:none;padding:2px 0}.chat-tabs::-webkit-scrollbar{display:none}.chat-tab{padding:6px 12px;border-radius:10px;font-size:.8rem;font-weight:600;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);white-space:nowrap;transition:all .2s;display:flex;align-items:center;gap:3px;flex-shrink:0}.chat-tab.active{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}.chat-tab .unread{background:var(--danger);color:white;font-size:.48rem;padding:1px 4px;border-radius:8px;font-weight:700}.chat-tab .close-tab{font-size:.55rem;opacity:.4;cursor:pointer;margin-left:1px}.chat-tab .close-tab:hover{opacity:1}.msa{flex:1;min-height:0;display:flex;flex-direction:column}.msg-container{flex:1;overflow-y:auto;padding:7px;display:flex;flex-direction:column;gap:3px;background:var(--glass);border:1px solid var(--gb);border-radius:10px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}.msg-container::-webkit-scrollbar{width:3px}.msg-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}.m{max-width:82%;padding:9px 12px;border-radius:14px;font-size:.9rem;line-height:1.4;animation:mi .3s ease both;word-break:break-word;position:relative}@keyframes mi{from{opacity:0;transform:translateY(4px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}.m.s{align-self:flex-end;background:var(--sb);border:1px solid var(--sbb)}.m.r{align-self:flex-start;background:var(--rb);border:1px solid var(--rbb)}.m.y{align-self:center;background:none;border:none;color:var(--td);font-size:.72rem;font-family:'Space Mono',monospace;padding:4px 0}.mf{font-size:.68rem;color:var(--a);font-weight:600;margin-bottom:2px}.reply-block{font-size:.6rem;padding:3px 6px;margin-bottom:3px;border-left:2px solid var(--a);background:rgba(0,229,160,.05);border-radius:0 6px 6px 0;color:var(--tm);max-height:30px;overflow:hidden}.mm{display:flex;align-items:center;gap:4px;margin-top:2px}.mt{font-size:.6rem;color:var(--td);font-family:'Space Mono',monospace}.ms-icon{font-size:.65rem}.mr{position:absolute;bottom:-7px;right:7px;background:var(--bg);border:1px solid var(--gb);border-radius:9px;padding:1px 4px;font-size:.6rem}.m:hover .m-actions{opacity:1}.m-actions{position:absolute;top:-8px;right:-5px;opacity:0;display:flex;gap:2px;transition:opacity .2s}.m-act{background:var(--bg);border:1px solid var(--gb);border-radius:50%;width:17px;height:17px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.5rem}.m-act:hover{background:var(--ad)}#ti{font-size:.68rem;color:var(--a);font-family:'Space Mono',monospace;height:14px;opacity:0;transition:opacity .3s}#ti.v{opacity:1}.reply-bar{display:none;align-items:center;gap:6px;padding:5px 8px;background:var(--glass);border:1px solid var(--gb);border-radius:8px;margin-bottom:3px;font-size:.7rem;animation:fu .15s ease}.reply-bar.show{display:flex}.reply-bar .rtext{flex:1;color:var(--tm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.reply-bar .rclose{cursor:pointer;color:var(--td)}.rps-bar{display:none;padding:8px;background:linear-gradient(135deg,rgba(167,139,250,.1),rgba(0,229,160,.08));border:1px solid rgba(167,139,250,.2);border-radius:10px;margin-bottom:4px;text-align:center;animation:fu .3s ease}.rps-bar.show{display:block}.rps-title{font-size:.7rem;font-weight:600;color:#a78bfa;margin-bottom:6px}.rps-choices{display:flex;gap:8px;justify-content:center}.rps-choice{font-size:1.8rem;cursor:pointer;padding:6px;border-radius:12px;border:2px solid transparent;transition:all .2s}.rps-choice:hover{border-color:var(--a);transform:scale(1.15);background:var(--ad)}.ibar{display:flex;gap:6px;margin-top:5px;padding-bottom:8px;align-items:center}.bs{width:40px;height:40px;padding:0;border-radius:50%;background:var(--a);color:#0a0a0f;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;box-shadow:0 2px 8px var(--ag)}.bm{width:40px;height:40px;padding:0;border-radius:50%;background:var(--glass);border:1px solid var(--gb);color:var(--tm);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;font-size:1.1rem}.bm.rec{background:var(--danger);color:white;border-color:var(--danger);animation:pu 1s infinite}@keyframes pu{0%,100%{box-shadow:0 0 0 0 rgba(255,77,106,.4)}50%{box-shadow:0 0 0 7px rgba(255,77,106,0)}}.ep{display:none;position:absolute;bottom:46px;left:4px;right:4px;background:var(--bg);border:1px solid var(--gb);border-radius:10px;padding:5px;z-index:50;max-height:140px;overflow-y:auto;animation:fu .2s ease}.ep.show{display:block}.eg{display:grid;grid-template-columns:repeat(8,1fr);gap:2px}.ei{font-size:1.4rem;text-align:center;padding:4px;border-radius:8px;cursor:pointer}.ei:hover{background:rgba(255,255,255,.1)}.rp{display:none;position:fixed;background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:3px 5px;z-index:60}.rp.show{display:flex;gap:1px;animation:fu .15s ease}.rp span{font-size:.85rem;cursor:pointer;padding:2px 3px;border-radius:7px}.rp span:hover{background:rgba(255,255,255,.1)}.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}.modal-bg.show{display:flex}.modal{background:var(--bg);border:1px solid var(--gb);border-radius:16px;padding:20px;max-width:360px;width:90%;max-height:80vh;overflow-y:auto;animation:fu .3s ease}.modal-title{font-family:'Space Mono',monospace;font-size:.85rem;font-weight:700;color:var(--a);margin-bottom:10px;text-align:center}.modal-text{font-size:.75rem;color:var(--tm);line-height:1.6;white-space:pre-line}.modal-close{display:block;margin:12px auto 0;padding:8px 24px;border:none;border-radius:8px;background:var(--a);color:#0a0a0f;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif}.poll-box{background:linear-gradient(135deg,rgba(100,60,255,.08),rgba(0,229,160,.05));border:1px solid rgba(100,60,255,.2);border-radius:10px;padding:8px;margin:3px 0;max-width:85%}.poll-q{font-size:.75rem;font-weight:600;color:#a78bfa;margin-bottom:5px}.poll-opt{padding:5px 8px;margin:2px 0;border-radius:6px;font-size:.7rem;cursor:pointer;border:1px solid var(--gb);background:var(--glass);color:var(--tm);transition:all .2s;display:flex;justify-content:space-between}.poll-opt:hover{border-color:rgba(0,229,160,.3)}.poll-opt.voted{background:var(--ad);border-color:rgba(0,229,160,.3);color:var(--a)}svg{display:block}
    .voice-msg{display:flex;align-items:center;gap:6px;padding:2px 0}
    .profile-modal{background:var(--bg);border:1px solid var(--gb);border-radius:18px;padding:0;max-width:360px;width:92%;max-height:85vh;overflow-y:auto;animation:fu .3s ease}
    .prof-header{position:relative;padding:28px 20px 16px;text-align:center;background:linear-gradient(180deg,rgba(0,229,160,.08) 0%,transparent 100%);border-radius:18px 18px 0 0}
    .prof-avatar{font-size:3rem;display:block;margin:0 auto 6px;filter:drop-shadow(0 2px 10px var(--ag))}
    .prof-name{font-size:1.1rem;font-weight:700;color:var(--t)}.prof-login{font-size:.7rem;color:var(--td);font-family:'Space Mono',monospace;margin-top:2px}
    .prof-level{display:inline-block;margin-top:6px;padding:3px 10px;border-radius:20px;font-size:.65rem;font-weight:700;font-family:'Space Mono',monospace;background:linear-gradient(135deg,rgba(167,139,250,.25),rgba(0,229,160,.15));color:#a78bfa}
    .prof-online{display:inline-block;margin-left:6px;padding:3px 8px;border-radius:20px;font-size:.6rem;font-weight:600}
    .prof-online.on{background:rgba(0,229,160,.15);color:var(--a)}.prof-online.off{background:rgba(255,255,255,.06);color:var(--td)}
    .prof-bio{padding:0 20px 10px;font-size:.8rem;color:var(--tm);text-align:center;font-style:italic}
    .prof-bio-edit{width:100%;padding:6px 10px;background:var(--glass);border:1px solid var(--gb);border-radius:8px;color:var(--t);font-family:'Outfit',sans-serif;font-size:.78rem;outline:none;resize:none;text-align:center}
    .prof-bio-edit:focus{border-color:rgba(0,229,160,.4)}
    .prof-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;padding:0 16px 14px}
    .prof-stat{text-align:center;padding:10px 4px;background:var(--glass);border-radius:10px}
    .prof-stat:first-child{border-radius:10px 4px 4px 10px}.prof-stat:last-child{border-radius:4px 10px 10px 4px}
    .prof-stat .val{font-size:1.1rem;font-weight:700;color:var(--a);font-family:'Space Mono',monospace}
    .prof-stat .lbl{font-size:.55rem;color:var(--td);text-transform:uppercase;letter-spacing:1px;margin-top:2px;font-family:'Space Mono',monospace}
    .prof-details{padding:0 16px 16px;display:flex;flex-direction:column;gap:6px}
    .prof-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--glass);border-radius:9px;font-size:.78rem}
    .prof-row .lbl{color:var(--td)}.prof-row .val{color:var(--t);font-weight:500;font-family:'Space Mono',monospace;font-size:.72rem}
    .prof-xp{padding:0 16px 14px}.prof-xp-bar{height:6px;background:var(--glass);border-radius:4px;overflow:hidden;margin-top:4px}.prof-xp-fill{height:100%;background:linear-gradient(90deg,var(--a),#a78bfa);border-radius:4px}
    .prof-xp-text{display:flex;justify-content:space-between;font-size:.55rem;color:var(--td);margin-top:2px;font-family:'Space Mono',monospace}
    .prof-actions{padding:0 16px 16px;display:flex;gap:6px}
    .prof-actions .abtn{font-size:.78rem;padding:9px}
    .voice-btn{width:28px;height:28px;border-radius:50%;border:none;background:var(--a);color:#0a0a0f;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.7rem;flex-shrink:0;transition:all .2s;box-shadow:0 1px 6px var(--ag)}.voice-btn:hover{transform:scale(1.08)}.voice-btn.playing{background:#a78bfa}
    .voice-wave{flex:1;height:24px;display:flex;align-items:center;gap:1px}.voice-bar{width:3px;border-radius:2px;background:var(--a);opacity:.4;transition:all .15s}.voice-bar.active{opacity:1}
    .voice-time{font-size:.5rem;color:var(--td);font-family:'Space Mono',monospace;min-width:28px;text-align:right}
    @media(max-width:540px){.app{padding:6px 6px 0 6px}}
  </style>
</head>
<body>
<div class="splash" id="splash"><img src="logo.png" alt="K√ñRP√ú"><div class="splash-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
<div class="app">
<div class="auth" id="authScr">
  <img src="logo.png" class="auth-logo" alt=""><div class="auth-title">K√ñRP√ú</div><div class="auth-sub">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
  <div class="auth-card">
    <div class="tabs"><div class="tab on" id="tL" onclick="stab('l')">–í–æ–π—Ç–∏</div><div class="tab" id="tR" onclick="stab('r')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div></div>
    <div id="fL"><div class="field"><label>–õ–æ–≥–∏–Ω</label><input type="text" id="lU" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω..."></div><div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="lP" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å..."></div><button class="abtn abtn-p" onclick="doLogin()">–í–æ–π—Ç–∏</button></div>
    <div id="fR" style="display:none"><div class="field"><label>–ò–º—è</label><input type="text" id="rN" placeholder="–í–∞—à–µ –∏–º—è..."></div><div class="field"><label>–õ–æ–≥–∏–Ω</label><input type="text" id="rU" placeholder="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã..."></div><div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="rP" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞..."></div><div class="field"><label>–ê–≤–∞—Ç–∞—Ä</label><div class="avatar-pick" id="regAP"></div></div><button class="abtn abtn-p" onclick="doReg()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
    <div class="auth-err" id="aErr"></div>
    <div class="divider">–∏–ª–∏</div>
    <div class="anon-box"><div class="anon-title">üï∂ –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç</div><div class="field"><label style="text-align:center">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</label><input type="text" id="gN" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è..." style="text-align:center"></div><button class="abtn abtn-g" onclick="doGuest()">–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ</button></div>
    <div class="saved-info" id="savedInfo" style="display:none">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: <a id="savedU" onclick="quickL()"></a></div>
  </div>
</div>
<div class="chat" id="chatScr">
  <div class="hdr"><div class="logo">K√ñRP√ú</div><div class="hdr-r">
    <div class="badge on" id="stB">–û–§–õ–ê–ô–ù</div>
    <div class="ib" onclick="isDark=!isDark;document.documentElement.classList.toggle('light',!isDark)">üåô</div>
    <div class="ib" id="menuBtn" onclick="toggleMenu()">‚ò∞</div>
  </div></div>
  <!-- Side Menu -->
  <div class="menu-overlay" id="menuOv" onclick="toggleMenu()"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <span class="av-icon" id="menuAv" onclick="showProfile(myId);toggleMenu()" style="cursor:pointer;font-size:1.8rem">üê±</span>
      <div><div class="menu-name" id="menuNm">‚Äî</div><div class="menu-login" id="menuLg">@‚Äî</div></div>
      <span class="lvl-badge" id="menuLvl" style="font-size:.7rem;padding:3px 8px">LVL 1</span>
    </div>
    <div class="menu-xp"><div class="xp-bar"><div class="xp-fill" id="xpFill" style="width:0%"></div></div><div class="xp-text"><span id="xpTxt">0 XP</span><span id="xpNext">‚Üí 50 XP</span></div></div>
    <div class="lang-sw"><button class="lang-btn" onclick="setLang('ru')">RU</button><button class="lang-btn" onclick="setLang('en')">EN</button><button class="lang-btn" onclick="setLang('az')">AZ</button></div>
    <div class="menu-items" id="menuItems">
      <div class="menu-item" onclick="toggleMenu();toggleP('oP')">üë• –û–Ω–ª–∞–π–Ω</div>
      <div class="menu-item" onclick="toggleMenu();toggleP('fP')">üë´ –î—Ä—É–∑—å—è</div>
      <div class="menu-item" onclick="toggleMenu();toggleP('gP')">üí¨ –ì—Ä—É–ø–ø—ã</div>
      <div class="menu-item" onclick="toggleMenu();toggleP('sP')">üîç –ü–æ–∏—Å–∫</div>
      <div class="menu-item" onclick="toggleMenu();openGames()">üéÆ –ò–≥—Ä—ã</div>
      <div class="menu-item" onclick="toggleMenu();toggleP('stP')">‚ö° –°—Ç–∞—Ç—É—Å</div>
      <div class="menu-item" onclick="toggleMenu();cpId()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</div>
      <div class="menu-item" onclick="toggleMenu();showUpdate()">üîÑ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?</div>
      <div class="menu-item" onclick="toggleMenu();showProfile(myId)">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
    </div>
    <div class="menu-bottom"><div class="menu-item danger" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</div></div>
  </div>
  <div class="panel" id="stP"><div class="panel-title">–°–¢–ê–¢–£–°</div><span class="st-opt" onclick="setSt('–û–Ω–ª–∞–π–Ω')">üü¢ –û–Ω–ª–∞–π–Ω</span><span class="st-opt" onclick="setSt('–û—Ç–¥—ã—Ö–∞—é')">üò¥ –û—Ç–¥—ã—Ö–∞—é</span><span class="st-opt" onclick="setSt('–ö—É-–ö—É')">üëã –ö—É-–ö—É</span><span class="st-opt" onclick="setSt('–û–Ω —Ç—É—Ç')">üëÄ –û–Ω —Ç—É—Ç</span><span class="st-opt" onclick="setSt('–ó–∞–Ω—è—Ç')">üî¥ –ó–∞–Ω—è—Ç</span><span class="st-opt" onclick="setSt('–ò–≥—Ä–∞—é')">üéÆ –ò–≥—Ä–∞—é</span></div>
  <div class="panel" id="oP"><div class="panel-title">–û–ù–õ–ê–ô–ù</div><div id="oL"></div></div>
  <div class="panel" id="fP"><div class="panel-title">–î–†–£–ó–¨–Ø <span class="mini-btn" onclick="toggleP('grpC')">+ –ì—Ä—É–ø–ø–∞</span><span class="mini-btn" onclick="toggleP('blP')">üö´</span></div><div id="fL2"></div><div class="add-row"><input type="text" id="addFI" placeholder="–õ–æ–≥–∏–Ω –¥—Ä—É–≥–∞..."><button class="mini-btn" onclick="addFriend()">‚ûï</button></div></div>
  <div class="panel" id="blP"><div class="panel-title">–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï</div><div id="blL"></div></div>
  <div class="panel" id="gP"><div class="panel-title">–ì–†–£–ü–ü–´</div><div id="gL"></div></div>
  <div class="panel" id="grpC"><div class="panel-title">–°–û–ó–î–ê–¢–¨ –ì–†–£–ü–ü–£</div><div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="grpName" placeholder="–ò–º—è –≥—Ä—É–ø–ø—ã..."></div><div class="panel-title" style="margin-top:4px">–í–´–ë–ï–†–ò –î–†–£–ó–ï–ô</div><div class="grp-member-pick" id="grpMemPick"></div><button class="abtn abtn-p" style="font-size:.75rem;padding:8px" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button></div>
  <div class="panel" id="sP"><div class="panel-title">–ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô</div><div class="search-row"><input type="text" id="searchI" placeholder="–ò–º—è –∏–ª–∏ –ª–æ–≥–∏–Ω..." oninput="doSearch()"><button class="mini-btn" onclick="doSearch()">üîç</button></div><div class="search-results" id="searchR"></div></div>
  <div class="games-panel" id="gamesP"><div class="panel-title" id="gamesPTitle">üéÆ –ò–ì–†–´</div><div id="gamesContent"></div></div>
  <div class="conn-row" id="cC"><input type="text" id="pId" placeholder="ID –∏–ª–∏ –ª–æ–≥–∏–Ω..."><button class="conn-btn" onclick="doConn()">‚Üí</button></div>
  <div class="rps-bar" id="rpsBar"><div class="rps-title" id="rpsTitle">üé≤ –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞</div><div class="rps-choices"><div class="rps-choice" onclick="rpsPlay('rock')">ü™®</div><div class="rps-choice" onclick="rpsPlay('paper')">üìÑ</div><div class="rps-choice" onclick="rpsPlay('scissors')">‚úÇÔ∏è</div></div></div>
  <div class="chat-tabs" id="chatTabs"></div>
  <div class="reply-bar" id="replyBar"><span>‚Ü©Ô∏è</span><span class="rtext" id="replyText"></span><span class="rclose" onclick="cancelReply()">‚úï</span></div>
  <div class="msa"><div class="msg-container" id="msgArea"></div><div id="ti"></div></div>
  <div class="ibar" style="position:relative">
    <div class="ib" onclick="document.getElementById('eP').classList.toggle('show')">üòä</div>
    <div class="bm" id="mic" onmousedown="srec()" onmouseup="erec()" ontouchstart="srec()" ontouchend="erec()">üé§</div>
    <input type="text" id="mI" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="hk(event)">
    <button class="bs" onclick="snd()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    <div class="ep" id="eP"></div>
  </div>
</div>
</div>
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="modal"><div class="modal-title" id="modalTitle"></div><div class="modal-text" id="modalText"></div><button class="modal-close" onclick="document.getElementById('modalBg').classList.remove('show')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
<div class="modal-bg" id="ckBg" onclick="if(event.target===this&&!ckGame)this.classList.remove('show')"><div class="ck-modal" id="ckModal"></div></div>
<div class="ach-toast" id="achToast"><div class="ach-lbl" id="achToastLbl">üèÖ</div><div class="ach-icon" id="achToastIcon"></div><div class="ach-name" id="achToastName"></div></div>
<div class="modal-bg" id="profBg" onclick="if(event.target===this)this.classList.remove('show')"><div class="profile-modal" id="profModal"></div></div>
<div class="rp" id="rPk"><span onclick="doReact('üëç')">üëç</span><span onclick="doReact('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="doReact('üòÇ')">üòÇ</span><span onclick="doReact('üòÆ')">üòÆ</span><span onclick="doReact('üò¢')">üò¢</span><span onclick="doReact('üî•')">üî•</span></div>
<script>
const WS='wss://korpu-server.onrender.com',API=WS.replace('wss','https');
const EM=['üòÄ','üòÇ','ü§£','üòä','üòç','ü•∞','üòò','üòé','ü§©','ü•≥','üòè','üò¢','üò≠','üò§','ü§Ø','ü§î','ü§´','ü§ó','üò¥','üëç','üëé','üëã','üôè','üí™','‚ù§Ô∏è','üî•','‚≠ê','üéâ','üíØ','‚úÖ','‚ùå','üíÄ','üëÄ','üöÄ','‚òï','üçï','üéµ','ü´°','ü´∂','ü§Æ'];
const AVS=['üê±','üê∂','ü¶ä','üêº','üê®','ü¶Å','üêØ','üê∏','üêµ','ü¶Ñ','üê∫','üê∞','üêª','ü¶ã','üêô','üêß'];
const XPL=[0,50,150,300,500,800,1200,1800,2500,3500,5000];

// i18n
let curLang=localStorage.getItem('kLang')||'ru';
const L={
  ru:{login:'–í–æ–π—Ç–∏',register:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',loginField:'–õ–æ–≥–∏–Ω',passField:'–ü–∞—Ä–æ–ª—å',nameField:'–ò–º—è',avatarField:'–ê–≤–∞—Ç–∞—Ä',enterLogin:'–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω...',enterPass:'–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å...',enterName:'–í–∞—à–µ –∏–º—è...',onlyLetters:'–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã...',min4:'–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞...',doLogin:'–í–æ–π—Ç–∏',doReg:'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',or:'–∏–ª–∏',anonChat:'üï∂ –ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç',nickname:'–í–∞—à –Ω–∏–∫–Ω–µ–π–º',enterNick:'–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è...',enterAnon:'–í–æ–π—Ç–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ',lastLogin:'–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:',fillAll:'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',min2:'–ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞',offline:'–û–§–õ–ê–ô–ù',online:'–û–ù–õ–ê–ô–ù',anon:'–ê–ù–û–ù–ò–ú',msg:'–°–æ–æ–±—â–µ–Ω–∏–µ...',idOrLogin:'ID –∏–ª–∏ –ª–æ–≥–∏–Ω...',status:'–°–¢–ê–¢–£–°',onlineList:'–û–Ω–ª–∞–π–Ω',friends:'–î—Ä—É–∑—å—è',groups:'–ì—Ä—É–ø–ø—ã',search:'–ü–æ–∏—Å–∫',setStatus:'–°—Ç–∞—Ç—É—Å',copyId:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID',whatsNew:'–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?',myProfile:'–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å',logout:'–í—ã–π—Ç–∏',blocked:'–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ï',createGrp:'–°–û–ó–î–ê–¢–¨ –ì–†–£–ü–ü–£',grpName:'–ò–º—è –≥—Ä—É–ø–ø—ã...',pickFriends:'–í–´–ë–ï–†–ò –î–†–£–ó–ï–ô',create:'–°–æ–∑–¥–∞—Ç—å',searchUsers:'–ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô',nameOrLogin:'–ò–º—è –∏–ª–∏ –ª–æ–≥–∏–Ω...',friendLogin:'–õ–æ–≥–∏–Ω –¥—Ä—É–≥–∞...',connect:'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',connected:'–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫',notOnline:'–Ω–µ –≤ —Å–µ—Ç–∏',typing:'–ø–µ—á–∞—Ç–∞–µ—Ç...',achUnlocked:'–î–û–°–¢–ò–ñ–ï–ù–ò–ï',messages:'–°–æ–æ–±—â–µ–Ω–∏–π',days:'–î–Ω–µ–π',friendsN:'–î—Ä—É–∑–µ–π',experience:'–û–ü–´–¢',games:'–ò–≥—Ä—ã',regDate:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',lastVisit:'–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç',write:'–ù–∞–ø–∏—Å–∞—Ç—å',addFriend:'–í –¥—Ä—É–∑—å—è',close:'–ó–∞–∫—Ä—ã—Ç—å',achievements:'–î–û–°–¢–ò–ñ–ï–ù–ò–Ø',aboutMe:'–û —Å–µ–±–µ...',checkers:'–®–ê–®–ö–ò',yourTurn:'–í–∞—à —Ö–æ–¥',oppTurn:'–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞',resign:'–°–¥–∞—Ç—å—Å—è',resignConfirm:'–°–¥–∞—Ç—å—Å—è?',ckInviteSent:'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —à–∞—à–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',ckInviteMsg:'–ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤ —à–∞—à–∫–∏!',accept:'–ü—Ä–∏–Ω—è—Ç—å',gameOver:'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê',oppResigned:'–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–¥–∞–ª—Å—è!',youWin:'–í—ã –ø–æ–±–µ–¥–∏–ª–∏!',youLose:'–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏',games2:'–ò–≥—Ä—ã',rps:'–ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞',rpsDesc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ –Ω–∞ —É–¥–∞—á—É',checkersName:'–®–∞—à–∫–∏',checkersDesc:'–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è –∏–≥—Ä–∞',pickOpponent:'–í–´–ë–ï–†–ò –°–û–ü–ï–†–ù–ò–ö–ê',noFriendsOnline:'–ù–µ—Ç –¥—Ä—É–∑–µ–π –æ–Ω–ª–∞–π–Ω'},
  en:{login:'Login',register:'Register',loginField:'Login',passField:'Password',nameField:'Name',avatarField:'Avatar',enterLogin:'Enter login...',enterPass:'Enter password...',enterName:'Your name...',onlyLetters:'Letters and numbers...',min4:'Min 4 characters...',doLogin:'Sign In',doReg:'Register',or:'or',anonChat:'üï∂ Anonymous chat',nickname:'Your nickname',enterNick:'Choose name...',enterAnon:'Enter anonymously',lastLogin:'Last login:',fillAll:'Fill all fields',min2:'Min 2 characters',offline:'OFFLINE',online:'ONLINE',anon:'ANON',msg:'Message...',idOrLogin:'ID or login...',status:'STATUS',onlineList:'Online',friends:'Friends',groups:'Groups',search:'Search',setStatus:'Status',copyId:'Copy ID',whatsNew:'What\'s new?',myProfile:'My Profile',logout:'Log out',blocked:'BLOCKED',createGrp:'CREATE GROUP',grpName:'Group name...',pickFriends:'PICK FRIENDS',create:'Create',searchUsers:'SEARCH USERS',nameOrLogin:'Name or login...',friendLogin:'Friend login...',connect:'Connect',connected:'Connected to',notOnline:'is offline',typing:'typing...',achUnlocked:'ACHIEVEMENT',messages:'Messages',days:'Days',friendsN:'Friends',experience:'XP',games:'Games',regDate:'Registered',lastVisit:'Last visit',write:'Message',addFriend:'Add friend',close:'Close',achievements:'ACHIEVEMENTS',aboutMe:'About me...',checkers:'CHECKERS',yourTurn:'Your turn',oppTurn:'Opponent\'s turn',resign:'Resign',resignConfirm:'Resign?',ckInviteSent:'Checkers invite sent',ckInviteMsg:'invites you to checkers!',accept:'Accept',gameOver:'GAME OVER',oppResigned:'Opponent resigned!',youWin:'You won!',youLose:'You lost',games2:'Games',rps:'Rock-Paper-Scissors',rpsDesc:'Classic luck game',checkersName:'Checkers',checkersDesc:'Strategy board game',pickOpponent:'PICK OPPONENT',noFriendsOnline:'No friends online'},
  az:{login:'Daxil ol',register:'Qeydiyyat',loginField:'Login',passField:'≈ûifr…ô',nameField:'Ad',avatarField:'Avatar',enterLogin:'Login daxil edin...',enterPass:'≈ûifr…ô daxil edin...',enterName:'Adƒ±nƒ±z...',onlyLetters:'H…ôrf v…ô r…ôq…ôml…ôr...',min4:'Minimum 4 simvol...',doLogin:'Daxil ol',doReg:'Qeydiyyatdan ke√ß',or:'v…ô ya',anonChat:'üï∂ Anonim √ßat',nickname:'L…ôq…ôbiniz',enterNick:'Ad se√ßin...',enterAnon:'Anonim daxil ol',lastLogin:'Son giri≈ü:',fillAll:'B√ºt√ºn sah…ôl…ôri doldurun',min2:'Minimum 2 simvol',offline:'OFFLAYn',online:'ONLAYN',anon:'ANONƒ∞M',msg:'Mesaj...',idOrLogin:'ID v…ô ya login...',status:'STATUS',onlineList:'Onlayn',friends:'Dostlar',groups:'Qruplar',search:'Axtar',setStatus:'Status',copyId:'ID kopyala',whatsNew:'Yenilikl…ôr',myProfile:'Profilim',logout:'√áƒ±xƒ±≈ü',blocked:'BLOKLANMI≈û',createGrp:'QRUP YARAT',grpName:'Qrup adƒ±...',pickFriends:'DOST SE√á',create:'Yarat',searchUsers:'ƒ∞STƒ∞FAD∆è√áƒ∞ AXTAR',nameOrLogin:'Ad v…ô ya login...',friendLogin:'Dost logini...',connect:'Qo≈üul',connected:'Qo≈üuldu:',notOnline:'onlayn deyil',typing:'yazƒ±r...',achUnlocked:'NAƒ∞Lƒ∞YY∆èT',messages:'Mesaj',days:'G√ºn',friendsN:'Dost',experience:'XP',games:'Oyun',regDate:'Qeydiyyat',lastVisit:'Son giri≈ü',write:'Yaz',addFriend:'Dost …ôlav…ô et',close:'Baƒüla',achievements:'NAƒ∞Lƒ∞YY∆èTL∆èR',aboutMe:'Haqqƒ±nda...',checkers:'DAMA',yourTurn:'Sizin n√∂vb…ô',oppTurn:'R…ôqibin n√∂vb…ôsi',resign:'T…ôslim ol',resignConfirm:'T…ôslim olursan?',ckInviteSent:'Dama d…ôv…ôti g√∂nd…ôrildi',ckInviteMsg:'sizi damaya d…ôv…ôt edir!',accept:'Q…ôbul et',gameOver:'OYUN Bƒ∞TDƒ∞',oppResigned:'R…ôqib t…ôslim oldu!',youWin:'Siz qazandƒ±nƒ±z!',youLose:'Siz uduzudunuz',games2:'Oyunlar',rps:'Da≈ü-Kaƒüƒ±z-Qay√ßƒ±',rpsDesc:'Klassik ≈üans oyunu',checkersName:'Dama',checkersDesc:'Strateji masa oyunu',pickOpponent:'R∆èQƒ∞B SE√á',noFriendsOnline:'Onlayn dost yoxdur'}
};
const ACHS=[
  {id:'first_msg',icon:'üí¨',name:{ru:'–ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ',en:'First Word',az:'ƒ∞lk s√∂z'}},
  {id:'msg_100',icon:'üìù',name:{ru:'–ë–æ–ª—Ç—É–Ω',en:'Chatterbox',az:'Danƒ±≈üqan'}},
  {id:'msg_1000',icon:'üó£',name:{ru:'–û—Ä–∞—Ç–æ—Ä',en:'Orator',az:'Natiq'}},
  {id:'lvl5',icon:'‚≠ê',name:{ru:'–û–ø—ã—Ç–Ω—ã–π',en:'Experienced',az:'T…ôcr√ºb…ôli'}},
  {id:'lvl10',icon:'üëë',name:{ru:'–õ–µ–≥–µ–Ω–¥–∞',en:'Legend',az:'∆èfsan…ô'}},
  {id:'first_friend',icon:'ü§ù',name:{ru:'–î—Ä—É–∂–±–∞',en:'Friendship',az:'Dostluq'}},
  {id:'friends_10',icon:'üë•',name:{ru:'–ü–æ–ø—É–ª—è—Ä–Ω—ã–π',en:'Popular',az:'Populyar'}},
  {id:'first_win',icon:'üé≤',name:{ru:'–ü–æ–±–µ–¥–∏—Ç–µ–ª—å',en:'Winner',az:'Qalib'}},
  {id:'wins_10',icon:'üèÜ',name:{ru:'–ß–µ–º–ø–∏–æ–Ω',en:'Champion',az:'√áempion'}},
  {id:'week_old',icon:'üìÖ',name:{ru:'–°—Ç–∞—Ä–æ–∂–∏–ª',en:'Veteran',az:'K√∂hn…ô sakin'}},
  {id:'month_old',icon:'üóì',name:{ru:'–î–æ–ª–≥–æ–∂–∏—Ç–µ–ª—å',en:'Long-timer',az:'Uzun√∂m√ºrl√º'}},
  {id:'bio_set',icon:'‚úèÔ∏è',name:{ru:'–õ–∏—á–Ω–æ—Å—Ç—å',en:'Personality',az:'≈û…ôxsiyy…ôt'}}
];
function t(key){return L[curLang]?.[key]||L.ru[key]||key}
function setLang(lang){curLang=lang;localStorage.setItem('kLang',lang);applyLang();document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('on',b.textContent===lang.toUpperCase()))}
function applyLang(){
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('on',b.textContent===curLang.toUpperCase()));
  const $=id=>document.getElementById(id);
  if($('lU'))$('lU').placeholder=t('enterLogin');if($('lP'))$('lP').placeholder=t('enterPass');
  if($('rN'))$('rN').placeholder=t('enterName');if($('rU'))$('rU').placeholder=t('onlyLetters');if($('rP'))$('rP').placeholder=t('min4');
  if($('gN'))$('gN').placeholder=t('enterNick');if($('mI'))$('mI').placeholder=t('msg');if($('pId'))$('pId').placeholder=t('idOrLogin');
  if($('searchI'))$('searchI').placeholder=t('nameOrLogin');if($('addFI'))$('addFI').placeholder=t('friendLogin');
  if($('grpName'))$('grpName').placeholder=t('grpName');
  const mi=document.getElementById('menuItems');
  if(mi)mi.innerHTML='<div class="menu-item" onclick="toggleMenu();toggleP(\'oP\')">üë• '+t('onlineList')+'</div><div class="menu-item" onclick="toggleMenu();toggleP(\'fP\')">üë´ '+t('friends')+'</div><div class="menu-item" onclick="toggleMenu();toggleP(\'gP\')">üí¨ '+t('groups')+'</div><div class="menu-item" onclick="toggleMenu();toggleP(\'sP\')">üîç '+t('search')+'</div><div class="menu-item" onclick="toggleMenu();openGames()">üéÆ '+t('games2')+'</div><div class="menu-item" onclick="toggleMenu();toggleP(\'stP\')">‚ö° '+t('setStatus')+'</div><div class="menu-item" onclick="toggleMenu();cpId()">üìã '+t('copyId')+'</div><div class="menu-item" onclick="toggleMenu();showUpdate()">üîÑ '+t('whatsNew')+'</div><div class="menu-item" onclick="toggleMenu();showProfile(myId)">üë§ '+t('myProfile')+'</div>';
}
function showAchToast(ids){
  ids.forEach((id,i)=>{
    const a=ACHS.find(x=>x.id===id);if(!a)return;
    setTimeout(()=>{
      document.getElementById('achToastLbl').textContent='üèÖ '+t('achUnlocked');
      document.getElementById('achToastIcon').textContent=a.icon;
      document.getElementById('achToastName').textContent=a.name[curLang]||a.name.ru;
      document.getElementById('achToast').classList.add('show');
      setTimeout(()=>document.getElementById('achToast').classList.remove('show'),3000);
    },i*3500);
  });
}
let ws,myId,myName,myAvatar='üê±',myStatus='',myXP=0,myLevel=1,isG=false,isDark=true;
let activeChat=null,friendsList=[],groupsList=[],blockList=[];
const chats={},mE={},polls={};
let tto,mRec,aCh=[],isRec=false,rTgt,regAv='üê±',grpSel=new Set();
let replyToId=null,replyToText=null;
const ax=new(window.AudioContext||window.webkitAudioContext)();
function bp(f,d){try{const o=ax.createOscillator(),g=ax.createGain();o.connect(g);g.connect(ax.destination);o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(.1,ax.currentTime);g.gain.exponentialRampToValueAtTime(.001,ax.currentTime+d);o.start();o.stop(ax.currentTime+d)}catch(e){}}
function sS(){bp(880,.1)}function sR2(){bp(660,.12);setTimeout(()=>bp(880,.1),100)}function sC(){bp(523,.1);setTimeout(()=>bp(659,.1),120);setTimeout(()=>bp(784,.15),240)}
function stab(t){document.getElementById('tL').classList.toggle('on',t==='l');document.getElementById('tR').classList.toggle('on',t==='r');document.getElementById('fL').style.display=t==='l'?'':'none';document.getElementById('fR').style.display=t==='r'?'':'none';document.getElementById('aErr').textContent=''}
function initAP(){const c=document.getElementById('regAP');AVS.forEach(a=>{const d=document.createElement('div');d.className='av-opt'+(a==='üê±'?' sel':'');d.textContent=a;d.onclick=()=>{c.querySelectorAll('.av-opt').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');regAv=a};c.appendChild(d)})}
function toggleP(id){document.getElementById(id).classList.toggle('show')}
function showUpdate(){fetch(API+'/changelog').then(r=>r.json()).then(d=>{document.getElementById('modalTitle').textContent='üîÑ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?';document.getElementById('modalText').textContent=d.changelog||'';document.getElementById('modalBg').classList.add('show')}).catch(()=>{})}
function updateXP(){const c=XPL[myLevel-1]||0,n=XPL[myLevel]||XPL[XPL.length-1];const p=Math.min(100,((myXP-c)/(n-c))*100);document.getElementById('xpFill').style.width=p+'%';document.getElementById('xpTxt').textContent=myXP+' XP';document.getElementById('xpNext').textContent='‚Üí '+n+' XP';document.getElementById('menuLvl').textContent='LVL '+myLevel}
function cwss(onO){ws=new WebSocket(WS);ws.onopen=onO;ws.onmessage=e=>{try{handle(JSON.parse(e.data))}catch(er){console.error(er)}};ws.onclose=()=>{if(myId)setTimeout(reconn,3000)};ws.onerror=()=>{document.getElementById('aErr').textContent='–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}}
function reconn(){cwss(()=>{if(isG)ws.send(JSON.stringify({type:'guest_login',nickname:myName}));else{const s=localStorage.getItem('kc');if(s){const c=JSON.parse(s);ws.send(JSON.stringify({type:'auth_login',login:c.l,password:c.p}))}}})}
function doLogin(){const l=document.getElementById('lU').value.trim(),p=document.getElementById('lP').value;if(!l||!p)return se(t('fillAll'));cwss(()=>{ws.send(JSON.stringify({type:'auth_login',login:l,password:p}));localStorage.setItem('kc',JSON.stringify({l,p}))})}
function doReg(){const n=document.getElementById('rN').value.trim(),l=document.getElementById('rU').value.trim(),p=document.getElementById('rP').value;if(!l||!p)return se(t('fillAll'));cwss(()=>{ws.send(JSON.stringify({type:'auth_register',login:l,password:p,displayName:n||l,avatar:regAv}));localStorage.setItem('kc',JSON.stringify({l,p}))})}
function doGuest(){const n=document.getElementById('gN').value.trim();if(!n||n.length<2)return se(t('min2'));cwss(()=>ws.send(JSON.stringify({type:'guest_login',nickname:n})))}
function se(t){document.getElementById('aErr').textContent=t}
function quickL(){const s=JSON.parse(localStorage.getItem('kc'));if(s){document.getElementById('lU').value=s.l;doLogin()}}
function doLogout(){if(ws)ws.close();myId=null;activeChat=null;Object.keys(chats).forEach(k=>delete chats[k]);friendsList=[];groupsList=[];document.getElementById('authScr').style.display='flex';document.getElementById('chatScr').classList.remove('on');document.getElementById('msgArea').innerHTML='';document.getElementById('chatTabs').innerHTML=''}
function showChat(){document.getElementById('authScr').style.display='none';document.getElementById('chatScr').classList.add('on');
  if(!isG){document.getElementById('menuItems').style.display=''}
  document.getElementById('menuAv').textContent=myAvatar;document.getElementById('menuNm').textContent=myName;
  document.getElementById('menuLg').textContent=isG?'(–∞–Ω–æ–Ω–∏–º)':'@'+myId;
  updateXP()}
function toggleMenu(){document.getElementById('sideMenu').classList.toggle('show');document.getElementById('menuOv').classList.toggle('show')}
function cpId(){navigator.clipboard.writeText(myId).catch(()=>{})}
function setSt(s){myStatus=s;document.getElementById('stP').classList.remove('show');if(ws)ws.send(JSON.stringify({type:'update_status',status:s}))}
function showProfile(id){
  fetch(API+'/profile?id='+encodeURIComponent(id)).then(r=>r.json()).then(p=>{
    if(p.error)return;
    const isMe=p.id===myId;
    const isFr=friendsList.some(f=>f.id===p.id);
    const created=new Date(p.createdAt).toLocaleDateString('ru-RU');
    const lastSeen=new Date(p.lastLogin).toLocaleDateString('ru-RU');
    const xpCur=XPL[p.level-1]||0,xpNext=XPL[p.level]||XPL[XPL.length-1];
    const xpPct=Math.min(100,((p.xp-xpCur)/(xpNext-xpCur))*100);
    const winRate=p.gamesPlayed>0?Math.round((p.gamesWon/p.gamesPlayed)*100):0;
    let h='<div class="prof-header">';
    h+='<div class="prof-avatar">'+p.avatar+'</div>';
    h+='<div class="prof-name">'+p.displayName+'</div>';
    h+='<div class="prof-login">@'+p.id+'</div>';
    h+='<span class="prof-level">LVL '+p.level+'</span>';
    h+='<span class="prof-online '+(p.online?'on':'off')+'">'+(p.online?'‚óè –û–Ω–ª–∞–π–Ω':'‚óã –û—Ñ—Ñ–ª–∞–π–Ω')+'</span>';
    h+='</div>';
    if(isMe)h+='<div class="prof-bio"><textarea class="prof-bio-edit" id="bioEdit" rows="2" maxlength="200" placeholder="–û —Å–µ–±–µ..."'+(p.bio?' ':'')+'onblur="saveBio()">'+escH(p.bio)+'</textarea></div>';
    else if(p.bio)h+='<div class="prof-bio">¬´'+escH(p.bio)+'¬ª</div>';
    h+='<div class="prof-stats">';
    h+='<div class="prof-stat"><div class="val">'+p.messages+'</div><div class="lbl">'+t('messages')+'</div></div>';
    h+='<div class="prof-stat"><div class="val">'+p.daysInChat+'</div><div class="lbl">'+t('days')+'</div></div>';
    h+='<div class="prof-stat"><div class="val">'+p.friends+'</div><div class="lbl">'+t('friendsN')+'</div></div>';
    h+='</div>';
    h+='<div class="prof-xp"><div style="font-size:.65rem;color:var(--td);font-family:\'Space Mono\',monospace">'+t('experience')+'</div><div class="prof-xp-bar"><div class="prof-xp-fill" style="width:'+xpPct+'%"></div></div><div class="prof-xp-text"><span>'+p.xp+' XP</span><span>'+xpNext+' XP</span></div></div>';
    h+='<div class="prof-details">';
    h+='<div class="prof-row"><span class="lbl">üé≤ '+t('games')+'</span><span class="val">'+p.gamesWon+'/'+p.gamesPlayed+(p.gamesPlayed>0?' ('+winRate+'%)':'')+'</span></div>';
    h+='<div class="prof-row"><span class="lbl">üìÖ '+t('regDate')+'</span><span class="val">'+created+'</span></div>';
    h+='<div class="prof-row"><span class="lbl">üïê '+t('lastVisit')+'</span><span class="val">'+lastSeen+'</span></div>';
    h+='</div>';
    h+='<div style="padding:0 16px 4px;font-size:.65rem;text-transform:uppercase;letter-spacing:2px;color:var(--td);font-family:\'Space Mono\',monospace">'+t('achievements')+'</div>';
    h+='<div class="ach-grid">';
    ACHS.forEach(a=>{const earned=(p.achievements||[]).includes(a.id);h+='<div class="ach-item '+(earned?'earned':'locked')+'" title="'+(a.name[curLang]||a.name.ru)+'">'+a.icon+'<div class="ach-tip">'+(a.name[curLang]||a.name.ru)+'</div></div>'});
    h+='</div>';
    if(!isMe){h+='<div class="prof-actions">';
      h+='<button class="abtn abtn-p" onclick="document.getElementById(\'pId\').value=\''+p.id+'\';doConn();document.getElementById(\'profBg\').classList.remove(\'show\')">üí¨ '+t('write')+'</button>';
      if(!isFr)h+='<button class="abtn abtn-g" onclick="addFD(\''+p.id+'\')">‚ûï '+t('addFriend')+'</button>';
      h+='</div>'}
    else{h+='<div class="prof-actions"><button class="abtn abtn-g" onclick="document.getElementById(\'profBg\').classList.remove(\'show\')">'+t('close')+'</button></div>'}
    document.getElementById('profModal').innerHTML=h;
    document.getElementById('profBg').classList.add('show');
  }).catch(()=>{})
}
function escH(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function saveBio(){const el=document.getElementById('bioEdit');if(!el||!ws)return;ws.send(JSON.stringify({type:'update_bio',bio:el.value}))}

// === CHECKERS ===
let ckGame=null,ckSel=null,ckMust=null;
function ckInvite(id){if(!ws)return;ws.send(JSON.stringify({type:'checkers_invite',target:id}));ensureChat(id,id);addToChat(id,{type:'y',text:'‚ôü '+t('ckInviteSent')||'–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —à–∞—à–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'})}
function ckAccept(from){if(!ws)return;ws.send(JSON.stringify({type:'checkers_accept',target:from}))}
function ckStartGame(data){
  ckGame={id:data.gameId,board:data.board,turn:data.turn,black:data.black,white:data.white,myColor:data.black===myId?'black':'white'};
  ckSel=null;ckMust=null;
  ckRender();document.getElementById('ckBg').classList.add('show');
}
function ckGetCaptures(board,r,c){
  const p=board[r][c];if(!p)return[];
  const isBlack=p===1||p===3;
  const caps=[];const dirs=[[-1,-1],[-1,1],[1,-1],[1,1]];
  for(const [dr,dc] of dirs){
    const mr=r+dr,mc=c+dc,jr=r+dr*2,jc=c+dc*2;
    if(jr<0||jr>7||jc<0||jc>7)continue;
    const mid=board[mr][mc];if(!mid)continue;
    const midBlack=mid===1||mid===3;
    if(midBlack===isBlack)continue;
    if(board[jr][jc]===0)caps.push({to:[jr,jc],captured:[mr,mc]});
  }
  return caps;
}
function ckGetMoves(board,r,c){
  const p=board[r][c];if(!p)return[];
  const isBlack=p===1||p===3;const isKing=p===3||p===4;
  const dirs=isKing?[[-1,-1],[-1,1],[1,-1],[1,1]]:isBlack?[[-1,-1],[-1,1]]:[[1,-1],[1,1]];
  const moves=[];
  for(const [dr,dc] of dirs){
    const nr=r+dr,nc=c+dc;
    if(nr<0||nr>7||nc<0||nc>7)continue;
    if(board[nr][nc]===0)moves.push({to:[nr,nc]});
  }
  return moves;
}
function ckHasCaptures(board,color){
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=board[r][c];if(!p)continue;
    const isBlack=p===1||p===3;
    if((color==='black')!==isBlack)continue;
    if(ckGetCaptures(board,r,c).length>0)return true;
  }
  return false;
}
function ckCountPieces(board){
  let b=0,w=0;
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=board[r][c];if(p===1||p===3)b++;if(p===2||p===4)w++;}
  return{b,w};
}
function ckRender(){
  if(!ckGame)return;
  const g=ckGame,myTurn=g.turn===g.myColor;
  const flip=g.myColor==='white';
  const cnt=ckCountPieces(g.board);
  const myPieces=g.myColor==='black'?cnt.b:cnt.w;
  const oppPieces=g.myColor==='black'?cnt.w:cnt.b;
  let h='<div class="ck-title">‚ôü '+(t('checkers')||'–®–ê–®–ö–ò')+'</div>';
  h+='<div class="ck-status">'+(myTurn?('üü¢ '+(t('yourTurn')||'–í–∞—à —Ö–æ–¥')):('‚è≥ '+(t('oppTurn')||'–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞')))+'</div>';
  h+='<div class="ck-score"><span class="you">'+(g.myColor==='black'?'‚ö´':'‚ö™')+' '+myPieces+'</span><span>vs</span><span class="opp">'+(g.myColor==='black'?'‚ö™':'‚ö´')+' '+oppPieces+'</span></div>';
  h+='<div class="ck-board">';
  const forceCapture=myTurn&&ckHasCaptures(g.board,g.myColor);
  for(let ri=0;ri<8;ri++){
    const r=flip?7-ri:ri;
    for(let ci=0;ci<8;ci++){
      const c=flip?7-ci:ci;
      const isDark=(r+c)%2===1;
      const p=g.board[r][c];
      let cls='ck-cell '+(isDark?'dark':'light');
      if(ckSel&&ckSel[0]===r&&ckSel[1]===c)cls+=' sel';
      if(g.lastMove){if(g.lastMove.from[0]===r&&g.lastMove.from[1]===c)cls+=' last-from';if(g.lastMove.to[0]===r&&g.lastMove.to[1]===c)cls+=' last-to';}
      // Hints
      if(ckSel&&myTurn){
        const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
        const isCap=caps.some(x=>x.to[0]===r&&x.to[1]===c);
        if(isCap)cls+=' cap-hint';
        if(!forceCapture&&!isCap){
          const mvs=ckGetMoves(g.board,ckSel[0],ckSel[1]);
          if(mvs.some(x=>x.to[0]===r&&x.to[1]===c))cls+=' hint';
        }
      }
      h+='<div class="'+cls+'" onclick="ckClick('+r+','+c+')">';
      if(p){
        const isBlack=p===1||p===3;const isKing=p===3||p===4;
        h+='<div class="ck-piece '+(isBlack?'black':'white')+(isKing?' king':'')+'"></div>';
      }
      h+='</div>';
    }
  }
  h+='</div>';
  h+='<div class="ck-actions"><button class="danger" onclick="ckResign()">üè≥ '+(t('resign')||'–°–¥–∞—Ç—å—Å—è')+'</button></div>';
  document.getElementById('ckModal').innerHTML=h;
}
function ckClick(r,c){
  if(!ckGame||ckGame.turn!==ckGame.myColor)return;
  const g=ckGame,p=g.board[r][c];
  const isBlack=p===1||p===3;
  const isMine=(g.myColor==='black'&&isBlack)||(g.myColor==='white'&&!isBlack&&p>0);
  // If must continue chain capture
  if(ckMust){
    if(r===ckMust[0]&&c===ckMust[1]){ckSel=[r,c];ckRender();return}
    if(ckSel){
      const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
      const cap=caps.find(x=>x.to[0]===r&&x.to[1]===c);
      if(cap){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
    }
    return;
  }
  if(isMine){ckSel=[r,c];ckRender();return}
  if(!ckSel)return;
  // Try move
  const forceCapture=ckHasCaptures(g.board,g.myColor);
  const caps=ckGetCaptures(g.board,ckSel[0],ckSel[1]);
  const cap=caps.find(x=>x.to[0]===r&&x.to[1]===c);
  if(cap){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
  if(!forceCapture){
    const mvs=ckGetMoves(g.board,ckSel[0],ckSel[1]);
    const mv=mvs.find(x=>x.to[0]===r&&x.to[1]===c);
    if(mv){ws.send(JSON.stringify({type:'checkers_move',gameId:g.id,from:ckSel,to:[r,c]}));ckSel=null;return}
  }
}
function ckResign(){if(!ckGame||!ws)return;if(!confirm(t('resignConfirm')||'–°–¥–∞—Ç—å—Å—è?'))return;ws.send(JSON.stringify({type:'checkers_resign',gameId:ckGame.id}))}

// GAMES PANEL
let selectedGame=null;
function openGames(){
  // Close other panels
  document.querySelectorAll('.panel.show').forEach(p=>p.classList.remove('show'));
  const gp=document.getElementById('gamesP');
  gp.classList.toggle('show');
  if(!gp.classList.contains('show'))return;
  selectedGame=null;
  renderGamesList();
}
function renderGamesList(){
  const gc=document.getElementById('gamesContent');
  gc.innerHTML='<div class="game-card" onclick="selectGame(\'rps\')"><div class="g-icon">üé≤</div><div class="g-info"><div class="g-name">'+t('rps')+'</div><div class="g-desc">'+t('rpsDesc')+'</div></div></div><div class="game-card" onclick="selectGame(\'checkers\')"><div class="g-icon">‚ôü</div><div class="g-info"><div class="g-name">'+t('checkersName')+'</div><div class="g-desc">'+t('checkersDesc')+'</div></div></div>';
}
function selectGame(game){
  selectedGame=game;
  const gc=document.getElementById('gamesContent');
  const onlineFriends=friendsList.filter(f=>f.online);
  let h='<div class="game-card" style="pointer-events:none;opacity:.7"><div class="g-icon">'+(game==='rps'?'üé≤':'‚ôü')+'</div><div class="g-info"><div class="g-name">'+(game==='rps'?t('rps'):t('checkersName'))+'</div><div class="g-desc">'+(game==='rps'?t('rpsDesc'):t('checkersDesc'))+'</div></div></div>';
  h+='<div class="game-pick-title">'+t('pickOpponent')+'</div>';
  if(onlineFriends.length===0){h+='<div style="text-align:center;color:var(--td);font-size:.75rem;padding:12px">'+t('noFriendsOnline')+'</div>'}
  else{onlineFriends.forEach(f=>{h+='<div class="game-friend-row" onclick="startGameWith(\''+f.id+'\')"><span class="av">'+(f.avatar||'üê±')+'</span><span class="nm">'+f.displayName+'</span><div class="dot on" style="width:6px;height:6px;border-radius:50%;background:var(--a)"></div></div>'})}
  h+='<div style="text-align:center;margin-top:8px"><button class="mini-btn" onclick="selectedGame=null;renderGamesList()">‚Üê '+(t('close')||'–ù–∞–∑–∞–¥')+'</button></div>';
  gc.innerHTML=h;
}
function startGameWith(id){
  if(!selectedGame)return;
  document.getElementById('gamesP').classList.remove('show');
  if(selectedGame==='rps'){rpsInv(id)}
  else if(selectedGame==='checkers'){ckInvite(id)}
  selectedGame=null;
}
let sto;function doSearch(){clearTimeout(sto);sto=setTimeout(()=>{const q=document.getElementById('searchI').value.trim();if(q.length<2){document.getElementById('searchR').innerHTML='';return}fetch(API+'/search?q='+encodeURIComponent(q)).then(r=>r.json()).then(d=>{const el=document.getElementById('searchR');el.innerHTML='';(d.users||[]).forEach(u=>{const isFr=friendsList.some(f=>f.id===u.id);const div=document.createElement('div');div.className='p-row';div.innerHTML='<span class="av">'+u.avatar+'</span><span class="name">'+u.displayName+' <span class="lvl-badge">LV'+u.level+'</span> '+(isFr?'<span class="friend-badge">–¥—Ä—É–≥</span>':'')+'</span><div class="p-row-actions"><button class="mini-btn" onclick="event.stopPropagation();document.getElementById(\'pId\').value=\''+u.id+'\';doConn();toggleP(\'sP\')">üí¨</button>'+(isFr?'':'<button class="mini-btn" onclick="event.stopPropagation();addFD(\''+u.id+'\')">‚ûï</button>')+'<button class="mini-btn danger" onclick="event.stopPropagation();blockU(\''+u.id+'\')">üö´</button></div><div class="dot '+(u.online?'on':'off')+'"></div>';el.appendChild(div)})}).catch(()=>{})},300)}
function renderFriends(){const el=document.getElementById('fL2');el.innerHTML='';friendsList.forEach(f=>{const d=document.createElement('div');d.className='p-row';d.innerHTML='<span class="av">'+f.avatar+'</span><span class="name">'+f.displayName+' <span class="lvl-badge">LV'+f.level+'</span></span><span class="st">'+(f.status?'‚Ä¢ '+f.status:'')+'</span><div class="p-row-actions"><button class="mini-btn" onclick="event.stopPropagation();document.getElementById(\'pId\').value=\''+f.id+'\';doConn()">üí¨</button><button class="mini-btn" onclick="event.stopPropagation();rpsInv(\''+f.id+'\')">üé≤</button><button class="mini-btn" onclick="event.stopPropagation();ckInvite(\''+f.id+'\')">‚ôü</button><button class="mini-btn danger" onclick="event.stopPropagation();remFr(\''+f.id+'\')">‚úï</button><button class="mini-btn danger" onclick="event.stopPropagation();blockU(\''+f.id+'\')">üö´</button></div><div class="dot '+(f.online?'on':'off')+'"></div>';el.appendChild(d)});renderGM()}
function addFriend(){const l=document.getElementById('addFI').value.trim();if(!l||!ws)return;ws.send(JSON.stringify({type:'add_friend',login:l}));document.getElementById('addFI').value=''}
function addFD(l){if(ws)ws.send(JSON.stringify({type:'add_friend',login:l}))}
function remFr(l){if(ws)ws.send(JSON.stringify({type:'remove_friend',login:l}))}
function blockU(l){if(!ws||!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å '+l+'?'))return;ws.send(JSON.stringify({type:'block_user',login:l}))}
function unblockU(l){if(ws)ws.send(JSON.stringify({type:'unblock_user',login:l}))}
function renderBlocks(){const el=document.getElementById('blL');el.innerHTML='';blockList.forEach(b=>{const d=document.createElement('div');d.className='p-row';d.innerHTML='<span class="name">'+b.displayName+'</span><button class="mini-btn" onclick="unblockU(\''+b.id+'\')">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>';el.appendChild(d)})}
function rOL(u){const el=document.getElementById('oL');el.innerHTML='';const fIds=friendsList.map(f=>f.id);u.filter(x=>x.id!==myId&&!x.isGuest).forEach(x=>{const d=document.createElement('div');d.className='p-row';const isFr=fIds.includes(x.id);d.innerHTML='<span class="av">'+(x.avatar||'üê±')+'</span><span class="name">'+x.displayName+' <span class="lvl-badge">LV'+(x.level||1)+'</span> '+(isFr?'<span class="friend-badge">–¥—Ä—É–≥</span>':'')+'</span><span class="st">'+(x.status?'‚Ä¢ '+x.status:'')+'</span><div class="dot on"></div>';d.onclick=()=>{showProfile(x.id)};el.appendChild(d)})}
function renderGroups(){const el=document.getElementById('gL');el.innerHTML='';groupsList.forEach(g=>{const d=document.createElement('div');d.className='p-row';d.innerHTML='<span class="av">'+g.avatar+'</span><span class="name">'+g.name+'</span><span class="st">'+g.members.length+' —á–µ–ª.</span>';d.onclick=()=>{ensureChat(g.id,g.name,g.avatar,true);switchChat(g.id);toggleP('gP')};el.appendChild(d)})}
function renderGM(){const el=document.getElementById('grpMemPick');el.innerHTML='';grpSel.clear();friendsList.forEach(f=>{const d=document.createElement('div');d.className='grp-mem';d.textContent=f.avatar+' '+f.displayName;d.onclick=()=>{if(grpSel.has(f.id)){grpSel.delete(f.id);d.classList.remove('sel')}else{grpSel.add(f.id);d.classList.add('sel')}};el.appendChild(d)})}
function createGroup(){const n=document.getElementById('grpName').value.trim();if(!n||grpSel.size<1)return;ws.send(JSON.stringify({type:'create_group',name:n,members:[...grpSel]}));document.getElementById('grpName').value='';document.getElementById('grpC').classList.remove('show')}
function rpsInv(id){if(!ws)return;ws.send(JSON.stringify({type:'rps_invite',target:id}));document.getElementById('rpsBar').classList.add('show');document.getElementById('rpsTitle').textContent='üé≤ –í—ã–±–µ—Ä–∏—Ç–µ!';document.getElementById('rpsBar').dataset.target=id}
function rpsPlay(c){const t=document.getElementById('rpsBar').dataset.target||activeChat;if(!t||!ws)return;ws.send(JSON.stringify({type:'rps_choice',target:t,choice:c}));document.getElementById('rpsTitle').textContent='‚è≥ –ñ–¥—ë–º...';document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='none');setTimeout(()=>{document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='');document.getElementById('rpsBar').classList.remove('show')},15000)}
function setReply(id,text){replyToId=id;replyToText=text;document.getElementById('replyText').textContent=text.substring(0,60);document.getElementById('replyBar').classList.add('show');document.getElementById('mI').focus()}
function cancelReply(){replyToId=null;replyToText=null;document.getElementById('replyBar').classList.remove('show')}
function ensureChat(id,nm,av,isGrp){if(!chats[id])chats[id]={displayName:nm||id,avatar:av||'üë§',messages:[],unread:0,isGroup:!!isGrp};else{if(nm)chats[id].displayName=nm;if(av)chats[id].avatar=av}renderTabs()}
function switchChat(id){activeChat=id;if(chats[id])chats[id].unread=0;renderTabs();renderMsgs()}
function closeTab(id,e){e.stopPropagation();delete chats[id];if(activeChat===id)activeChat=Object.keys(chats)[0]||null;renderTabs();renderMsgs()}
function renderTabs(){const c=document.getElementById('chatTabs');c.innerHTML='';const keys=Object.keys(chats);
document.getElementById('cC').style.display=keys.length>0?'none':'flex';
keys.forEach(id=>{const ch=chats[id];const d=document.createElement('div');d.className='chat-tab'+(activeChat===id?' active':'');let h='<span>'+ch.avatar+' '+ch.displayName+'</span>';if(ch.unread>0)h+='<span class="unread">'+ch.unread+'</span>';h+='<span class="close-tab" onclick="closeTab(\''+id+'\',event)">‚úï</span>';d.innerHTML=h;d.onclick=()=>switchChat(id);c.appendChild(d)})}
function renderMsgs(){const a=document.getElementById('msgArea');a.innerHTML='';if(!activeChat||!chats[activeChat])return;chats[activeChat].messages.forEach(m=>{if(m.poll){renderPoll(a,m);return}const d=document.createElement('div');d.className='m '+m.type;if(m.type==='y')d.textContent=m.text;else{let h='';if(m.type==='r'&&m.from)h+='<div class="mf" onclick="showProfile(\''+(m.fromId||'')+'\')">'+m.from+'</div>';if(m.replyText)h+='<div class="reply-block">‚Ü©Ô∏è '+m.replyText.substring(0,50)+'</div>';h+=m.text;h+='<div class="mm"><span class="mt">'+m.time+'</span>';if(m.type==='s')h+='<span class="ms-icon" id="st-'+m.id+'">‚úì</span>';h+='</div>';const safeText=(m.text||'').replace(/<[^>]*>/g,'').replace(/'/g,"\\'").replace(/"/g,'&quot;');h+='<div class="m-actions"><div class="m-act" onclick="setReply(\''+m.id+'\',\''+safeText+'\')">‚Ü©Ô∏è</div><div class="m-act" onclick="sRx(\''+m.id+'\',this.closest(\'.m\'))">üòä</div></div>';d.innerHTML=h;if(m.id)mE[m.id]=d}a.appendChild(d)});a.scrollTop=a.scrollHeight}
function renderPoll(a,m){const d=document.createElement('div');d.className='poll-box';d.style.alignSelf=m.type==='s'?'flex-end':'flex-start';let h='<div class="poll-q">üìä '+m.poll.question+'</div>';const v=polls[m.poll.pollId]||{};m.poll.options.forEach((opt,i)=>{const cnt=Object.values(v).filter(x=>x===i).length;const voted=v[myId]===i;h+='<div class="poll-opt'+(voted?' voted':'')+'" onclick="votePoll(\''+m.poll.groupId+'\',\''+m.poll.pollId+'\','+i+')">'+opt+' <span>'+cnt+'</span></div>'});d.innerHTML=h;a.appendChild(d)}
function votePoll(g,p,o){if(!ws)return;ws.send(JSON.stringify({type:'poll_vote',groupId:g,pollId:p,option:o}));if(!polls[p])polls[p]={};polls[p][myId]=o;renderMsgs()}
function addToChat(pid,msg){ensureChat(pid);chats[pid].messages.push(msg);if(activeChat===pid)renderMsgs();else{chats[pid].unread++;renderTabs()}}
function ts(){const n=new Date();return String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')}
function initE(){const g=document.getElementById('eP');let h='<div class="eg">';EM.forEach(e=>{h+='<div class="ei" onclick="iE(\''+e+'\')">'+e+'</div>'});h+='</div>';g.innerHTML=h}
function iE(e){document.getElementById('mI').value+=e;document.getElementById('eP').classList.remove('show');document.getElementById('mI').focus()}
function sRx(mid,el){rTgt=mid;const p=document.getElementById('rPk');const r=el.getBoundingClientRect();p.style.top=(r.top-34)+'px';p.style.left=Math.min(r.left,window.innerWidth-190)+'px';p.classList.add('show');setTimeout(()=>document.addEventListener('click',hRx,{once:true}),10)}
function hRx(){document.getElementById('rPk').classList.remove('show')}
function doReact(em){if(!rTgt||!ws||!activeChat)return;ws.send(JSON.stringify({type:'reaction',target:activeChat,msgId:rTgt,emoji:em}));const el=mE[rTgt];if(el){let r=el.querySelector('.mr');if(!r){r=document.createElement('div');r.className='mr';el.appendChild(r)}r.textContent=em}hRx()}
const vAudios={};
function mkVoice(src,id){vAudios[id]=src;let bars='';for(let i=0;i<20;i++){const h=Math.floor(Math.random()*16)+4;bars+='<div class="voice-bar" style="height:'+h+'px"></div>'}return '<div class="voice-msg"><button class="voice-btn" id="vb-'+id+'" onclick="playV(\''+id+'\')">‚ñ∂</button><div class="voice-wave" id="vw-'+id+'">'+bars+'</div><span class="voice-time" id="vt-'+id+'">0:00</span></div>'}
function playV(id){const src=vAudios[id];if(!src)return;const btn=document.getElementById('vb-'+id);const wave=document.getElementById('vw-'+id);const tm=document.getElementById('vt-'+id);if(btn.dataset.playing==='1'){if(btn._audio){btn._audio.pause();btn._audio.currentTime=0}btn.textContent='‚ñ∂';btn.classList.remove('playing');btn.dataset.playing='0';if(wave)wave.querySelectorAll('.voice-bar').forEach(b=>b.classList.remove('active'));return}const a=new Audio(src);btn._audio=a;btn.textContent='‚è∏';btn.classList.add('playing');btn.dataset.playing='1';let vi=0;const bars=wave?wave.querySelectorAll('.voice-bar'):[];const iv=setInterval(()=>{if(a.paused){clearInterval(iv);return}bars.forEach(b=>b.classList.remove('active'));if(bars.length>0){const pos=Math.floor((a.currentTime/Math.max(a.duration,1))*bars.length);for(let i=0;i<=pos&&i<bars.length;i++)bars[i].classList.add('active')}const s=Math.floor(a.currentTime);tm.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0')},100);a.onended=()=>{clearInterval(iv);btn.textContent='‚ñ∂';btn.classList.remove('playing');btn.dataset.playing='0';bars.forEach(b=>b.classList.remove('active'));const dur=Math.floor(a.duration);tm.textContent=Math.floor(dur/60)+':'+String(dur%60).padStart(2,'0')};a.play().catch(()=>{btn.textContent='‚ñ∂';btn.dataset.playing='0'})}
async function srec(){if(!activeChat)return;try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mRec=new MediaRecorder(s);aCh=[];isRec=true;document.getElementById('mic').classList.add('rec');mRec.ondataavailable=e=>aCh.push(e.data);mRec.onstop=()=>{s.getTracks().forEach(t=>t.stop());const b=new Blob(aCh,{type:'audio/webm'});const r=new FileReader();r.onloadend=()=>{const mid=Date.now().toString(36);const vHtml=mkVoice(r.result,mid);addToChat(activeChat,{type:'s',text:vHtml,time:ts(),id:mid,isVoice:true});sS();const ch=chats[activeChat];if(ch&&ch.isGroup){ws.send(JSON.stringify({type:'group_message',groupId:activeChat,text:'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ',msgId:mid}))}else{ws.send(JSON.stringify({type:'voice',target:activeChat,audio:r.result,duration:3,msgId:mid}))}};r.readAsDataURL(b)};mRec.start()}catch(e){}}
function erec(){if(mRec&&isRec){mRec.stop();isRec=false;document.getElementById('mic').classList.remove('rec')}}
function handle(m){switch(m.type){
case'auth_success':myId=m.id;myName=m.displayName;isG=m.isGuest;myAvatar=m.avatar||'üë§';myStatus=m.status||'';myXP=m.xp||0;myLevel=m.level||1;showChat();document.getElementById('stB').textContent=isG?'–ê–ù–û–ù–ò–ú':'–û–ù–õ–ê–ô–ù';sC();if(!isG&&ws){ws.send(JSON.stringify({type:'get_online'}));ws.send(JSON.stringify({type:'get_friends'}));ws.send(JSON.stringify({type:'get_groups'}));ws.send(JSON.stringify({type:'get_blocks'}))}break;
case'auth_error':se(m.text);break;case'kicked':doLogout();break;
case'connected':ensureChat(m.peer,m.displayName,m.avatar);switchChat(m.peer);addToChat(m.peer,{type:'y',text:'–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ¬´'+m.displayName+'¬ª'});sC();break;
case'message':ensureChat(m.from,m.displayName,m.avatar);var mm={type:'r',text:m.text,from:m.displayName||m.from,fromId:m.from,time:ts(),id:m.msgId};if(m.replyText)mm.replyText=m.replyText;addToChat(m.from,mm);sR2();if(ws)ws.send(JSON.stringify({type:'read',target:m.from,msgId:m.msgId}));break;
case'voice':ensureChat(m.from,m.displayName,m.avatar);var vH=mkVoice(m.audio,m.msgId);addToChat(m.from,{type:'r',text:vH,from:m.displayName||m.from,time:ts(),id:m.msgId,isVoice:true});sR2();break;
case'group_message':var grp=groupsList.find(g=>g.id===m.groupId);ensureChat(m.groupId,grp?.name||m.groupId,grp?.avatar||'üë•',true);var gm={type:'r',text:m.text,from:m.displayName||m.from,fromId:m.from,time:ts(),id:m.msgId};if(m.replyText)gm.replyText=m.replyText;addToChat(m.groupId,gm);sR2();break;
case'xp_update':myXP=m.xp;myLevel=m.level;updateXP();break;
case'achievement':showAchToast(m.ids);break;
case'checkers_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'‚ôü '+m.displayName+' '+(t('ckInviteMsg')||'–ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤ —à–∞—à–∫–∏!')+'<br><button class="mini-btn" onclick="ckAccept(\''+m.from+'\')">‚úÖ '+(t('accept')||'–ü—Ä–∏–Ω—è—Ç—å')+'</button>'});sR2();break;
case'checkers_start':ckStartGame(m);break;
case'checkers_update':if(ckGame&&ckGame.id===m.gameId){ckGame.board=m.board;ckGame.turn=m.turn;ckGame.lastMove=m.lastMove;if(m.mustContinue){ckMust=m.continueFrom;ckSel=m.continueFrom}else{ckMust=null;ckSel=null}ckRender()}break;
case'checkers_end':if(ckGame&&ckGame.id===m.gameId){ckGame.board=m.board;ckGame=null;ckSel=null;ckMust=null;const won=m.winnerId===myId;const md=document.getElementById('ckModal');md.innerHTML='<div class="ck-title">‚ôü '+(t('gameOver')||'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê')+'</div><div style="font-size:2rem;margin:16px 0">'+(won?'üèÜ':'üòî')+'</div><div class="ck-status">'+(m.resigned?(t('oppResigned')||'–°–æ–ø–µ—Ä–Ω–∏–∫ —Å–¥–∞–ª—Å—è!'):(won?(t('youWin')||'–í—ã –ø–æ–±–µ–¥–∏–ª–∏!'):(t('youLose')||'–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏')))+'</div>'+(won?'<div style="color:var(--a);font-size:.75rem;margin:6px 0">+15 XP</div>':'')+'<div class="ck-actions"><button onclick="document.getElementById(\'ckBg\').classList.remove(\'show\')">'+(t('close')||'–ó–∞–∫—Ä—ã—Ç—å')+'</button></div>';if(won)sC();else sR2()}break;
case'typing':var el2=document.getElementById('ti');el2.textContent=(m.from||'')+' –ø–µ—á–∞—Ç–∞–µ—Ç...';el2.classList.add('v');clearTimeout(tto);tto=setTimeout(()=>el2.classList.remove('v'),2000);break;
case'delivered':var s2=document.getElementById('st-'+m.msgId);if(s2)s2.textContent='‚úì';break;
case'read':var s3=document.getElementById('st-'+m.msgId);if(s3){s3.textContent='‚úì‚úì';s3.style.color='var(--a)'}break;
case'reaction':var el3=mE[m.msgId];if(el3){var r2=el3.querySelector('.mr');if(!r2){r2=document.createElement('div');r2.className='mr';el3.appendChild(r2)}r2.textContent=m.emoji}break;
case'user_offline':if(chats[m.id])addToChat(m.id,{type:'y',text:'–í—ã—à–µ–ª –∏–∑ —Å–µ—Ç–∏'});if(!isG&&ws)ws.send(JSON.stringify({type:'get_online'}));break;
case'online_list':if(!isG)rOL(m.users);break;
case'user_online':case'user_updated':if(!isG&&ws)ws.send(JSON.stringify({type:'get_online'}));break;
case'friends_list':friendsList=m.friends;renderFriends();break;
case'groups_list':groupsList=m.groups;renderGroups();break;
case'block_list':blockList=m.blocked;renderBlocks();break;
case'user_blocked':if(chats[m.login]){delete chats[m.login];if(activeChat===m.login)activeChat=null;renderTabs();renderMsgs()}break;
case'group_created':addToChat(m.groupId,{type:'y',text:'–ì—Ä—É–ø–ø–∞ ¬´'+m.name+'¬ª —Å–æ–∑–¥–∞–Ω–∞!'});break;
case'friend_added_you':ensureChat(m.from);addToChat(m.from,{type:'y',text:m.displayName+' –¥–æ–±–∞–≤–∏–ª(–∞) –≤–∞—Å –≤ –¥—Ä—É–∑—å—è!'});if(ws)ws.send(JSON.stringify({type:'get_friends'}));break;
case'rps_invite':ensureChat(m.from,m.displayName);addToChat(m.from,{type:'y',text:'üé≤ '+m.displayName+' –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤ –ö–ù–ë!'});document.getElementById('rpsBar').classList.add('show');document.getElementById('rpsTitle').textContent='üé≤ '+m.displayName+' –≤—ã–∑–≤–∞–ª –≤–∞—Å!';document.getElementById('rpsBar').dataset.target=m.from;sR2();break;
case'rps_waiting':if(activeChat)addToChat(activeChat,{type:'y',text:'‚è≥ –ñ–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...'});break;
case'rps_result':var ic={rock:'ü™®',paper:'üìÑ',scissors:'‚úÇÔ∏è'};var rm={win:'üèÜ –ü–æ–±–µ–¥–∞!',lose:'üò¢ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ',draw:'ü§ù –ù–∏—á—å—è'};ensureChat(m.opponent,m.opponentName);addToChat(m.opponent,{type:'y',text:ic[m.myChoice]+' vs '+ic[m.opChoice]+' ‚Äî '+rm[m.result]});document.getElementById('rpsBar').classList.remove('show');document.querySelectorAll('.rps-choice').forEach(x=>x.style.pointerEvents='');if(m.result==='win')sC();else sR2();break;
case'poll':var pg=groupsList.find(g=>g.id===m.groupId);ensureChat(m.groupId,pg?.name||m.groupId,pg?.avatar||'üë•',true);polls[m.pollId]={};addToChat(m.groupId,{type:'r',poll:{pollId:m.pollId,question:m.question,options:m.options,groupId:m.groupId},time:ts()});sR2();break;
case'poll_vote':if(!polls[m.pollId])polls[m.pollId]={};polls[m.pollId][m.voter]=m.option;if(activeChat===m.groupId)renderMsgs();break;
case'error':if(activeChat)addToChat(activeChat,{type:'y',text:m.text});break;
}}
function doConn(){const t=document.getElementById('pId').value.trim();if(!t||!ws)return;ws.send(JSON.stringify({type:'connect',target:t}));document.getElementById('pId').value=''}
function snd(){const i=document.getElementById('mI');const t=i.value.trim();if(!t||!ws||!activeChat)return;const mid=Date.now().toString(36)+Math.random().toString(36).substr(2,3);const ch=chats[activeChat];const p={type:ch?.isGroup?'group_message':'message',target:activeChat,text:t,msgId:mid};if(ch?.isGroup)p.groupId=activeChat;if(replyToId){p.replyTo=replyToId;p.replyText=replyToText}ws.send(JSON.stringify(p));const mo={type:'s',text:t,time:ts(),id:mid};if(replyToId)mo.replyText=replyToText;addToChat(activeChat,mo);sS();i.value='';cancelReply();document.getElementById('eP').classList.remove('show')}
let lT=0;function hk(e){if(e.key==='Enter'){snd();return}if(activeChat&&ws&&Date.now()-lT>1000){ws.send(JSON.stringify({type:'typing',target:activeChat}));lT=Date.now()}}
window.addEventListener('load',()=>{
if(window.Telegram&&Telegram.WebApp){const tg=Telegram.WebApp;tg.expand();tg.setHeaderColor('#0a0a0f');tg.setBackgroundColor('#0a0a0f');try{tg.requestFullscreen()}catch(e){}function sa(){const s=tg.safeAreaInset||{},c=tg.contentSafeAreaInset||{};const top=38+Math.max(s.top||0,c.top||0);document.querySelector('.app').style.paddingTop=top+'px';const sm=document.getElementById('sideMenu');if(sm)sm.style.paddingTop=top+'px'}sa();tg.onEvent('safeAreaChanged',sa);tg.onEvent('contentSafeAreaChanged',sa);tg.onEvent('fullscreenChanged',sa)}
setTimeout(()=>document.getElementById('splash').classList.add('hidden'),1800);initE();initAP();applyLang();
const s=localStorage.getItem('kc');if(s){const c=JSON.parse(s);document.getElementById('savedInfo').style.display='';document.getElementById('savedU').textContent=c.l}
document.addEventListener('click',e=>{if(!e.target.closest('.ep')&&!e.target.closest('.ib'))document.getElementById('eP').classList.remove('show')})});
</script></body></html>

</script>
</body>
</html>