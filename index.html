<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>K√ñRP√ú ‚Äî Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .splash{position:fixed;inset:0;z-index:999;background:#0c1a2e;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s,visibility .6s}
    .splash.hidden{opacity:0;visibility:hidden;pointer-events:none}
    .splash img{width:180px;height:180px;object-fit:contain;animation:sp 1.5s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(0,229,160,.3))}
    .splash-text{margin-top:20px;font-family:'Space Mono',monospace;font-size:.7rem;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.3)}
    @keyframes sp{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0f;--glass:rgba(255,255,255,.06);--glass-b:rgba(255,255,255,.08);--accent:#00e5a0;--accent-g:rgba(0,229,160,.3);--accent-d:rgba(0,229,160,.1);--danger:#ff4d6a;--text:#e8e8ec;--text-d:rgba(255,255,255,.4);--text-m:rgba(255,255,255,.65);--sent-bg:linear-gradient(135deg,rgba(0,229,160,.2),rgba(0,229,160,.08));--sent-b:rgba(0,229,160,.15);--recv-bg:rgba(255,255,255,.06);--recv-b:rgba(255,255,255,.06);--card-bg:rgba(255,255,255,.06)}
    html.light{--bg:#f0f2f5;--glass:rgba(0,0,0,.04);--glass-b:rgba(0,0,0,.08);--accent:#00b386;--accent-g:rgba(0,179,134,.2);--accent-d:rgba(0,179,134,.08);--text:#1a1a2e;--text-d:rgba(0,0,0,.4);--text-m:rgba(0,0,0,.55);--sent-bg:linear-gradient(135deg,rgba(0,179,134,.15),rgba(0,179,134,.06));--sent-b:rgba(0,179,134,.2);--recv-bg:rgba(0,0,0,.04);--recv-b:rgba(0,0,0,.06);--card-bg:rgba(255,255,255,.7)}
    html{font-size:16px}
    body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden;position:relative;transition:background .3s,color .3s}
    body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 50%,rgba(0,229,160,.06) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(100,60,255,.05) 0%,transparent 50%);animation:bgA 20s ease-in-out infinite alternate;z-index:0}
    @keyframes bgA{0%{transform:translate(0,0)}100%{transform:translate(-5%,3%)}}
    body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.015) 1px,transparent 1px);background-size:60px 60px;z-index:0}

    .app{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;max-width:520px;margin:0 auto;padding:12px}

    /* AUTH SCREEN */
    .auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;animation:fu .5s ease}
    @keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .auth-logo{width:100px;height:100px;object-fit:contain;margin-bottom:12px;filter:drop-shadow(0 0 20px var(--accent-g))}
    .auth-title{font-family:'Space Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--accent);letter-spacing:3px;margin-bottom:4px}
    .auth-sub{font-size:.8rem;color:var(--text-d);margin-bottom:24px}
    .auth-card{width:100%;max-width:360px;background:var(--card-bg);border:1px solid var(--glass-b);border-radius:16px;padding:24px;backdrop-filter:blur(20px)}
    .auth-tabs{display:flex;gap:0;margin-bottom:20px;background:var(--glass);border-radius:10px;padding:3px}
    .auth-tab{flex:1;padding:10px;text-align:center;font-size:.82rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all .25s;color:var(--text-m)}
    .auth-tab.active{background:var(--accent);color:#0a0a0f;box-shadow:0 2px 10px var(--accent-g)}
    .auth-field{margin-bottom:12px}
    .auth-field label{display:block;font-size:.65rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-d);margin-bottom:5px;font-family:'Space Mono',monospace}
    .auth-field input{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.88rem;outline:none;transition:all .3s}
    html.light .auth-field input{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}
    .auth-field input:focus{border-color:rgba(0,229,160,.4);box-shadow:0 0 0 3px rgba(0,229,160,.08)}
    .auth-field input::placeholder{color:var(--text-d)}
    .auth-btn{width:100%;padding:13px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .25s;margin-top:6px}
    .auth-btn-primary{background:var(--accent);color:#0a0a0f;box-shadow:0 4px 20px var(--accent-g)}
    .auth-btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 25px rgba(0,229,160,.4)}
    .auth-divider{display:flex;align-items:center;gap:12px;margin:18px 0;color:var(--text-d);font-size:.72rem}
    .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--glass-b)}
    .auth-btn-ghost{background:var(--glass);color:var(--text-m);border:1px solid var(--glass-b)}
    .auth-btn-ghost:hover{background:rgba(255,255,255,.1);color:var(--text)}
    .auth-error{color:var(--danger);font-size:.78rem;text-align:center;margin-top:10px;min-height:20px}
    .auth-saved{font-size:.7rem;color:var(--text-d);text-align:center;margin-top:10px}
    .auth-saved a{color:var(--accent);cursor:pointer;text-decoration:underline}
    .guest-badge{display:inline-block;font-size:.55rem;padding:2px 6px;border-radius:4px;background:rgba(255,166,0,.15);color:#ffa600;font-family:'Space Mono',monospace;letter-spacing:.5px;margin-left:4px}

    /* CHAT SCREEN */
    .chat-screen{display:none;flex-direction:column;flex:1;min-height:0}
    .chat-screen.active{display:flex}
    .header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;margin-bottom:6px}
    .logo{font-family:'Space Mono',monospace;font-size:1rem;font-weight:700;letter-spacing:2px;color:var(--accent);text-shadow:0 0 20px var(--accent-g)}
    .header-right{display:flex;align-items:center;gap:5px}
    .badge{font-size:.6rem;padding:3px 8px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--glass-b);color:var(--text-d);font-family:'Space Mono',monospace;letter-spacing:1px;transition:all .5s;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .badge.online{background:var(--accent-d);border-color:rgba(0,229,160,.3);color:var(--accent);box-shadow:0 0 12px var(--accent-g)}
    .badge.connected{background:rgba(100,60,255,.1);border-color:rgba(100,60,255,.3);color:#a78bfa}
    .ib{width:30px;height:30px;border-radius:8px;border:1px solid var(--glass-b);background:var(--glass);color:var(--text-m);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:.75rem}
    .ib:hover{background:rgba(255,255,255,.1);color:var(--text)}
    .ib.active{background:var(--accent-d);border-color:rgba(0,229,160,.3);color:var(--accent)}

    .card{background:var(--card-bg);border:1px solid var(--glass-b);border-radius:14px;padding:14px;backdrop-filter:blur(20px);margin-bottom:8px;animation:fu .4s ease both}
    .card-label{font-size:.6rem;text-transform:uppercase;letter-spacing:2px;color:var(--text-d);margin-bottom:8px;font-family:'Space Mono',monospace}
    .input-row{display:flex;gap:6px}
    input[type="text"]{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'Outfit',sans-serif;font-size:.86rem;outline:none;transition:all .3s}
    html.light input[type="text"]{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}
    input:focus{border-color:rgba(0,229,160,.4)!important;box-shadow:0 0 0 3px rgba(0,229,160,.08)}
    input::placeholder{color:var(--text-d)}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap;display:inline-flex;align-items:center;gap:5px}
    .btn-p{background:var(--accent);color:#0a0a0f;box-shadow:0 3px 12px var(--accent-g)}
    .btn-g{background:var(--glass);color:var(--text-m);border:1px solid var(--glass-b)}

    .online-panel{display:none;max-height:110px;overflow-y:auto;margin-bottom:6px;background:var(--card-bg);border:1px solid var(--glass-b);border-radius:12px;padding:8px;backdrop-filter:blur(20px);animation:fu .3s ease}
    .online-panel.show{display:block}
    .online-user{display:flex;align-items:center;gap:8px;padding:5px;border-radius:8px;cursor:pointer;transition:background .2s;font-size:.8rem}
    .online-user:hover{background:rgba(255,255,255,.06)}
    .av-sm{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:#0a0a0f;flex-shrink:0}
    .online-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);margin-left:auto;flex-shrink:0}

    .messages-area{flex:1;min-height:0;display:flex;flex-direction:column}
    #messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:4px;background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;backdrop-filter:blur(10px);scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
    #messages::-webkit-scrollbar{width:3px}#messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}

    .msg{max-width:82%;padding:9px 12px;border-radius:14px;font-size:.84rem;line-height:1.4;animation:mi .3s ease both;word-break:break-word;position:relative}
    @keyframes mi{from{opacity:0;transform:translateY(5px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
    .msg.sent{align-self:flex-end;background:var(--sent-bg);border:1px solid var(--sent-b)}
    .msg.received{align-self:flex-start;background:var(--recv-bg);border:1px solid var(--recv-b)}
    .msg.system{align-self:center;background:none;border:none;color:var(--text-d);font-size:.66rem;font-family:'Space Mono',monospace;letter-spacing:.5px;padding:4px 0}
    .msg-from{font-size:.62rem;color:var(--accent);font-weight:600;margin-bottom:2px}
    .msg-meta{display:flex;align-items:center;gap:5px;margin-top:2px}
    .msg-time{font-size:.56rem;color:var(--text-d);font-family:'Space Mono',monospace}
    .msg-status{font-size:.62rem}
    .msg-reaction{position:absolute;bottom:-8px;right:8px;background:var(--bg);border:1px solid var(--glass-b);border-radius:10px;padding:1px 5px;font-size:.68rem;cursor:pointer}
    .msg:hover .react-btn{opacity:1}
    .react-btn{position:absolute;top:-8px;right:-8px;opacity:0;background:var(--bg);border:1px solid var(--glass-b);border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.6rem;transition:opacity .2s}

    .voice-msg{display:flex;align-items:center;gap:8px;min-width:150px}
    .voice-play{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#0a0a0f;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
    .voice-wave{flex:1;height:22px;display:flex;align-items:center;gap:1px}
    .voice-wave span{display:block;width:3px;border-radius:2px;background:var(--accent);opacity:.5}
    .voice-dur{font-size:.62rem;color:var(--text-d);font-family:'Space Mono',monospace;flex-shrink:0}

    #typingInd{font-size:.62rem;color:var(--accent);font-family:'Space Mono',monospace;height:14px;padding:1px 0;opacity:0;transition:opacity .3s}
    #typingInd.visible{opacity:1}
    .input-bar{display:flex;gap:5px;margin-top:6px;align-items:center}
    .btn-send{width:38px;height:38px;padding:0;border-radius:50%;background:var(--accent);color:#0a0a0f;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .25s;box-shadow:0 3px 10px var(--accent-g)}
    .btn-send:hover{transform:scale(1.05)}
    .btn-mic{width:38px;height:38px;padding:0;border-radius:50%;background:var(--glass);border:1px solid var(--glass-b);color:var(--text-m);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .25s}
    .btn-mic.recording{background:var(--danger);color:white;border-color:var(--danger);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,77,106,.4)}50%{box-shadow:0 0 0 8px rgba(255,77,106,0)}}

    .emoji-panel{display:none;position:absolute;bottom:55px;left:8px;right:8px;background:var(--bg);border:1px solid var(--glass-b);border-radius:12px;padding:8px;z-index:50;backdrop-filter:blur(20px);max-height:180px;overflow-y:auto;animation:fu .2s ease}
    .emoji-panel.show{display:block}
    .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px}
    .emoji-item{font-size:1.3rem;text-align:center;padding:4px;border-radius:8px;cursor:pointer;transition:background .15s}
    .emoji-item:hover{background:rgba(255,255,255,.1)}

    .reaction-picker{display:none;position:fixed;background:var(--bg);border:1px solid var(--glass-b);border-radius:20px;padding:4px 6px;z-index:60;white-space:nowrap}
    .reaction-picker.show{display:flex;gap:2px;animation:fu .15s ease}
    .reaction-picker span{font-size:1rem;cursor:pointer;padding:2px 3px;border-radius:8px;transition:background .15s}
    .reaction-picker span:hover{background:rgba(255,255,255,.1)}

    .lang-select{font-size:.65rem;background:var(--glass);border:1px solid var(--glass-b);color:var(--text-m);border-radius:6px;padding:2px 3px;font-family:'Space Mono',monospace;cursor:pointer;outline:none}
    html.light .lang-select{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}

    svg{display:block}
    @media(max-width:540px){.app{padding:8px}.auth-card{padding:18px}}
  </style>
</head>
<body>

<div class="splash" id="splash"><img src="logo.png" alt="K√ñRP√ú"><div class="splash-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

<div class="app">

  <!-- ===== AUTH SCREEN ===== -->
  <div class="auth-screen" id="authScreen">
    <img src="logo.png" class="auth-logo" alt="K√ñRP√ú">
    <div class="auth-title">K√ñRP√ú</div>
    <div class="auth-sub" id="authSub">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>

    <div class="auth-card">
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabLogin" onclick="switchTab('login')">–í–æ–π—Ç–∏</div>
        <div class="auth-tab" id="tabRegister" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
      </div>

      <!-- Login form -->
      <div id="formLogin">
        <div class="auth-field">
          <label>–õ–æ–≥–∏–Ω</label>
          <input type="text" id="loginUser" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω...">
        </div>
        <div class="auth-field">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="loginPass" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å...">
        </div>
        <button class="auth-btn auth-btn-primary" onclick="doLogin()">–í–æ–π—Ç–∏</button>
      </div>

      <!-- Register form -->
      <div id="formRegister" style="display:none">
        <div class="auth-field">
          <label>–ò–º—è</label>
          <input type="text" id="regName" placeholder="–í–∞—à–µ –∏–º—è...">
        </div>
        <div class="auth-field">
          <label>–õ–æ–≥–∏–Ω</label>
          <input type="text" id="regUser" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω...">
        </div>
        <div class="auth-field">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="regPass" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞...">
        </div>
        <button class="auth-btn auth-btn-primary" onclick="doRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>

      <div class="auth-error" id="authError"></div>

      <div class="auth-divider">–∏–ª–∏</div>

      <button class="auth-btn auth-btn-ghost" onclick="doGuest()">‚ö° –ë—ã—Å—Ç—Ä—ã–π –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —á–∞—Ç</button>

      <div class="auth-saved" id="savedLogin" style="display:none">
        –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: <a id="savedUser" onclick="quickLogin()"></a>
      </div>
    </div>
  </div>

  <!-- ===== CHAT SCREEN ===== -->
  <div class="chat-screen" id="chatScreen">
    <div class="header">
      <div class="logo">K√ñRP√ú</div>
      <div class="header-right">
        <select class="lang-select" id="langSelect" onchange="setLang(this.value)">
          <option value="az">AZ</option><option value="ru" selected>RU</option><option value="en">EN</option>
        </select>
        <div class="ib" onclick="toggleTheme()" title="–¢–µ–º–∞">
          <svg id="themeIcon" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </div>
        <div class="ib" id="onlineBtn" onclick="toggleOnline()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        </div>
        <div class="ib" onclick="logout()" title="–í—ã–π—Ç–∏">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </div>
        <div class="badge" id="statusBadge">–û–§–õ–ê–ô–ù</div>
      </div>
    </div>

    <div class="online-panel" id="onlinePanel">
      <div class="card-label">–û–ù–õ–ê–ô–ù</div>
      <div id="onlineList"></div>
    </div>

    <div class="card" id="connectCard">
      <div class="card-label">–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–û–ë–ï–°–ï–î–ù–ò–ö–£</div>
      <div class="input-row">
        <input type="text" id="peerId" placeholder="ID –∏–ª–∏ –ª–æ–≥–∏–Ω...">
        <button class="btn btn-g" onclick="connectToPeer()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>
    </div>

    <div class="messages-area">
      <div id="messages"></div>
      <div id="typingInd"></div>
    </div>

    <div class="input-bar" style="position:relative">
      <div class="ib" onclick="toggleEmoji()">üòä</div>
      <div class="btn-mic" id="micBtn" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
      </div>
      <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="handleKey(event)">
      <button class="btn-send" onclick="sendMsg()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
      <div class="emoji-panel" id="emojiPanel"></div>
    </div>
  </div>
</div>

<div class="reaction-picker" id="reactionPicker">
  <span onclick="react('üëç')">üëç</span><span onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="react('üòÇ')">üòÇ</span><span onclick="react('üòÆ')">üòÆ</span><span onclick="react('üò¢')">üò¢</span><span onclick="react('üî•')">üî•</span>
</div>

<script>
const WS_URL='wss://korpu-server.onrender.com';
const EMOJIS=['üòÄ','üòÇ','ü§£','üòä','üòç','ü•∞','üòò','üòé','ü§©','ü•≥','üòè','üò¢','üò≠','üò§','ü§Ø','ü§î','ü§´','ü§ó','üò¥','ü§Æ','üëç','üëé','üëã','üôè','üí™','‚ù§Ô∏è','üî•','‚≠ê','üéâ','üíØ','‚úÖ','‚ùå','ü´°','ü´∂','üíÄ','üëÄ','üéµ','‚òï','üçï','üöÄ'];
const COLORS=['#00e5a0','#a78bfa','#f472b6','#fb923c','#38bdf8','#facc15','#4ade80','#f87171','#c084fc','#2dd4bf'];

let ws=null,myId=null,myName=null,peerId=null,peerName=null,isGuest=false,connected=false,typTimeout=null,mediaRec=null,audioChunks=[],isRecording=false,isDark=true,reactionTarget=null,curLang='ru';
const msgEls={};

// ===== I18N =====
const L={
  az:{login:'Daxil ol',register:'Qeydiyyat',name:'Ad',loginLabel:'Login',password:'≈ûifr…ô',enterLogin:'Login daxil edin...',enterPass:'≈ûifr…ô daxil edin...',yourName:'Adƒ±nƒ±z...',createLogin:'Login yaradƒ±n...',minPass:'Minimum 4 simvol...',registerBtn:'Qeydiyyatdan ke√ß',guestBtn:'‚ö° Tez bir d…ôf…ôlik s√∂hb…ôt',or:'v…ô ya',messenger:'T…ôhl√ºk…ôsiz mesencer',connectTo:'H∆èMS√ñHB∆èTƒ∞N ƒ∞D',peerPh:'ID v…ô ya login...',connectBtn:'Qo≈üul',msgPh:'Mesaj...',logout:'√áƒ±xƒ±≈ü'},
  ru:{login:'–í–æ–π—Ç–∏',register:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',name:'–ò–º—è',loginLabel:'–õ–æ–≥–∏–Ω',password:'–ü–∞—Ä–æ–ª—å',enterLogin:'–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω...',enterPass:'–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å...',yourName:'–í–∞—à–µ –∏–º—è...',createLogin:'–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω...',minPass:'–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞...',registerBtn:'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',guestBtn:'‚ö° –ë—ã—Å—Ç—Ä—ã–π –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —á–∞—Ç',or:'–∏–ª–∏',messenger:'–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä',connectTo:'–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–û–ë–ï–°–ï–î–ù–ò–ö–£',peerPh:'ID –∏–ª–∏ –ª–æ–≥–∏–Ω...',connectBtn:'–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',msgPh:'–°–æ–æ–±—â–µ–Ω–∏–µ...',logout:'–í—ã–π—Ç–∏'},
  en:{login:'Login',register:'Register',name:'Name',loginLabel:'Login',password:'Password',enterLogin:'Enter login...',enterPass:'Enter password...',yourName:'Your name...',createLogin:'Create login...',minPass:'At least 4 characters...',registerBtn:'Register',guestBtn:'‚ö° Quick temporary chat',or:'or',messenger:'Secure messenger',connectTo:'CONNECT TO PEER',peerPh:'ID or login...',connectBtn:'Connect',msgPh:'Message...',logout:'Logout'}
};
function t(k){return L[curLang]?.[k]||k}
function setLang(l){curLang=l}

// ===== SOUND =====
const actx=new(window.AudioContext||window.webkitAudioContext)();
function beep(f,d){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(.12,actx.currentTime);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+d);o.start();o.stop(actx.currentTime+d)}
function sndSend(){beep(880,.1)}function sndRecv(){beep(660,.12);setTimeout(()=>beep(880,.1),100)}function sndConnect(){beep(523,.1);setTimeout(()=>beep(659,.1),120);setTimeout(()=>beep(784,.15),240)}

// ===== THEME =====
function toggleTheme(){isDark=!isDark;document.documentElement.classList.toggle('light',!isDark)}

// ===== AUTH =====
function switchTab(tab){
  document.getElementById('tabLogin').classList.toggle('active',tab==='login');
  document.getElementById('tabRegister').classList.toggle('active',tab==='register');
  document.getElementById('formLogin').style.display=tab==='login'?'':'none';
  document.getElementById('formRegister').style.display=tab==='register'?'':'none';
  document.getElementById('authError').textContent='';
}

function connectWS(onOpen){
  ws=new WebSocket(WS_URL);
  ws.onopen=onOpen;
  ws.onmessage=e=>{try{handle(JSON.parse(e.data))}catch(err){console.error(err)}};
  ws.onclose=()=>{if(myId){addMsg('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...','system');setTimeout(()=>reconnect(),3000)}};
  ws.onerror=()=>{document.getElementById('authError').textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º'};
}

function reconnect(){
  connectWS(()=>{
    if(isGuest){ws.send(JSON.stringify({type:'guest_login',displayName:myName}))}
    else{const saved=localStorage.getItem('korpu_creds');if(saved){const c=JSON.parse(saved);ws.send(JSON.stringify({type:'auth_login',login:c.login,password:c.password}))}}
  });
}

function doLogin(){
  const login=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!login||!pass){document.getElementById('authError').textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';return}
  connectWS(()=>{ws.send(JSON.stringify({type:'auth_login',login,password:pass}));localStorage.setItem('korpu_creds',JSON.stringify({login,password:pass}))});
}

function doRegister(){
  const name=document.getElementById('regName').value.trim();
  const login=document.getElementById('regUser').value.trim();
  const pass=document.getElementById('regPass').value;
  if(!login||!pass){document.getElementById('authError').textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';return}
  connectWS(()=>{ws.send(JSON.stringify({type:'auth_register',login,password:pass,displayName:name||login}));localStorage.setItem('korpu_creds',JSON.stringify({login,password:pass}))});
}

function doGuest(){
  connectWS(()=>{ws.send(JSON.stringify({type:'guest_login',displayName:'–ì–æ—Å—Ç—å'}))});
}

function quickLogin(){
  const saved=JSON.parse(localStorage.getItem('korpu_creds'));
  if(saved){document.getElementById('loginUser').value=saved.login;doLogin()}
}

function logout(){
  if(ws)ws.close();
  myId=null;myName=null;peerId=null;connected=false;isGuest=false;
  document.getElementById('authScreen').style.display='flex';
  document.getElementById('chatScreen').classList.remove('active');
  document.getElementById('messages').innerHTML='';
}

function showChat(){
  document.getElementById('authScreen').style.display='none';
  document.getElementById('chatScreen').classList.add('active');
}

// ===== ONLINE =====
function toggleOnline(){document.getElementById('onlinePanel').classList.toggle('show');document.getElementById('onlineBtn').classList.toggle('active')}
function renderOnline(users){
  const el=document.getElementById('onlineList');el.innerHTML='';
  users.filter(u=>u.id!==myId).forEach(u=>{
    const d=document.createElement('div');d.className='online-user';
    const c=COLORS[Math.abs(hc(u.id))%COLORS.length];
    const name=u.displayName||u.id;
    const guestTag=u.isGuest?'<span class="guest-badge">GUEST</span>':'';
    d.innerHTML=`<div class="av-sm" style="background:${c}">${name.charAt(0).toUpperCase()}</div><span>${name}${guestTag}</span><div class="online-dot"></div>`;
    d.onclick=()=>{document.getElementById('peerId').value=u.id;document.getElementById('onlinePanel').classList.remove('show')};
    el.appendChild(d);
  });
}
function hc(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i);return h}

// ===== EMOJI =====
function initEmoji(){const g=document.getElementById('emojiPanel');let html='<div class="emoji-grid">';EMOJIS.forEach(e=>{html+=`<div class="emoji-item" onclick="insertEmoji('${e}')">${e}</div>`});html+='</div>';g.innerHTML=html}
function toggleEmoji(){document.getElementById('emojiPanel').classList.toggle('show')}
function insertEmoji(e){document.getElementById('msgInput').value+=e;document.getElementById('emojiPanel').classList.remove('show');document.getElementById('msgInput').focus()}

// ===== REACTIONS =====
function showReactions(mid,el){reactionTarget=mid;const p=document.getElementById('reactionPicker');const r=el.getBoundingClientRect();p.style.top=(r.top-36)+'px';p.style.left=Math.min(r.left,window.innerWidth-200)+'px';p.classList.add('show');setTimeout(()=>document.addEventListener('click',hideR,{once:true}),10)}
function hideR(){document.getElementById('reactionPicker').classList.remove('show')}
function react(emoji){if(!reactionTarget||!ws||!peerId)return;ws.send(JSON.stringify({type:'reaction',target:peerId,msgId:reactionTarget,emoji}));const el=msgEls[reactionTarget];if(el){let r=el.querySelector('.msg-reaction');if(!r){r=document.createElement('div');r.className='msg-reaction';el.appendChild(r)}r.textContent=emoji}hideR()}

// ===== MESSAGES =====
function setStatus(t,c){const b=document.getElementById('statusBadge');b.textContent=t;b.className='badge '+(c||'')}
function addMsg(text,type,msgId,fromName){
  const el=document.getElementById('messages');const d=document.createElement('div');d.className='msg '+type;
  if(type==='system'){d.textContent=text}
  else{
    const now=new Date();const tm=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    const id=msgId||Date.now().toString(36);d.dataset.msgId=id;
    let html='';
    if(type==='received'&&fromName)html+=`<div class="msg-from">${fromName}</div>`;
    html+=text;
    html+=`<div class="msg-meta"><span class="msg-time">${tm}</span>`;
    if(type==='sent')html+=`<span class="msg-status" id="st-${id}">‚úì</span>`;
    html+='</div>';
    html+=`<div class="react-btn" onclick="showReactions('${id}',this.parentElement)">üòä</div>`;
    d.innerHTML=html;msgEls[id]=d;
    if(type==='received'&&peerId&&ws)ws.send(JSON.stringify({type:'read',target:peerId,msgId:id}));
  }
  el.appendChild(d);el.scrollTop=el.scrollHeight;return d;
}
function addVoice(audioData,duration,type,msgId){
  const el=document.getElementById('messages');const d=document.createElement('div');d.className='msg '+type;
  const id=msgId||Date.now().toString(36);d.dataset.msgId=id;
  const bars=Array.from({length:18},()=>Math.floor(Math.random()*16+4));
  const now=new Date();const tm=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const dur=Math.round(duration||0);
  d.innerHTML=`<div class="voice-msg"><button class="voice-play" onclick="playV(this,'${id}')"><svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg></button><div class="voice-wave">${bars.map(h=>`<span style="height:${h}px"></span>`).join('')}</div><div class="voice-dur">0:${String(dur).padStart(2,'0')}</div></div><div class="msg-meta"><span class="msg-time">${tm}</span>${type==='sent'?`<span class="msg-status" id="st-${id}">‚úì</span>`:''}</div>`;
  d.dataset.audio=audioData;msgEls[id]=d;
  if(type==='received'&&peerId&&ws)ws.send(JSON.stringify({type:'read',target:peerId,msgId:id}));
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}
function playV(btn,id){const m=msgEls[id];if(!m)return;const a=new Audio(m.dataset.audio);a.play();btn.innerHTML='‚è∏';a.onended=()=>{btn.innerHTML='<svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>'}}

// ===== VOICE =====
async function startRec(){
  if(!peerId)return;
  try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRec=new MediaRecorder(s);audioChunks=[];isRecording=true;document.getElementById('micBtn').classList.add('recording');
  mediaRec.ondataavailable=e=>audioChunks.push(e.data);
  mediaRec.onstop=()=>{s.getTracks().forEach(t=>t.stop());const b=new Blob(audioChunks,{type:'audio/webm'});const r=new FileReader();r.onloadend=()=>{const mid=Date.now().toString(36);addVoice(r.result,3,'sent',mid);sndSend();if(ws&&peerId)ws.send(JSON.stringify({type:'voice',target:peerId,audio:r.result,duration:3,msgId:mid}))};r.readAsDataURL(b)};
  mediaRec.start()}catch(e){}
}
function stopRec(){if(mediaRec&&isRecording){mediaRec.stop();isRecording=false;document.getElementById('micBtn').classList.remove('recording')}}

// ===== WS HANDLER =====
function handle(msg){
  switch(msg.type){
    case'auth_success':
      myId=msg.id;myName=msg.displayName;isGuest=msg.isGuest;
      showChat();setStatus((isGuest?'–ì–û–°–¢–¨: ':'–û–ù–õ–ê–ô–ù: ')+myName,'online');
      addMsg('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+(myName||myId)+(isGuest?' (–≥–æ—Å—Ç—å)':'')+'!','system');
      sndConnect();ws.send(JSON.stringify({type:'get_online'}));break;
    case'auth_error':
      document.getElementById('authError').textContent=msg.text;break;
    case'kicked':
      addMsg('–í—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞','system');logout();break;
    case'connected':
      peerId=msg.peer;peerName=msg.displayName||msg.peer;connected=true;
      setStatus('–°–í–Ø–ó–¨: '+peerName,'connected');
      addMsg('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ¬´'+peerName+'¬ª','system');sndConnect();break;
    case'message':
      addMsg(msg.text,'received',msg.msgId,msg.from);sndRecv();break;
    case'voice':
      addVoice(msg.audio,msg.duration,'received',msg.msgId);sndRecv();break;
    case'typing':
      {const el=document.getElementById('typingInd');el.textContent=msg.from+' –ø–µ—á–∞—Ç–∞–µ—Ç...';el.classList.add('visible');clearTimeout(typTimeout);typTimeout=setTimeout(()=>el.classList.remove('visible'),2000)}break;
    case'delivered':
      {const s=document.getElementById('st-'+msg.msgId);if(s)s.textContent='‚úì'}break;
    case'read':
      {const s=document.getElementById('st-'+msg.msgId);if(s){s.textContent='‚úì‚úì';s.style.color='var(--accent)'}}break;
    case'reaction':
      {const el=msgEls[msg.msgId];if(el){let r=el.querySelector('.msg-reaction');if(!r){r=document.createElement('div');r.className='msg-reaction';el.appendChild(r)}r.textContent=msg.emoji}}break;
    case'user_offline':
      if(msg.id===peerId){addMsg('¬´'+(peerName||peerId)+'¬ª –≤—ã—à–µ–ª –∏–∑ —Å–µ—Ç–∏','system');connected=false;peerId=null;peerName=null;setStatus('–û–ù–õ–ê–ô–ù: '+myName,'online')}
      ws.send(JSON.stringify({type:'get_online'}));break;
    case'online_list':renderOnline(msg.users);break;
    case'user_online':case'user_updated':ws.send(JSON.stringify({type:'get_online'}));break;
    case'error':addMsg(msg.text,'system');break;
  }
}

function connectToPeer(){const tid=document.getElementById('peerId').value.trim();if(!tid||!ws)return;ws.send(JSON.stringify({type:'connect',target:tid}))}
function sendMsg(){const i=document.getElementById('msgInput');const t=i.value.trim();if(!t||!ws||!peerId)return;const mid=Date.now().toString(36)+Math.random().toString(36).substr(2,3);ws.send(JSON.stringify({type:'message',target:peerId,text:t,msgId:mid}));addMsg(t,'sent',mid);sndSend();i.value='';document.getElementById('emojiPanel').classList.remove('show')}
let lastTyp=0;
function handleKey(e){if(e.key==='Enter'){sendMsg();return}if(peerId&&ws&&Date.now()-lastTyp>1000){ws.send(JSON.stringify({type:'typing',target:peerId}));lastTyp=Date.now()}}

// ===== INIT =====
window.addEventListener('load',()=>{
  setTimeout(()=>document.getElementById('splash').classList.add('hidden'),2000);
  initEmoji();
  // Check saved login
  const saved=localStorage.getItem('korpu_creds');
  if(saved){const c=JSON.parse(saved);document.getElementById('savedLogin').style.display='';document.getElementById('savedUser').textContent=c.login}
  document.addEventListener('click',e=>{if(!e.target.closest('.emoji-panel')&&!e.target.closest('.ib'))document.getElementById('emojiPanel').classList.remove('show')});
});
</script>
</body>
</html>
