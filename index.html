<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KÖRPÜ — Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .splash {
      position: fixed; inset: 0; z-index: 999;
      background: #0c1a2e;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }
    .splash.hidden { opacity: 0; visibility: hidden; }
    .splash img { width: 180px; height: 180px; object-fit: contain; animation: splashPulse 1.5s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(0,229,160,0.3)); }
    .splash-text { margin-top: 20px; font-family: 'Space Mono', monospace; font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(255,255,255,0.3); animation: splashFade 1.5s ease-in-out infinite alternate; }
    @keyframes splashPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes splashFade { 0% { opacity: 0.3; } 100% { opacity: 0.7; } }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-deep: #0a0a0f; --glass: rgba(255,255,255,0.06); --glass-border: rgba(255,255,255,0.08);
      --accent: #00e5a0; --accent-glow: rgba(0,229,160,0.3); --accent-dim: rgba(0,229,160,0.1);
      --danger: #ff4d6a; --text: #e8e8ec; --text-dim: rgba(255,255,255,0.4); --text-mid: rgba(255,255,255,0.65);
    }
    html { font-size: 16px; }
    body { font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: var(--text); min-height: 100vh; overflow: hidden; position: relative; }
    body::before { content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(ellipse at 20% 50%, rgba(0,229,160,0.06) 0%, transparent 50%), radial-gradient(ellipse at 80% 20%, rgba(100,60,255,0.05) 0%, transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(0,150,255,0.04) 0%, transparent 50%); animation: bgShift 20s ease-in-out infinite alternate; z-index: 0; }
    @keyframes bgShift { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(-5%,3%) rotate(3deg); } }
    body::after { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px); background-size: 60px 60px; z-index: 0; }

    .app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; max-width: 520px; margin: 0 auto; padding: 16px; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; margin-bottom: 12px; }
    .logo { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); text-shadow: 0 0 20px var(--accent-glow); }
    #statusBadge { font-size: 0.7rem; padding: 4px 12px; border-radius: 100px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-dim); font-family: 'Space Mono', monospace; letter-spacing: 1px; transition: all 0.5s ease; }
    #statusBadge.online { background: var(--accent-dim); border-color: rgba(0,229,160,0.3); color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
    #statusBadge.connected { background: rgba(100,60,255,0.1); border-color: rgba(100,60,255,0.3); color: #a78bfa; box-shadow: 0 0 15px rgba(100,60,255,0.2); }

    .card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); margin-bottom: 12px; animation: fadeUp 0.6s ease both; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .card-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 12px; font-family: 'Space Mono', monospace; }
    .input-row { display: flex; gap: 8px; }
    input[type="text"] { flex: 1; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 16px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 0.9rem; outline: none; transition: all 0.3s ease; }
    input[type="text"]:focus { border-color: rgba(0,229,160,0.4); box-shadow: 0 0 0 3px rgba(0,229,160,0.08); background: rgba(255,255,255,0.06); }
    input[type="text"]::placeholder { color: var(--text-dim); }

    .btn { padding: 12px 20px; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.25s ease; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: var(--accent); color: #0a0a0f; box-shadow: 0 4px 20px var(--accent-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 30px rgba(0,229,160,0.4); }
    .btn-ghost { background: rgba(255,255,255,0.06); color: var(--text-mid); border: 1px solid var(--glass-border); }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); color: var(--text); }

    .messages-area { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .messages-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    #messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 6px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 14px; backdrop-filter: blur(10px); scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent; }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .msg { max-width: 82%; padding: 10px 14px; border-radius: 14px; font-size: 0.88rem; line-height: 1.45; animation: msgIn 0.3s ease both; word-break: break-word; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(6px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
    .msg.sent { align-self: flex-end; background: linear-gradient(135deg, rgba(0,229,160,0.2), rgba(0,229,160,0.08)); border: 1px solid rgba(0,229,160,0.15); color: var(--text); }
    .msg.received { align-self: flex-start; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.06); color: var(--text); }
    .msg.system { align-self: center; background: none; border: none; color: var(--text-dim); font-size: 0.72rem; font-family: 'Space Mono', monospace; letter-spacing: 0.5px; padding: 6px 0; }
    .msg-time { font-size: 0.6rem; color: var(--text-dim); margin-top: 3px; font-family: 'Space Mono', monospace; }

    .input-bar { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
    .btn-send { width: 44px; height: 44px; padding: 0; border-radius: 50%; background: var(--accent); color: #0a0a0f; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.25s ease; box-shadow: 0 4px 15px var(--accent-glow); }
    .btn-send:hover { transform: scale(1.06); box-shadow: 0 6px 25px rgba(0,229,160,0.45); }

    #typingIndicator { font-size: 0.7rem; color: var(--accent); font-family: 'Space Mono', monospace; height: 18px; padding: 2px 0; opacity: 0; transition: opacity 0.3s ease; }
    #typingIndicator.visible { opacity: 1; }

    svg { display: block; }
    @media (max-width: 540px) { .app { padding: 10px; } .card { padding: 14px; } }
  </style>
</head>
<body>

<div class="splash" id="splash">
  <img src="logo.png" alt="KÖRPÜ">
  <div class="splash-text">Загрузка...</div>
</div>

<div class="app">
  <div class="header">
    <div class="logo">KÖRPÜ</div>
    <div id="statusBadge">ОФЛАЙН</div>
  </div>

  <div class="card" id="registerCard">
    <div class="card-label">Ваш идентификатор</div>
    <div class="input-row">
      <input type="text" id="myId" placeholder="Введите ваш ID...">
      <button class="btn btn-primary" onclick="register()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Войти
      </button>
    </div>
  </div>

  <div class="card" id="connectCard" style="display:none;">
    <div class="card-label">Подключение к собеседнику</div>
    <div class="input-row">
      <input type="text" id="peerId" placeholder="ID собеседника...">
      <button class="btn btn-ghost" onclick="connectToPeer()">Подключиться</button>
    </div>
  </div>

  <div class="messages-area">
    <div class="messages-header">
      <div class="card-label" style="margin:0;">Сообщения</div>
    </div>
    <div id="messages">
      <div class="msg system">Зарегистрируйтесь, чтобы начать</div>
    </div>
    <div id="typingIndicator"></div>
  </div>

  <div class="input-bar">
    <input type="text" id="msgInput" placeholder="Напишите сообщение..." onkeydown="handleKeydown(event)">
    <button class="btn btn-send" onclick="sendMsg()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<script>
  const WS_URL = 'wss://korpu-server.onrender.com';
  let ws = null, myId = null, peerId = null, connected = false, typingTimeout = null;

  function setStatus(text, cls) {
    const b = document.getElementById('statusBadge');
    b.textContent = text;
    b.className = cls || '';
  }

  function addMsg(text, type) {
    const el = document.getElementById('messages');
    const d = document.createElement('div');
    d.className = 'msg ' + type;
    if (type === 'system') {
      d.textContent = text;
    } else {
      const now = new Date();
      const t = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
      d.innerHTML = text + '<div class="msg-time">' + t + '</div>';
    }
    el.appendChild(d);
    el.scrollTop = el.scrollHeight;
  }

  function showTyping(from) {
    const el = document.getElementById('typingIndicator');
    el.textContent = from + ' печатает...';
    el.classList.add('visible');
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => el.classList.remove('visible'), 2000);
  }

  function register() {
    const id = document.getElementById('myId').value.trim();
    if (!id) return;
    myId = id;
    addMsg('Подключение к серверу...', 'system');

    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: 'register', id: myId }));
    };

    ws.onmessage = (e) => {
      try { handleMessage(JSON.parse(e.data)); } catch(err) { console.error(err); }
    };

    ws.onclose = () => {
      addMsg('Отключено. Переподключение...', 'system');
      setStatus('ОФЛАЙН', '');
      connected = false;
      setTimeout(() => { if (myId) register(); }, 3000);
    };

    ws.onerror = () => {
      addMsg('Ошибка соединения с сервером', 'system');
    };
  }

  function handleMessage(msg) {
    switch(msg.type) {
      case 'registered':
        setStatus('ОНЛАЙН: ' + msg.id, 'online');
        document.getElementById('connectCard').style.display = '';
        document.getElementById('registerCard').style.opacity = '0.4';
        document.getElementById('registerCard').style.pointerEvents = 'none';
        addMsg('Вы онлайн как «' + msg.id + '»', 'system');
        break;
      case 'connected':
        peerId = msg.peer;
        connected = true;
        setStatus('СВЯЗЬ: ' + peerId, 'connected');
        addMsg('Подключено к «' + peerId + '»', 'system');
        break;
      case 'message':
        addMsg(msg.text, 'received');
        break;
      case 'typing':
        showTyping(msg.from);
        break;
      case 'user_offline':
        if (msg.id === peerId) {
          addMsg('«' + peerId + '» вышел из сети', 'system');
          connected = false;
          peerId = null;
          setStatus('ОНЛАЙН: ' + myId, 'online');
        }
        break;
      case 'error':
        addMsg(msg.text, 'system');
        break;
    }
  }

  function connectToPeer() {
    const targetId = document.getElementById('peerId').value.trim();
    if (!targetId || !ws) return;
    addMsg('Подключение к «' + targetId + '»...', 'system');
    ws.send(JSON.stringify({ type: 'connect', target: targetId }));
  }

  function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !ws || !peerId) return;
    ws.send(JSON.stringify({ type: 'message', target: peerId, text: text }));
    addMsg(text, 'sent');
    input.value = '';
  }

  let lastTypingSent = 0;
  function handleKeydown(e) {
    if (e.key === 'Enter') { sendMsg(); return; }
    if (peerId && ws && Date.now() - lastTypingSent > 1000) {
      ws.send(JSON.stringify({ type: 'typing', target: peerId }));
      lastTypingSent = Date.now();
    }
  }

  window.addEventListener('load', () => {
    setTimeout(() => document.getElementById('splash').classList.add('hidden'), 2000);
  });
</script>
</body>
</html>
